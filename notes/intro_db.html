<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-12-30 Sat 13:27 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Intro to DB</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Lei Zhao" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link type="text/css" href="../styles/syntax-highlight.css" rel="stylesheet"/>
<link type="text/css" href="../styles/layout.css" rel="stylesheet"/>
<script type="text/javascript" src="../src/post.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Intro to DB</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8c79b2c">1. <span class="done DONE">DONE</span> SQL mini-course</a>
<ul>
<li><a href="#org0e43f74">1.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#orge943edc">1.1.1. <span class="done DONE">DONE</span> The Join family of Operators</a></li>
<li><a href="#org3807e45">1.1.2. <span class="done DONE">DONE</span> Aggregation</a></li>
<li><a href="#org600f489">1.1.3. <span class="done DONE">DONE</span> NULL values</a></li>
<li><a href="#org8810971">1.1.4. <span class="done DONE">DONE</span> Data Modification Statements</a></li>
</ul>
</li>
<li><a href="#org7367eec">1.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org118cdc7">1.2.1. <span class="done DONE">DONE</span> Movie-Rating Query Core</a></li>
<li><a href="#org7487674">1.2.2. <span class="done DONE">DONE</span> Movie-Rating Query Extras</a></li>
<li><a href="#org491d58a">1.2.3. <span class="done DONE">DONE</span> Social-Network Query Core</a></li>
<li><a href="#orga53ffa6">1.2.4. <span class="done DONE">DONE</span> Social-Network Query Extras</a></li>
<li><a href="#orge362ea6">1.2.5. <span class="done DONE">DONE</span> Movie-Rating Modification</a></li>
<li><a href="#org3fbf1c4">1.2.6. <span class="done DONE">DONE</span> Social-Network Modification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xpath-and-xquery-mini-course">2. <span class="done DONE">DONE</span> XPath and XQuery mini-course</a>
<ul>
<li><a href="#org02ae7de">2.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#xpath-introduction">2.1.1. <span class="done DONE">DONE</span> XPath Introduction</a></li>
<li><a href="#xpath-demo">2.1.2. <span class="done DONE">DONE</span> XPath Demo</a></li>
<li><a href="#xquery-introduction">2.1.3. <span class="done DONE">DONE</span> XQuery Introduction</a></li>
<li><a href="#xquery-demo">2.1.4. <span class="done DONE">DONE</span> XQuery Demo</a></li>
</ul>
</li>
<li><a href="#org4404092">2.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#course-catalog-xpath-and-xquery">2.2.1. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery</a></li>
<li><a href="#course-catalog-xpath-and-xquery-extras">2.2.2. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Extras</a></li>
<li><a href="#world-countries-xpath-and-xquery">2.2.3. <span class="done DONE">DONE</span> World-Countries XPath and XQuery</a></li>
<li><a href="#world-countries-xpath-and-xquery-extras">2.2.4. <span class="done DONE">DONE</span> World-Countries XPath and XQuery Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xslt-mini-course">3. <span class="done DONE">DONE</span> XSLT mini-course</a>
<ul>
<li><a href="#xslt-mini-course-lectures">3.1. <span class="done DONE">DONE</span> Lecture videos</a></li>
<li><a href="#orgac180f8">3.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#course-catalog-xslt">3.2.1. <span class="done DONE">DONE</span> Course-Catalog XSLT</a></li>
<li><a href="#course-catalog-xslt-extras">3.2.2. <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</a></li>
<li><a href="#world-countries-xslt">3.2.3. <span class="done DONE">DONE</span> World-Countries XSLT</a></li>
<li><a href="#world-countries-xslt-extras">3.2.4. <span class="done DONE">DONE</span> World-Countries XSLT Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#relational-design-theory-mini-course">4. <span class="done DONE">DONE</span> Relational Design Theory mini-course</a>
<ul>
<li><a href="#relational-design-theory-mini-course-lectures">4.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#org03eb097">4.1.1. <span class="done DONE">DONE</span> Overview</a></li>
<li><a href="#functional-dependencies">4.1.2. <span class="done DONE">DONE</span> Functional Dependencies</a></li>
<li><a href="#boyce-codd-normal-form">4.1.3. <span class="done DONE">DONE</span> Boyce-Codd Normal Form</a></li>
<li><a href="#multivalued-dependencies-and-4th-normal-form">4.1.4. <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</a></li>
<li><a href="#org8daf5d8">4.1.5. <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</a></li>
</ul>
</li>
<li><a href="#relational-design-theory-mini-course-exercises">4.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#uml-mini-course">5. <span class="done DONE">DONE</span> Unified Modeling Language mini-course</a>
<ul>
<li><a href="#orge65f214">5.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#uml-data-modeling">5.1.1. <span class="done DONE">DONE</span> UML Data Modeling</a></li>
<li><a href="#uml-to-relations">5.1.2. <span class="done DONE">DONE</span> UML to Relations</a></li>
</ul>
</li>
<li><a href="#org831a8a9">5.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#indexes-and-transactions-mini-course">6. <span class="done DONE">DONE</span> Indexes and Transactions mini-course</a>
<ul>
<li><a href="#orgef191f5">6.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#indexes">6.1.1. <span class="done DONE">DONE</span> Indexes</a></li>
<li><a href="#introduction-to-transactions">6.1.2. <span class="done DONE">DONE</span> Introduction to Transactions</a></li>
<li><a href="#transaction-properties">6.1.3. <span class="done DONE">DONE</span> Transaction Properties</a></li>
<li><a href="#isolation-levels">6.1.4. <span class="done DONE">DONE</span> Isolation Levels</a></li>
</ul>
</li>
<li><a href="#orgd4c93b2">6.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org375fe21">6.2.1. <span class="done DONE">DONE</span> Index Quiz</a></li>
<li><a href="#orgf9a7a7b">6.2.2. <span class="done DONE">DONE</span> Transaction Quiz</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#constraints-and-triggers-mini-course">7. <span class="done DONE">DONE</span> Constraints and Triggers mini-course</a>
<ul>
<li><a href="#constraints-and-triggers-mini-course-lectures">7.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#org8998615">7.1.1. <span class="done DONE">DONE</span> Motivation and Overview</a></li>
<li><a href="#constraints-of-several-types">7.1.2. <span class="done DONE">DONE</span> Constraints of Several Types</a></li>
<li><a href="#referential-integrity">7.1.3. <span class="done DONE">DONE</span> Referential Integrity</a></li>
<li><a href="#triggers-introduction">7.1.4. <span class="done DONE">DONE</span> Triggers Introduction</a></li>
<li><a href="#triggers-demo">7.1.5. <span class="done DONE">DONE</span> Triggers Demo</a></li>
</ul>
</li>
<li><a href="#org7441f29">7.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org491ee8b">7.2.1. <span class="done DONE">DONE</span> Constraints and Triggers</a></li>
<li><a href="#org213dd1d">7.2.2. <span class="done DONE">DONE</span> SQL Social-Network Triggers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#views-and-authorization-mini-course">8. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Views and Authorization mini-course</a>
<ul>
<li><a href="#views-and-authorization-mini-course-lectures">8.1. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Lecture Videos</a>
<ul>
<li><a href="#defining-and-using-views">8.1.1. <span class="done DONE">DONE</span> Defining and Using Views</a></li>
<li><a href="#views-modifications-introduction">8.1.2. <span class="done DONE">DONE</span> View Modifications - Introduction</a></li>
<li><a href="#views-modifications-using-triggers">8.1.3. <span class="done DONE">DONE</span> View Modifications Using Triggers</a></li>
<li><a href="#automatic-view-modifications">8.1.4. <span class="done DONE">DONE</span> Automatic View Modifications</a></li>
<li><a href="#materialized-views">8.1.5. <span class="done DONE">DONE</span> Materialized Views</a></li>
<li><a href="#authorization">8.1.6. <span class="done DONE">DONE</span> Authorization</a></li>
</ul>
</li>
<li><a href="#views-and-authorization-mini-course-exercises">8.2. <span class="todo TODO">TODO</span> Exercises</a>
<ul>
<li><a href="#views-quiz">8.2.1. <span class="todo TODO">TODO</span> Views Quiz</a></li>
<li><a href="#authorization-quiz">8.2.2. <span class="todo TODO">TODO</span> Authorization Quiz</a></li>
<li><a href="#sql-movie-rating-view-modification">8.2.3. <span class="todo TODO">TODO</span> SQL Movie-Rating View Modification</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<a href="https://lagunita.stanford.edu/courses/DB/2014/SelfPaced/about">Database</a> on Lagunita
</p>

<div id="outline-container-org8c79b2c" class="outline-2">
<h2 id="org8c79b2c"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/">SQL</a> mini-course</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org0e43f74" class="outline-3">
<h3 id="org0e43f74"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orge943edc" class="outline-4">
<h4 id="orge943edc"><span class="section-number-4">1.1.1</span> <span class="done DONE">DONE</span> The Join family of Operators</h4>
<div class="outline-text-4" id="text-1-1-1">
</div>
</div>
<div id="outline-container-org3807e45" class="outline-4">
<h4 id="org3807e45"><span class="section-number-4">1.1.2</span> <span class="done DONE">DONE</span> Aggregation</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student;

<span class="org-keyword">select</span> <span class="org-builtin">min</span>(GPA)
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span>;

<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> College
<span class="org-keyword">where</span> enrollment &gt; 15000;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>)) -
       (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>));

<span class="org-keyword">select</span> cName, <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName;

<span class="org-keyword">select</span> <span class="org-keyword">state</span>, <span class="org-builtin">sum</span>(enrollment)
<span class="org-keyword">from</span> College
<span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">state</span>;

<span class="org-keyword">select</span> cName, major, <span class="org-builtin">max</span>(mx - mn)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> cName, major, <span class="org-builtin">min</span>(GPA) <span class="org-keyword">as</span> mn, <span class="org-builtin">max</span>(GPA) <span class="org-keyword">as</span> mx
      <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> cName, major) <span class="org-keyword">M</span>;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span>
     (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, cName
      <span class="org-keyword">from</span> Apply) <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">left</span> <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
<span class="org-keyword">union</span>
<span class="org-keyword">select</span> sID, sName, 0
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &lt; 5;

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> cName <span class="org-keyword">from</span> Apply) S
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = S.cName) &lt; 5;


<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID) &lt; 5;

<span class="org-keyword">select</span> major
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> major
<span class="org-keyword">having</span> <span class="org-builtin">max</span>(GPA) &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student);
</pre>
</div>
</div>
</div>

<div id="outline-container-org600f489" class="outline-4">
<h4 id="org600f489"><span class="section-number-4">1.1.3</span> <span class="done DONE">DONE</span> NULL values</h4>
<div class="outline-text-4" id="text-1-1-3">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> sID, sName, GPA
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> GPA &gt; 3.5 <span class="org-keyword">or</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">null</span>;

<span class="org-keyword">select</span> sID, sName, GPA, sizeHS
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> sizeHS &lt; 1600 <span class="org-keyword">or</span> sizeHS &gt;= 1600;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
</pre>
</div>
<p>
SQL uses three-valued logic (<a href="https://en.wikipedia.org/wiki/Three-valued_logic">3VL</a>).
</p>
</div>
</div>

<div id="outline-container-org8810971" class="outline-4">
<h4 id="org8810971"><span class="section-number-4">1.1.4</span> <span class="done DONE">DONE</span> Data Modification Statements</h4>
<div class="outline-text-4" id="text-1-1-4">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College
<span class="org-keyword">values</span> (<span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'PA'</span>, 11500);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'EE'</span>, <span class="org-string">'Y'</span>
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName &lt;&gt; <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      decision = <span class="org-string">'N'</span>;

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College
<span class="org-keyword">where</span> cName <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> cName
                    <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'economics'</span>,
    decision = <span class="org-string">'Y'</span>
<span class="org-keyword">where</span> cName = <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> GPA &lt; 3.6);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'CSE'</span>
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA)
                           <span class="org-keyword">from</span> Apply <span class="org-keyword">join</span> Student <span class="org-keyword">using</span>(sID)
                           <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA &gt;= <span class="org-keyword">all</span> (<span class="org-keyword">select</span> GPA
                                <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
                                <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">update</span> Student
<span class="org-keyword">set</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA) <span class="org-keyword">from</span> Student),
    sizeHS = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(sizeHS) <span class="org-keyword">from</span> Student);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7367eec" class="outline-3">
<h3 id="org7367eec"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org118cdc7" class="outline-4">
<h4 id="org118cdc7"><span class="section-number-4">1.2.1</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Find the titles of all movies directed by Steven Spielberg.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director = <span class="org-string">'Steven Spielberg'</span>;
</pre>
</div>

<p>
Find all years that have a movie that received a rating of 4 or 5, and
sort them in increasing order.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">year</span>
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> stars &gt;= 4)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">year</span>;
</pre>
</div>

<p>
Find the titles of all movies that have no ratings.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
Some reviewers didn&rsquo;t provide a date with their rating.  Find the
names of all reviewers who have ratings with a NULL value for the
date.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> ratingDate <span class="org-keyword">is</span> <span class="org-keyword">null</span>);
</pre>
</div>

<p>
Write a query to return the ratings data in a more readable format:
reviewer name, movie title, stars, and ratingDate.  Also, sort the
data, first by reviewer name, then by movie title, and lastly by
number of stars.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars, ratingDate
<span class="org-keyword">from</span> Reviewer <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>, title, stars;
</pre>
</div>

<p>
For all cases where the same reviewer rated the same movie twice and
gave it a higher rating the second time, return the reviewer&rsquo;s name
and the title of the movie.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID, mID
      <span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Rating R2 <span class="org-keyword">using</span>(rID, mID)
      <span class="org-keyword">where</span> R1.stars &gt; R2.stars <span class="org-keyword">and</span>
            R1.ratingDate &gt; R2.ratingDate <span class="org-keyword">and</span>
            (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Rating
             <span class="org-keyword">where</span> rID = R1.rID <span class="org-keyword">and</span> mID = R1.mID) = 2)
      <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID);
</pre>
</div>

<p>
For each movie that has at least one rating, find the highest number
of stars that movie received.  Return the movie title and number of
stars.  Sort by movie title.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, <span class="org-builtin">max</span>(stars)
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> mID
<span class="org-keyword">order</span> <span class="org-keyword">by</span> title;
</pre>
</div>

<p>
For each movie, return the title and the &rsquo;rating spread&rsquo;, that is, the
difference between highest and lowest ratings given to that movie.
Sort by rating spread from highest to lowest, then by movie title.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, spread
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">max</span>(stars) - <span class="org-builtin">min</span>(stars) <span class="org-keyword">as</span> spread
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> spread <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the difference between the average rating of movies released
before 1980 and the average rating of movies released after 1980.
(Make sure to calculate the average rating for each movie, then the
average of those averages for movies before 1980 and movies after.
Don&rsquo;t just calculate the overall average rating before and after
1980.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span>
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &lt; 1980) -
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &gt;= 1980);
</pre>
</div>
</div>
</div>
<div id="outline-container-org7487674" class="outline-4">
<h4 id="org7487674"><span class="section-number-4">1.2.2</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Find the names of all reviewers who rated Gone with the Wind.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> mID = (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Movie
                           <span class="org-keyword">where</span> title = <span class="org-string">'Gone with the Wind'</span>));
</pre>
</div>

<p>
For any rating where the reviewer is the same as the director of the
movie, return the reviewer name, movie title, and number of stars.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> director = <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Return all reviewer names and movie names together in a single list,
alphabetized.  (Sorting by the first name of the reviewer and first
word in the title is fine; no need for special processing on last
names or removing &ldquo;The&rdquo;.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Reviewer
      <span class="org-keyword">union</span>
      <span class="org-keyword">select</span> title <span class="org-keyword">as</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Movie)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Find the titles of all movies not reviewed by Chris Jackson.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating
                  <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer
                                <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Chris Jackson'</span>));
</pre>
</div>

<p>
For all pairs of reviewers such that both reviewers gave a rating to
the same movie, return the names of both reviewers.  Eliminate
duplicates, don&rsquo;t pair reviewers with themselves, and include each
pair only once.  For each pair, return the names in the pair in
alphabetical order.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R1.<span class="org-keyword">name</span>, R2.<span class="org-keyword">name</span>
<span class="org-keyword">from</span> (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R1 <span class="org-keyword">join</span>
     (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R2
<span class="org-keyword">on</span> R1.mID = R2.mID <span class="org-keyword">and</span>
   R1.rID &lt;&gt; R2.rID <span class="org-keyword">and</span>
   R1.<span class="org-keyword">name</span> &lt;= R2.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each rating that is the lowest (fewest stars) currently in the
database, return the reviewer name, movie title, and number of stars.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Reviewer R2 <span class="org-keyword">join</span> Movie <span class="org-keyword">M</span>
<span class="org-keyword">on</span> R1.rID = R2.rID <span class="org-keyword">and</span>
   R1.mID = <span class="org-keyword">m</span>.mID <span class="org-keyword">and</span>
   stars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(stars) <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
List movie titles and average ratings, from highest-rated to
lowest-rated.  If two or more movies have the same average rating,
list them in alphabetical order.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, avgStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> avgStars <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the names of all reviewers who have contributed three or more
ratings.  (As an extra challenge, try writing the query without HAVING
or without COUNT.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
      <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3)
     <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3;

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating R
              <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                            <span class="org-keyword">from</span> Rating S
                            <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                  (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                   stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                  rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                                          <span class="org-keyword">from</span> Rating
                                          <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                                (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                                (mID &lt;&gt; S.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; S.stars))));
</pre>
</div>

<p>
Some directors directed more than one movie.  For all such directors,
return the titles of all movies directed by them, along with the
director name.  Sort by director name, then movie title.  (As an extra
challenge, try writing the query both with and without COUNT.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">group</span> <span class="org-keyword">by</span> director
                   <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;

<span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">where</span> director = R.director <span class="org-keyword">and</span>
                         mID &lt;&gt; R.mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;
</pre>
</div>

<p>
Find the movie(s) with the highest average rating. Return the movie
title(s) and average rating.  (Hint: This query is more difficult to
write in SQLite than other systems; you might think of it as finding
the highest average rating and then choosing the movie(s) with that
average rating.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
Find the movie(s) with the lowest average rating.  Return the movie
title(s) and average rating.  (Hint: This query may be more difficult
to write in SQLite than other systems; you might think of it as
finding the lowest average rating and then choosing the movie(s) with
that average rating.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
For each director, return the director&rsquo;s name together with the
title(s) of the movie(s) they directed that received the highest
rating among all of their movies, and the value of that rating.
Ignore movies whose director is NULL.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director, title, maxStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> director,
             (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(stars)
              <span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
              <span class="org-keyword">where</span> director = D.director) <span class="org-keyword">as</span> maxStars
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director <span class="org-keyword">from</span> Movie
            <span class="org-keyword">where</span> director <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>) D)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(director) <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> stars = maxStars;
</pre>
</div>
</div>
</div>

<div id="outline-container-org491d58a" class="outline-4">
<h4 id="org491d58a"><span class="section-number-4">1.2.3</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
Find the names of all students who are friends with someone named
Gabriel.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
             <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = ID <span class="org-keyword">and</span>
                   ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID
                           <span class="org-keyword">from</span> Highschooler
                           <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Gabriel'</span>));
</pre>
</div>

<p>
For every student who likes someone 2 or more grades younger than
themselves, return that student&rsquo;s name and grade, and the name and
grade of the student they like.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) -
      (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2) &gt;= 2;
</pre>
</div>

<p>
For every pair of students who both like each other, return the name
and grade of both students.  Include each pair only once, with the two
names in alphabetical order.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID1 &lt; ID2
<span class="org-keyword">intersect</span>
<span class="org-keyword">select</span> ID2, ID1
<span class="org-keyword">from</span> Likes;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2)
<span class="org-keyword">from</span> Likes R
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1) &lt;
      (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2) <span class="org-keyword">and</span>
      ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes
              <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span> ID2 = R.ID1);
</pre>
</div>

<p>
Find all students who do not appear in the Likes table (as a student
who likes or is liked) and return their names and grades.  Sort by
grade, then by name within each grade.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes) <span class="org-keyword">and</span>
      ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Likes)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For every situation where student A likes student B, but we have no
information about whom B likes (that is, B does not appear as an ID1
in the Likes table), return A and B&rsquo;s names and grades.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID2 <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes);
</pre>
</div>

<p>
Find names and grades of students who only have friends in the same
grade. Return the result sorted by grade, then by name within each
grade.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
                 <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) &lt;&gt;
                       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2))
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each student A who likes a student B where the two are not
friends, find if they have a friend C in common (who can introduce
them!).  For all such trios, return the name and grade of A, B, and C.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes
      <span class="org-keyword">except</span>
      <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend) T
     <span class="org-keyword">join</span> Highschooler
<span class="org-keyword">on</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID1) <span class="org-keyword">and</span>
   ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID2);
</pre>
</div>

<p>
Find the difference between the number of students in the school and
the number of different first names.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(ID) - <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> <span class="org-keyword">name</span>)
<span class="org-keyword">from</span> Highschooler;
</pre>
</div>

<p>
Find the name and grade of all students who are liked by more than one
other student.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> name2, grade2
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, name1, grade1, ID2, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name2, grade <span class="org-keyword">as</span> grade2
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name1, grade <span class="org-keyword">as</span> grade1, ID2
            <span class="org-keyword">from</span> Likes <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID1 = H.ID)
                 <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID2 = H.ID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID2
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1;
</pre>
</div>
</div>
</div>

<div id="outline-container-orga53ffa6" class="outline-4">
<h4 id="orga53ffa6"><span class="section-number-4">1.2.4</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
For every situation where student A likes student B, but student B
likes a different student C, return the names and grades of A, B, and
C.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> H1.<span class="org-keyword">name</span>, H1.grade,
       H2.<span class="org-keyword">name</span>, H2.grade,
       H3.<span class="org-keyword">name</span>, H3.grade
<span class="org-keyword">from</span> Likes R <span class="org-keyword">join</span> Likes S
     <span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span>
        S.ID2 &lt;&gt; R.ID1
     <span class="org-keyword">join</span> Highschooler H1
     <span class="org-keyword">on</span> R.ID1 = H1.ID
     <span class="org-keyword">join</span> Highschooler H2
     <span class="org-keyword">on</span> R.ID2 = H2.ID
     <span class="org-keyword">join</span> Highschooler H3
     <span class="org-keyword">on</span> S.ID2 = H3.ID;
</pre>
</div>

<p>
Find those students for whom all of their friends are in different
grades from themselves.  Return the students&rsquo; names and grades.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler R
<span class="org-keyword">where</span> <span class="org-keyword">not</span> <span class="org-keyword">exists</span>
      (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
       <span class="org-keyword">where</span> ID1 = R.ID <span class="org-keyword">and</span>
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler
        <span class="org-keyword">where</span> ID = ID2 <span class="org-keyword">and</span>
              grade = R.grade));
</pre>
</div>

<p>
What is the average number of friends per student? (Your result should
be just one number.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Friend
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1);
</pre>
</div>

<p>
The above code doesn&rsquo;t consider the situation where there exists a
student who has no friend.  The following code handle that situation
correctly.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Friend
              <span class="org-keyword">where</span> ID1 = ID) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Highschooler);
</pre>
</div>

<p>
Find the number of students who are either friends with Cassandra or
are friends of friends of Cassandra.  Do not count Cassandra, even
though technically she is a friend of a friend.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> <span class="org-keyword">name</span> &lt;&gt; <span class="org-string">'Cassandra'</span> <span class="org-keyword">and</span>
      <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend R
              <span class="org-keyword">where</span> R.ID1 = ID <span class="org-keyword">and</span>
                    (R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                               <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>) <span class="org-keyword">or</span>
                     R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Friend
                               <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span>
                                     ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                                             <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>))));

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, ID2, ID3
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> L1.ID1, L1.ID2, L2.ID2 <span class="org-keyword">as</span> ID3
            <span class="org-keyword">from</span> Friend L1 <span class="org-keyword">join</span> Friend L2
            <span class="org-keyword">on</span> L1.ID2 = L2.ID1 <span class="org-keyword">and</span>
               L2.ID2 &lt;&gt; L1.ID1))
     <span class="org-keyword">join</span> Highschooler R <span class="org-keyword">on</span> ID1 = R.ID
     <span class="org-keyword">join</span> Highschooler S <span class="org-keyword">on</span> ID2 = S.ID
     <span class="org-keyword">join</span> Highschooler T <span class="org-keyword">on</span> ID3 = T.ID
<span class="org-keyword">where</span> S.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span> <span class="org-keyword">or</span> T.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>;
</pre>
</div>

<p>
Find the name and grade of the student(s) with the greatest number of
friends.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1)
<span class="org-keyword">from</span> Friend
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(num)
                   <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
                         <span class="org-keyword">from</span> Friend
                         <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1));
</pre>
</div>
</div>
</div>

<div id="outline-container-orge362ea6" class="outline-4">
<h4 id="orge362ea6"><span class="section-number-4">1.2.5</span> <span class="done DONE">DONE</span> Movie-Rating <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-5">
<p>
Add the reviewer Roger Ebert to your database, with an rID of 209.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Reviewer <span class="org-keyword">values</span> (209, <span class="org-string">'Roger Ebert'</span>);
</pre>
</div>

<p>
Insert 5-star ratings by James Cameron for all movies in the database.
Leave the review date as NULL.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Rating
<span class="org-keyword">select</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'James Cameron'</span>),
       mID, 5, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Movie;
</pre>
</div>

<p>
For all movies that have an average rating of 4 stars or higher, add
25 to the release year.  (Update the existing tuples; don&rsquo;t insert new
tuples.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Movie
<span class="org-keyword">set</span> <span class="org-keyword">year</span> = <span class="org-keyword">year</span> + 25
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = Movie.mID) &gt;= 4;
</pre>
</div>

<p>
Remove all ratings where the movie&rsquo;s year is before 1970 or after
2000, and the rating is fewer than 4 stars.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Rating
<span class="org-keyword">where</span> stars &lt; 4 <span class="org-keyword">and</span>
      ((<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &lt; 1970 <span class="org-keyword">or</span>
       (<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &gt; 2000)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fbf1c4" class="outline-4">
<h4 id="org3fbf1c4"><span class="section-number-4">1.2.6</span> <span class="done DONE">DONE</span> Social-Network <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-6">
<p>
It&rsquo;s time for the seniors to graduate.  Remove all 12th graders from
Highschooler.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> grade = 12;
</pre>
</div>

<p>
If two students A and B are friends, and A likes B but not vice-versa,
remove the Likes tuple.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> *
              <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                    <span class="org-keyword">except</span>
                    <span class="org-keyword">select</span> ID2, ID1 <span class="org-keyword">from</span> Likes
                    <span class="org-keyword">intersect</span>
                    <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes)
              <span class="org-keyword">where</span> ID1 = Likes.ID1 <span class="org-keyword">and</span> ID2 = Likes.ID2);
</pre>
</div>

<p>
For all cases where A is friends with B, and B is friends with C, add
a new friendship for the pair A and C.  Do not add duplicate
friendships, friendships that already exist, or friendships with
oneself.  (This one is a bit challenging; congratulations if you get
it right.)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Friend
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R.ID1, S.ID2
<span class="org-keyword">from</span> Friend R <span class="org-keyword">join</span> Friend S
<span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span> S.ID2 &lt;&gt; R.ID1 <span class="org-keyword">and</span>
   <span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = R.ID1 <span class="org-keyword">and</span>
                   ID2 = S.ID2);
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd0dfd36" class="outline-2">
<h2 id="xpath-and-xquery-mini-course"><a id="orgd0dfd36"></a><span class="section-number-2">2</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XPath/SelfPaced/courseware/ch-querying_xml/">XPath and XQuery</a> mini-course</h2>
<div class="outline-text-2" id="text-xpath-and-xquery-mini-course">
</div>
<div id="outline-container-org02ae7de" class="outline-3">
<h3 id="org02ae7de"><span class="section-number-3">2.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orgef39e81" class="outline-4">
<h4 id="xpath-introduction"><a id="orgef39e81"></a><span class="section-number-4">2.1.1</span> <span class="done DONE">DONE</span> XPath Introduction</h4>
<div class="outline-text-4" id="text-xpath-introduction">
<p>
Not nearly as mature as Querying Relational
</p>
<ul class="org-ul">
<li>XPath - path expressions + conditions</li>
<li>XSLT - XPath + transformations, output</li>
<li>XQuery - XPath + full-featured Q.L.</li>
</ul>

<p>
Think of XML as a tree
</p>

<p>
Basic Constructs
</p>
<pre class="example">
/ root element and separator
{element name} or *
@{attribute name}
// any descendants including self
[condition] e.g. [@price &lt; 50]
[number] nth sub-element
</pre>

<p>
Built-in functions (lots of them)
</p>
<pre class="example">
contains(s1, s2)
name()
</pre>

<p>
Navigation &ldquo;axes&rdquo; (13 of them)
</p>
<pre class="example">
parent::
following-sibling::
descendants:: (does not match self, cf. //)
self::
</pre>

<p>
XPath queries operate on and return <i>sequence</i> of elements
Sometimes result can be expressed as XML, but not always
</p>
</div>
</div>

<div id="outline-container-orgb8f8141" class="outline-4">
<h4 id="xpath-demo"><a id="orgb8f8141"></a><span class="section-number-4">2.1.2</span> <span class="done DONE">DONE</span> XPath Demo</h4>
<div class="outline-text-4" id="text-xpath-demo">
<p>
Get the titles of books in the bookstore where the price is lower
than 90 and Jeffrey Widom is an author.
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[@Price &lt; 90 and
        Authors/Author[Last_name = "Widom" and
        First_Name="Jeffrey"]]/Title
</pre>

<p>
Get the titles of books where &ldquo;Ullman&rdquo; is an author and &ldquo;Widom&rdquo; is not
an author.  <b>The below code doesn&rsquo;t work since there is no way using
XPath language alone to achieve the query.</b>
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman" and
        Authors/Author/Last_Name != "Widom"]/Title
</pre>

<p>
Get all magazines where there&rsquo;s a book with the same title.  (An
example of <i>self-join</i> in XPath)
</p>

<pre class="example">
doc("BookstoreQ.xml")//Magazine[
        Title = doc("BookstoreQ.xml")//Book/Title]
</pre>

<p>
The equal sign in the above code is implicitly existentially
quantified.  There is a lot of implicit existential quantification in
XPath and XQuery.
</p>

<p>
All Elements whose parent is not &ldquo;Bookstore&rdquo; or &ldquo;Book&rdquo;.
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore//*[
        name(parent::*) != "Bookstore"
        and name(parent::*) != "Book"]
</pre>

<p>
The above code use the navigation access <code>parent::</code>.
</p>

<p>
All books and magazines with non-unique titles.
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/(Book|Magazine)[
        Title = following-sibling::*/Title
        or Title = preceding-sibling::*/Title]
</pre>

<p>
Books where every author&rsquo;s first name includes &ldquo;J&rdquo;.  This query will
need universal quantification.
</p>

<pre class="example">
doc("BookstoreQ.xml")//Book[
        count(Authors/Author[contains(First_Name, "J")]) =
        count(Authors/Author/First_Name)]
</pre>

<p>
The built-in function <code>count</code> is used to simulate universal
quantification.  This technique can solve previously undoable query.
</p>

<p>
Titles of books where &ldquo;Ullman&rdquo; is an author and &ldquo;Widom&rdquo; is not
an author.
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman"
        and count(Authors/Author[Last_Name = "Widom"]) = 0]/Title
</pre>
</div>
</div>

<div id="outline-container-org2dd53e1" class="outline-4">
<h4 id="xquery-introduction"><a id="org2dd53e1"></a><span class="section-number-4">2.1.3</span> <span class="done DONE">DONE</span> XQuery Introduction</h4>
<div class="outline-text-4" id="text-xquery-introduction">
<ol class="org-ol">
<li>XQuery is a expression language (compositional)</li>
<li>Each expression operates on and returns sequence of elements</li>
<li>XPath is one type of expression</li>
</ol>

<p>
XQuery: FLWOR expression
</p>

<pre class="example">
For $var in expr
Let $var := expr
Where condition
Order By expr
Return expr
</pre>

<p>
Mixing queries and XML
</p>

<pre class="example">
&lt;Result&gt; { ...query goes here... } &lt;/Result&gt;
</pre>
</div>
</div>

<div id="outline-container-org790a54f" class="outline-4">
<h4 id="xquery-demo"><a id="org790a54f"></a><span class="section-number-4">2.1.4</span> <span class="done DONE">DONE</span> XQuery Demo</h4>
<div class="outline-text-4" id="text-xquery-demo">
<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; 90
  and $b/Authors/Author/Last_Name = "Ullman"
return $b/Title
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { $b/Authors/Author/First_Name }
       &lt;/Book&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { for $fn in $b/Authors/Authors/Author/First_Name
           where contains($b/Title, $fn) return $fn }
       &lt;/Book&gt;
</pre>

<pre class="example">
&lt;Average&gt;
  { let $plist := doc("BookstoreQ.xml")/Bookstore/Book/@Price
    return avg($plist) }
&lt;/Average&gt;
</pre>

<pre class="example">
let $a := avg(doc("BookstoreQ.xml")/Bookstore/Book/@Price)
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; $a
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
order by xs:int($b/@Price)
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>

<pre class="example">
for $n in distinct-values(doc("BookstoreQ.xml")//Last_Name)
return &lt;Last_Name&gt; { $n } &lt;/Last_Name&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where every $fn in $b/Authors/Author/First_Name
        satisfies contains($fn, "J")
return $b
</pre>

<pre class="example">
for $b1 in doc("BookstoreQ.xml")/Bookstore/Book
for $b2 in doc("BookstoreQ.xml")/Bookstore/Book
where $b1/Authors/Author/Last_Name = $b2/Authors/Author/Last_Name
      and $b1/Title &lt; $b2/Title
return
    &lt;BookPair&gt;
        &lt;Title1&gt; { data($b1/Title) } &lt;/Title1&gt;
        &lt;Title2&gt; { data($b2/Title) } &lt;/Title2&gt;
    &lt;/BookPair&gt;
</pre>

<p>
Again, implicitly existential quantification.
</p>

<pre class="example">
&lt;InvertedBookstore&gt;
    { for $ln in distinct-values(doc("BookstoreQ.xml")//Author/Last_Name)
      for $fn in distinct-values(doc("BookstoreQ.xml")//Author[
                                      Last_name=$ln]/First_Name)
      return
          &lt;Author&gt;
              &lt;First_Name&gt; { $fn } &lt;/First_name&gt;
              &lt;Last_Name { $ln } &lt;/Last_Name&gt;
              { for $b in doc("BookstoreQ.xml")/Bookstore/Book[
                               Authors/Atuhor/Last_Name=$ln]
                return &lt;Book&gt;
                          { $b/@ISBN } { $b/@Price } { $/@Edition }
                          { $b/Title } { $b/Remark }
                       &lt;/Book&gt;
          &lt;/Author&gt; }
&lt;/InvertedBookstore&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4404092" class="outline-3">
<h3 id="org4404092"><span class="section-number-3">2.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org8cd3c52" class="outline-4">
<h4 id="course-catalog-xpath-and-xquery"><a id="org8cd3c52"></a><span class="section-number-4">2.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery</h4>
<div class="outline-text-4" id="text-course-catalog-xpath-and-xquery">
<p>
Return all Title elements (of both departments and courses).
</p>

<pre class="example">
doc("courses.xml")//Title
</pre>

<p>
Return last names of all department chairs.
</p>

<pre class="example">
doc("courses.xml")//Department/Chair//Last_Name
</pre>

<p>
Return titles of courses with enrollment greater than 500.
</p>

<pre class="example">
doc("courses.xml")//Course[@Enrollment &gt; 500]/Title
</pre>

<p>
Return titles of departments that have some course that takes &ldquo;CS106B&rdquo;
as a prerequisite.
</p>

<pre class="example">
doc("courses.xml")//Department[Course/Prerequisites[Prereq = "CS106B"]]/Title
</pre>

<p>
Return last names of all professors or lecturers who use a middle
initial.  Don&rsquo;t worry about eliminating duplicates.
</p>

<pre class="example">
doc("courses.xml")//(Lecturer|Professor)[Middle_Initial]/Last_Name
</pre>

<p>
Return the count of courses that have a cross-listed course (i.e.,
that have &ldquo;Cross-listed&rdquo; in their description).
</p>

<pre class="example">
count(doc("courses.xml")//Course[contains(Description, "Cross-listed")])
</pre>

<p>
Return the average enrollment of all courses in the CS department.
</p>

<pre class="example">
avg(doc("courses.xml")//Department[@Code="CS"]/Course/@Enrollment)
</pre>

<p>
Return last names of instructors teaching at least one course that has
&ldquo;system&rdquo; in its description and enrollment greater than 100.
</p>

<pre class="example">
doc("courses.xml")//Course[@Enrollment &gt; 100 and contains(Description, "system")]/Instructors//Last_Name
</pre>

<p>
Return the title of the course with the largest enrollment.
</p>

<pre class="example">
for $c in doc("courses.xml")//Course
where every $e in doc("courses.xml")//Course/@Enrollment
        satisfies xs:int($e) &lt;= xs:int($c/@Enrollment)
return $c/Title
</pre>

<p>
Only one of the function call <code>xs:int</code> shown above is necessary since
the other operand will go through type promotion.
</p>
</div>
</div>

<div id="outline-container-org2d9d057" class="outline-4">
<h4 id="course-catalog-xpath-and-xquery-extras"><a id="org2d9d057"></a><span class="section-number-4">2.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Extras</h4>
<div class="outline-text-4" id="text-course-catalog-xpath-and-xquery-extras">
<p>
Return the course number of the course that is cross-listed as &ldquo;LING180&rdquo;.
</p>

<pre class="example">
data(doc("courses.xml")//Course[contains(Description, "Cross-listed as LING180")]/@Number)
</pre>

<p>
Return course numbers of courses that have the same title as some
other course.  (Hint: You might want to use the &ldquo;preceding&rdquo; and
&ldquo;following&rdquo; navigation axes for this query, which were not covered in
the video or our demo script; they match any preceding or following
node, not just siblings.)
</p>

<pre class="example">
for $c1 in doc("courses.xml")//Course
where some $c2 in doc("courses.xml")//Course
      satisfies $c1 != $c2
                and $c1/Title = $c2/Title
return data($c1/@Number)
</pre>

<p>
Return course numbers of courses taught by an instructor with first
name &ldquo;Daphne&rdquo; or &ldquo;Julie&rdquo;.
</p>

<pre class="example">
data(doc("courses.xml")//Course[Instructors//First_Name = ("Daphne", "Julie")]/@Number)
</pre>

<p>
Return the number (count) of courses that have no lecturers as
instructors.
</p>

<pre class="example">
count(doc("courses.xml")//Course[not(Instructors[Lecturer])])
</pre>

<p>
Return titles of courses taught by the chair of a department.  For
this question, you may assume that all professors have distinct last
names.
</p>

<pre class="example">
doc("courses.xml")//Course[
    Instructors/Professor/Last_Name =
        doc("courses.xml")//Department/Chair/Professor/Last_Name
]/Title
</pre>

<pre class="example">
for $c in doc("courses.xml")//Course
where $c/Instructors/(Professor|Lecturer)/Last_Name
          = doc("courses.xml")//Department/Chair/(Professor|Lecturer)/Last_Name
return $c/Title
</pre>

<pre class="example">
for $c in doc("courses.xml")//Course
where some $t1 in $c/Instructors/(Professor|Lecturer)
      satisfies some $t2 in
                doc("courses.xml")//Department/Chair/(Professor|Lecturer)
                satisfies deep-equal($t1/*, $t2/*)
return $c/Title
</pre>

<p>
Return titles of courses that have both a lecturer and a professor as
instructors.  Return each title only once.
</p>

<pre class="example">
doc("courses.xml")//Course[Instructors/Lecturer and Instructors/Professor]/Title
</pre>

<p>
Return titles of courses taught by a professor with the last name &ldquo;Ng&rdquo;
but not by a professor with the last name &ldquo;Thrun&rdquo;.
</p>

<pre class="example">
for $c in doc("courses.xml")//Course[Instructors/Professor/Last_Name = "Ng"]
where every $ln in $c/Instructors/Professor/Last_Name
      satisfies $ln != "Thrun"
return $c/Title
</pre>

<pre class="example">
doc("courses.xml")//Course[Instructors[
        Professor/Last_Name = "Ng" and
        count(Professor[Last_Name = "Thrun"]) = 0]]/Title
</pre>

<p>
Return course numbers of courses that have a course taught by Eric
Roberts as a prerequisite.
</p>

<pre class="example">
for $c in doc("courses.xml")//Course
where some $p in $c/Prerequisites/Prereq
      satisfies $p = data(
          doc("courses.xml")//Course[
              Instructors/(Professor|Lecturer)[
                  First_Name = "Eric" and
                  Last_Name = "Roberts"]]/@Number)
return data($c/@Number)
</pre>

<p>
Create a summary of CS classes: List all CS department courses in
order of enrollment.  For each course include only its Enrollment (as
an attribute) and its Title (as a subelement).
</p>

<pre class="example">
&lt;Summary&gt;
    { for $c in doc("courses.xml")//Department[@Code="CS"]/Course
      order by xs:int($c/@Enrollment)
      return &lt;Course&gt;
                 { $c/@Enrollment }
                 { $c/Title }
             &lt;/Course&gt; }
&lt;/Summary&gt;
</pre>

<p>
Return a &ldquo;Professors&rdquo; element that contains as subelements a listing
of all professors in all departments, sorted by last name with each
professor appearing once.  The &ldquo;Professor&rdquo; subelements should have the
same structure as in the original data.  For this question, you may
assume that all professors have distinct last names.  Watch out &#x2013; the
presence/absence of middle initials may require some special handling.
(This problem is quite challenging; congratulations if you get it
right.)
</p>

<pre class="example">
&lt;Professors&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      order by $ln
      return (doc("courses.xml")//Professor[Last_Name=$ln])[1] }
&lt;/Professors&gt;
</pre>

<p>
Expanding on the previous question, create an inverted course listing:
Return an &ldquo;Inverted_Course_Catalog&rdquo; element that contains as
subelements professors together with the courses they teach, sorted by
last name.  You may still assume that all professors have distinct last
names.  The &ldquo;Professor&rdquo; subelements should have the same structure as
in the original data, with an additional single &ldquo;Courses&rdquo; subelement
under Professor, containing a further &ldquo;Course&rdquo; subelement for each
course number taught by that professor.  Professors who do not teach
any courses should have no Courses subelement at all.  (This problem is
very challenging; extra congratulations if you get it right.)
</p>

<pre class="example">
&lt;Inverted_Course_Catalog&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      let $prof := (doc("courses.xml")//Professor[Last_Name=$ln])[1]
      order by $ln
      return &lt;Professor&gt;
                 { $prof/First_Name } { $prof/Middle_Initial }
                 { $prof/Last_Name }
                 { let $cs :=
                       &lt;Courses&gt;
                           { for $c in doc("courses.xml")//Course[
                                 Instructors/Professor/Last_Name = $ln]
                             return &lt;Course&gt;
                                        { data($c/@Number) }
                                    &lt;/Course&gt; }
                       &lt;/Courses&gt;
                   return $cs[Course] }
             &lt;/Professor&gt;}
&lt;/Inverted_Course_Catalog&gt;
</pre>
</div>
</div>

<div id="outline-container-orgc628356" class="outline-4">
<h4 id="world-countries-xpath-and-xquery"><a id="orgc628356"></a><span class="section-number-4">2.2.3</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery</h4>
<div class="outline-text-4" id="text-world-countries-xpath-and-xquery">
<p>
Return the area of Mongolia.
</p>

<pre class="example">
data(doc("countries.xml")//country[@name="Mongolia"]/@area)
</pre>

<p>
Return the names of all cities that have the same name as the country
in which they are located.
</p>

<pre class="example">
for $c in doc("countries.xml")//country[@name = city/name]
return $c/city[name = $c/@name]/name
</pre>

<pre class="example">
for $c in doc("countries.xml")//country[@name = city/name]
return &lt;name&gt; { data($c/@name) } &lt;/name&gt;
</pre>

<p>
Return the average population of Russian-speaking countries.
</p>

<pre class="example">
avg(data(doc("countries.xml")//country[language = "Russian"]/@population))
</pre>

<p>
Return the names of all countries that have at least three cities with
population greater than 3 million.
</p>

<pre class="example">
data(doc("countries.xml")//country[count(city[xs:int(population) &gt; 3000000]) &gt;= 3]/@name)
</pre>

<p>
The function call <code>xs:int</code> in the above code is actually unnecessary
since type promotion would occur due to right-hand operand.
</p>

<p>
Create a list of French-speaking and German-speaking countries.  The
result should take the form:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;result&gt;
  &lt;French&gt;
    { for $cn in data(doc("countries.xml")//country[language = "French"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/French&gt;
  &lt;German&gt;
    { for $cn in data(doc("countries.xml")//country[language = "German"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/German&gt;
&lt;/result&gt;
</pre>

<pre class="example">
&lt;result&gt;
  { let $langs := ("French", "German")
    for $lang in $langs
    return element {$lang}
    { for $cn in data(doc("countries.xml")//country[language=$lang]/@name)
          return &lt;country&gt; { $cn } &lt;/country&gt; } }
&lt;/result&gt;
</pre>

<p>
Return the countries with the highest and lowest population densities.
Note that because the &ldquo;/&rdquo; operator has its own meaning in XPath and
XQuery, the division operator is infix &ldquo;div&rdquo;.  To compute population
density use &ldquo;(@population div @area)&rdquo;.  You can assume density values
are unique.  The result should take the form:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">highest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">highest</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">lowest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">lowest</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;result&gt;
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &gt;= $c2/@population div $c2/@area
    return &lt;highest density="{$density}"&gt; { data($c1/@name) } &lt;/highest&gt; }
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &lt;= $c2/@population div $c2/@area
    return &lt;lowest density="{$density}"&gt; { data($c1/@name) } &lt;/lowest&gt; }
&lt;/result&gt;
</pre>
</div>
</div>

<div id="outline-container-org653a79b" class="outline-4">
<h4 id="world-countries-xpath-and-xquery-extras"><a id="org653a79b"></a><span class="section-number-4">2.2.4</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery Extras</h4>
<div class="outline-text-4" id="text-world-countries-xpath-and-xquery-extras">
<p>
Return the names of all countries with population greater than 100
million.
</p>

<pre class="example">
data(doc("countries.xml")//country[@population &gt; 100000000]/@name)
</pre>

<p>
Return the names of all countries where over 50% of the population
speaks German.  (Hint: Depending on your solution, you may want to use
&ldquo;.&rdquo;, which refers to the &ldquo;current element&rdquo; within an XPath
expression.)
</p>

<pre class="example">
data(doc("countries.xml")//country[language[@percentage &gt; 50.0] = "German"]/@name)
</pre>

<p>
Return the names of all countries where a city in that country
contains more than one-third of the country&rsquo;s population.
</p>

<pre class="example">
for $c in doc("countries.xml")//country
where some $cp in $c/city/population
      satisfies $cp div $c/@population &gt; 1 div 3
return data($c/@name)
</pre>

<p>
Return the population density of Qatar.  Note: Since the &ldquo;/&rdquo; operator
has its own meaning in XPath and XQuery, the division operator is
&ldquo;div&rdquo;.  To compute population density use &ldquo;(@population div @area)&rdquo;.
</p>

<pre class="example">
let $c := doc("countries.xml")//country[@name="Qatar"]
return $c/@population div $c/@area
</pre>

<p>
Return the names of all countries whose population is less than one
thousandth that of some city (in any country).
</p>

<pre class="example">
let $countries := doc("countries.xml")//country
for $c in $countries
where some $city in $countries/city
      satisfies $city/population * 0.001 &gt; $c/@population
return data($c/@name)
</pre>

<p>
Return all city names that appear more than once, i.e., there is more
than one city with that name in the data.  Return only one instance of
each such city name.  (Hint: You might want to use the &ldquo;preceding&rdquo;
and/or &ldquo;following&rdquo; navigation axes for this query, which were not
covered in the video or our demo script; they match any preceding or
following node, not just siblings.)
</p>

<pre class="example">
let $cities := doc("countries.xml")//city
for $city in distinct-values($cities/name)
where count($cities[name = $city]) &gt; 1
return &lt;name&gt;{$city}&lt;/name&gt;
</pre>

<p>
Return the names of all countries containing a city such that some
other country has a city of the same name.  (Hint: You might want to
use the &ldquo;preceding&rdquo; and/or &ldquo;following&rdquo; navigation axes for this query,
which were not covered in the video or our demo script; they match any
preceding or following node, not just siblings.)
</p>

<pre class="example">
let $countries := doc("countries.xml")//country
for $c in $countries
where some $c2 in $countries
      satisfies not($c2 is $c)
                and $c/city/name = $c2/city/name
return data($c/@name)
</pre>

<p>
Return the names of all countries whose name textually contains a
language spoken in that country.  For instance, Uzbek is spoken in
Uzbekistan, so return Uzbekistan.  (Hint: You may want to use &ldquo;.&rdquo;,
which refers to the &ldquo;current element&rdquo; within an XPath expression.)
</p>

<pre class="example">
for $c in doc("countries.xml")//country
where some $lang in $c/language
      satisfies contains($c/@name, $lang)
return data($c/@name)
</pre>

<p>
Return the names of all countries in which people speak a language
whose name textually contains the name of the country.  For instance,
Japanese is spoken in Japan, so return Japan.  (Hint: You may want to
use &ldquo;.&rdquo;, which refers to the &ldquo;current element&rdquo; within an XPath
expression.)
</p>

<pre class="example">
data(doc("countries.xml")//country[language[contains(., ../@name)]]/@name)
</pre>

<p>
Return all languages spoken in a country whose name textually contains
the language name.  For instance, German is spoken in Germany, so
return German.  (Hint: Depending on your solution, may want to use
data(.), which returns the text value of the &ldquo;current element&rdquo; within
an XPath expression.)
</p>

<pre class="example">
data(doc("countries.xml")//country/language[contains(../@name, .)])
</pre>

<p>
Return all languages whose name textually contains the name of a
country in which the language is spoken.  For instance, Icelandic is
spoken in Iceland, so return Icelandic.  (Hint: Depending on your
solution, may want to use data(.), which returns the text value of the
&ldquo;current element&rdquo; within an XPath expression.)
</p>

<pre class="example">
data(doc("countries.xml")//country/language[contains(., ../@name)])
</pre>

<p>
Return the number of countries where Russian is spoken.
</p>

<pre class="example">
count(doc("countries.xml")//country[language = "Russian"])
</pre>

<p>
Return the names of all countries for which the data does not include
any languages or cities, but the country has more than 10 million
people.
</p>

<pre class="example">
data(doc("countries.xml")//country[not(language or city) and @population &gt; 10000000]/@name)
</pre>

<p>
Return the name of the country with the highest population.  (Hint: You
may need to explicitly cast population numbers as integers with
xs:int() to get the correct answer.)
</p>

<pre class="example">
data(doc("countries.xml")//country[
    @population = max(doc("countries.xml")//country/@population)
]/@name)
#+END_EXAMPLE)

Return the name of the country that has the city with the highest
population.  (Hint: You may need to explicitly cast population numbers
as integers with xs:int() to get the correct answer.)

#+BEGIN_EXAMPLE
data(doc("countries.xml")//country[
    city/population = max(doc("countries.xml")//city/population)
]/@name)
</pre>

<p>
Return the average number of languages spoken in countries where
Russian is spoken.
</p>

<pre class="example">
avg(for $c in doc("countries.xml")//country[language = "Russian"]
return count($c/language))
</pre>

<p>
Return all country-language pairs where the language is spoken in the
country and the name of the country textually contains the language
name.  Return each pair as a country element with language attribute,
e.g.,
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">French</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">French Guiana</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
for $c in doc("countries.xml")//country
for $lang in $c/language
where contains($c/@name, $lang)
return &lt;country language="{$lang}"&gt; { data($c/@name) } &lt;/country&gt;
</pre>

<p>
Return all countries that have at least one city with population
greater than 7 million.  For each one, return the country name along
with the cities greater than 7 million, in the format:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">country-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
for $country in doc("countries.xml")//country
let $c := &lt;country&gt;
              { $country/@name }
              { for $city in $country/city
                where $city/population &gt; 7000000
                return &lt;big&gt;{data($city/name)}&lt;/big&gt; }
          &lt;/country&gt;
return $c[big]
</pre>

<p>
Return all countries where at least one language is listed, but the
total percentage for all listed languages is less than 90%.  Return the
country element with its name attribute and its language subelements,
but no other attributes or subelements.
</p>

<pre class="example">
for $country in doc("countries.xml")//country[language]
where sum($country/language/@percentage) &lt; 90
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>

<p>
Return all countries where at least one language is listed, and every
listed language is spoken by less than 20% of the population.  Return
the country element with its name attribute and its language
subelements, but no other attributes or subelements.
</p>

<pre class="example">
for $country in doc("countries.xml")//country[language]
where every $lang in $country/language
      satisfies $lang/@percentage &lt; 20
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>

<p>
Find all situations where one country&rsquo;s most popular language is
another country&rsquo;s least popular, and both countries list more than one
language.  (Hint: You may need to explicitly cast percentages as
floating-point numbers with xs:float() to get the correct answer.)
Return the name of the language and the two countries, each in the
format:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LangPair</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">lang-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LangPair</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
let $countries := doc("countries.xml")//country[count(language) &gt; 1]
for $c in $countries
for $lang in $c/language
where every $lang2 in $c/language
      satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
return (&lt;LangPair language="{$lang}"&gt;
            &lt;MostPopular&gt;{data($c/@name)}&lt;/MostPopular&gt;
            { for $c2 in $countries[language = $lang]
              let $lang3 := $c2/language[. = $lang]
              where every $lang2 in $c2/language
                    satisfies xs:float($lang3/@percentage) &lt;= $lang2/@percentage
              return &lt;LeastPopular&gt; {data($c2/@name)}&lt;/LeastPopular&gt; }
        &lt;/LangPair&gt;)[LeastPopular]
</pre>

<pre class="example">
let $countries :=
    for $c in doc("countries.xml")//country[count(language) &gt; 1]
    let $most_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
        return &lt;MostPopular&gt;{data($lang)}&lt;/MostPopular&gt;
    let $least_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &lt;= $lang2/@percentage
        return &lt;LeastPopular&gt;{data($lang)}&lt;/LeastPopular&gt;
    return &lt;country&gt;
               {$c/@name}
               {$most_lang}
               {$least_lang}
           &lt;/country&gt;
for $c1 in $countries
for $c2 in $countries
where $c1/MostPopular = $c2/LeastPopular
return &lt;LangPair language="{$c1/MostPopular}"&gt;
           &lt;MostPopular&gt;{data($c1/@name)}&lt;/MostPopular&gt;
           &lt;LeastPopular&gt;{data($c2/@name)}&lt;/LeastPopular&gt;
       &lt;/LangPair&gt;
</pre>

<p>
For each language spoken in one or more countries, create a &ldquo;language&rdquo;
element with a &ldquo;name&rdquo; attribute and one &ldquo;country&rdquo; subelement for each
country in which the language is spoken.  The &ldquo;country&rdquo; subelements
should have two attributes: the country &ldquo;name&rdquo;, and &ldquo;speakers&rdquo;
containing the number of speakers of that language (based on language
percentage and the country&rsquo;s population).  Order the result by
language name, and enclose the entire list in a single &ldquo;languages&rdquo;
element.  For example, your result might look like:
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">language</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Arabic</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Iran</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">660942</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Saudi Arabia</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">19409058</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Yemen</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">13483178</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">language</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;languages&gt;
    { for $lang in distinct-values(doc("countries.xml")//language)
      order by $lang
      return &lt;language name="{$lang}"&gt;
                 { for $c in doc("countries.xml")//country[language = $lang]
                   return &lt;country name="{$c/@name}"
                                   speakers="{xs:int(
                                       $c/language[. = $lang]/@percentage
                                           div 100 * $c/@population)}"&gt;
                          &lt;/country&gt; }
             &lt;/language&gt; }
&lt;/languages&gt;
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org8fdcca2" class="outline-2">
<h2 id="xslt-mini-course"><a id="org8fdcca2"></a><span class="section-number-2">3</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XSLT/SelfPaced/courseware/ch-querying_xml/">XSLT</a> mini-course</h2>
<div class="outline-text-2" id="text-xslt-mini-course">
</div>
<div id="outline-container-org2990ebd" class="outline-3">
<h3 id="xslt-mini-course-lectures"><a id="org2990ebd"></a><span class="section-number-3">3.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-xslt-mini-course-lectures">
<ul class="org-ul">
<li>XSL = Extensible Stylesheet Language</li>
<li>XSLT = XSL (with) transformations</li>
</ul>

<p>
XSLT is more widely used than XSL.
</p>

<p>
XSLT: Rule-Based Transformations
</p>

<ul class="org-ul">
<li>Match template and replace</li>
<li>Recursively match template</li>
<li>Extract values</li>
<li>Iteration (for-each)</li>
<li>Conditionals (if)</li>
</ul>

<p>
Catches:
</p>

<ul class="org-ul">
<li>Strange default/whitespace behavior</li>
<li>Implicit template priority scheme</li>
</ul>
</div>
</div>

<div id="outline-container-orgac180f8" class="outline-3">
<h3 id="orgac180f8"><span class="section-number-3">3.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-orgcc33cac" class="outline-4">
<h4 id="course-catalog-xslt"><a id="orgcc33cac"></a><span class="section-number-4">3.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XSLT</h4>
<div class="outline-text-4" id="text-course-catalog-xslt">
<p>
Return a list of department titles.
</p>

<p>
Your solution should fill in the following stylesheet:
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match=...&gt;
        ... template body ...
    &lt;/xsl:template&gt;
    ... more templates as needed ...
&lt;/xsl:stylesheet&gt;
</pre>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department/Title"&gt;
        &lt;xsl:copy-of select="."/&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Return a list of department elements with no attributes and two
subelements each: the department title and the entire Chair subelement
structure.
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department"&gt;
      &lt;Department&gt;
        &lt;xsl:copy-of select="Title"/&gt;
        &lt;xsl:copy-of select="Chair"/&gt;
      &lt;/Department&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-orga8678c7" class="outline-4">
<h4 id="course-catalog-xslt-extras"><a id="orga8678c7"></a><span class="section-number-4">3.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</h4>
<div class="outline-text-4" id="text-course-catalog-xslt-extras">
<p>
Return all courses with enrollment greater than 500.  Retain the
structure of Course elements from the original data.
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Course[@Enrollment &amp;gt; 500]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Remove from the data all courses with enrollment greater than 60, or
with no enrollment listed.  Otherwise the structure of the data should
be the same.
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="Course[not(@Enrollment) or @Enrollment &amp;gt; 60]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create a summarized version of the EE part of the course catalog.  For
each course in EE, return a Course element, with its Number and Title
as attributes, its Description as a subelement, and the last name of
each instructor as an Instructor subelement.  Discard all information
about department titles, chairs, enrollment, and prerequisites, as
well as all courses in departments other than EE.  (Note: To specify
quotes within an already-quoted XPath expression, use quot;.)
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='EE']"&gt;
    &lt;xsl:for-each select="Course"&gt;
      &lt;Course Number="{@Number}"
              Title="{Title}"&gt;
        &lt;xsl:copy-of select="Description"/&gt;
        &lt;xsl:for-each select="Instructors//Last_Name"&gt;
          &lt;Instructor&gt;&lt;xsl:value-of select="."/&gt;&lt;/Instructor&gt;
        &lt;/xsl:for-each&gt;
      &lt;/Course&gt;
    &lt;/xsl:for-each&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create an HTML table with one-pixel border that lists all CS
department courses with enrollment greater than 200.  Each row should
contain three cells: the course number in italics, course title in
bold, and enrollment.  Sort the rows alphabetically by course title.
No header is needed.  (Note: For formatting, just use &ldquo;table
border=1&rdquo;, and &ldquo;&lt;b&gt;&rdquo; and &ldquo;&lt;i&gt;&rdquo; tags for bold and italics respectively.
To specify quotes within an already-quoted XPath expression, use
quot;.)
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='CS']"&gt;
    &lt;table border="1"&gt;
      &lt;xsl:for-each select="Course[@Enrollment &amp;gt; 200]"&gt;
        &lt;xsl:sort select="Title"/&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;i&gt;&lt;xsl:value-of select="@Number"/&gt;&lt;/i&gt;&lt;/td&gt;
          &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="Title"/&gt;&lt;/b&gt;&lt;/td&gt;
          &lt;td&gt;&lt;xsl:value-of select="@Enrollment"/&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/xsl:for-each&gt;
    &lt;/table&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-org47ce37a" class="outline-4">
<h4 id="world-countries-xslt"><a id="org47ce37a"></a><span class="section-number-4">3.2.3</span> <span class="done DONE">DONE</span> World-Countries XSLT</h4>
<div class="outline-text-4" id="text-world-countries-xslt">
<p>
Return all countries with population between 9 and 10 million.  Retain
the structure of country elements from the original data.
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[9000000 &amp;lt;= @population and @population &amp;lt;= 10000000]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create a table using HTML constructs that lists all countries that
have more than 3 languages.  Each row should contain the country name
in bold, population, area, and number of languages.  Sort the rows in
descending order of number of languages.  No header is needed for the
table, but use &lt;table border=&ldquo;1&rdquo;&gt; to make it format nicely, should you
choose to check your result in a browser.  (Hint: You may find the
data-type and order attributes of &lt;xsl:sort&gt; to be useful.)
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="countries"&gt;
    &lt;html&gt;
      &lt;table border="1"&gt;
        &lt;xsl:for-each select="country[count(language) &amp;gt; 3]"&gt;
          &lt;xsl:sort select="count(language)"
                    order="descending"/&gt;
          &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@area"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="count(language)"/&gt;&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/xsl:for-each&gt;
      &lt;/table&gt;
    &lt;/html&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create an alternate version of the countries database: for each
country, include its name and population as subelements, and the number
of languages and number of cities as attributes (called &ldquo;languages&rdquo;
and &ldquo;cities&rdquo; respectively).
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country"&gt;
    &lt;country languages="{count(language)}"
             cities="{count(city)}"&gt;
      &lt;name&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/name&gt;
      &lt;population&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/population&gt;
    &lt;/country&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-org089f8b2" class="outline-4">
<h4 id="world-countries-xslt-extras"><a id="org089f8b2"></a><span class="section-number-4">3.2.4</span> <span class="done DONE">DONE</span> World-Countries XSLT Extras</h4>
<div class="outline-text-4" id="text-world-countries-xslt-extras">
<p>
Find all country names containing the string &ldquo;stan&rdquo;; return each one
within a &ldquo;Stan&rdquo; element.  (Note: To specify quotes within an
already-quoted XPath expression, use quot;.)
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[contains(@name, 'stan')]"&gt;
    &lt;Stan&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/Stan&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Remove from the data all countries with area greater than 40,000 and
all countries with no cities listed.  Otherwise the structure of the
data should be the same.
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country[@area &amp;gt; 40000 or not(city)]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org2a94fe1" class="outline-2">
<h2 id="relational-design-theory-mini-course"><a id="org2a94fe1"></a><span class="section-number-2">4</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/RD/SelfPaced/courseware/ch-relational_design_theory/">Relational Design Theory</a> mini-course</h2>
<div class="outline-text-2" id="text-relational-design-theory-mini-course">
</div>
<div id="outline-container-org034d695" class="outline-3">
<h3 id="relational-design-theory-mini-course-lectures"><a id="org034d695"></a><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-relational-design-theory-mini-course-lectures">
</div>
<div id="outline-container-org03eb097" class="outline-4">
<h4 id="org03eb097"><span class="section-number-4">4.1.1</span> <span class="done DONE">DONE</span> Overview</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Design &ldquo;anomalies&rdquo;
</p>
<ul class="org-ul">
<li>Redundancy</li>
<li>Update anomaly</li>
<li>Deletion anomaly</li>
</ul>

<p>
Design by decomposition
</p>
<ul class="org-ul">
<li>Start with &ldquo;mega&rdquo; relations containing everything</li>
<li>Decompose into smaller, better relations with same info</li>
<li>Can do decomposition automatically</li>
</ul>

<p>
Automatic decomposition
</p>
<ul class="org-ul">
<li>&ldquo;Mega&rdquo; relations + <i>properties of the data</i></li>
<li>System decomposes based on properties</li>
<li>Final set of relations satisfies <i>normal form</i>
<ul class="org-ul">
<li>No anomalies, no lost information</li>
</ul></li>
</ul>

<p>
Properties and Normal Forms
</p>
<ul class="org-ul">
<li>Functional dependencies \(\Rightarrow\) Boyce-Codd Normal Form</li>
<li>Multivalued dependencies \(\Rightarrow\) Fourth Normal Form</li>
</ul>

<p>
4NF \(\subset\) BCNF
</p>

<p>
Functional Dependencies and BCNF
</p>
<ul class="org-ul">
<li>Apply(SSN, sName, cName)
<ul class="org-ul">
<li>Redundancy; Update &amp; Deletion Anomalies</li>
<li>Storing SSN-sName pair once for each college</li>
</ul></li>

<li><i>Functional Dependency</i> SSN \(\rightarrow\) sName
<ul class="org-ul">
<li>Same SSN always has same sName</li>
<li>Should store each SSN&rsquo;s sName only once</li>
</ul></li>

<li><i>Boyce-Codd Normal Form</i> If A \(\rightarrow\) B then A is a key</li>
</ul>

<p>
SSN should be a key but not.
</p>

<ul class="org-ul">
<li>Decompose: Student(SSN, sName) Apply(SSN, cName)</li>
</ul>

<p>
Pull out SSN and sName into its own relation
</p>

<p>
Multivalued Dependencies and 4NF
</p>
<ul class="org-ul">
<li>Apply(SSN, cName, HS)
<ul class="org-ul">
<li>Redundancy; Update &amp; Deletion Anomalies</li>
<li>Multiplicative effect
<ul class="org-ul">
<li>C colleges, H high school</li>
<li>C * H tuples</li>
<li>Should be C + H</li>
</ul></li>
<li>Not addressed by BCNF: No functional dependencies</li>
</ul></li>

<li><i>Multivalued Dependency</i> SSN \(\twoheadrightarrow\) cName, SSN \(\twoheadrightarrow\) HS
<ul class="org-ul">
<li>Given SSN has every combination of cName with HS</li>
<li>Should store each cName and each HS for an SSN once</li>
</ul></li>

<li><i>Fourth Normal Form</i> If A \(\twoheadrightarrow\) B then A is a key</li>

<li>Decompose: Apply(SSN, cName) HighSchool(SSN, HS)</li>
</ul>
</div>
</div>

<div id="outline-container-org65838f2" class="outline-4">
<h4 id="functional-dependencies"><a id="org65838f2"></a><span class="section-number-4">4.1.2</span> <span class="done DONE">DONE</span> Functional Dependencies</h4>
<div class="outline-text-4" id="text-functional-dependencies">
<p>
Functional dependencies are generally useful concepts
</p>
<ul class="org-ul">
<li>Data storage - compression</li>
<li>Reasoning about queries - optimization</li>
</ul>

<p>
Functional dependencies generalizes keys.
</p>

<pre class="example">
Student(SS, sName, address, HScode, HSname, HScity, GPA, priority)
</pre>

<p>
Suppose priority is determined by GPA
</p>

<p>
Two tuples with same GPA have same priority
</p>

<p>
\[\forall t, u \in \mathrm{Student}\colon\,
  t.\mathrm{GPA} = u.\mathrm{GPA} \Rightarrow t.\mathrm{priority} = u.\mathrm{priority}\]
</p>

<p>
GPA \(\rightarrow\) priority
</p>

<p>
\[\forall t, u \in R\colon\,
  t[A_1, \dotsc, A_n] = u[A_1, \dotsc, A_n] \Rightarrow t[B_1, \dotsc, B_n] = u[B_1, \dotsc, B_n]\]
</p>

<p>
\(A_1, \dotsc, A_n \rightarrow B_1, \dotsc, B_n\)
</p>

<p>
\(\bar{A} \rightarrow \bar{B}\)
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) sName</li>
<li>SSN \(\rightarrow\) address (assume students don&rsquo;t work)</li>
<li>HScode \(\rightarrow\) HSname, HScity</li>
<li>HSname, HScity \(\rightarrow\) HScode (assume no schools with same name in the same city)</li>
</ul>

<p>
And
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) GPA</li>
<li>GPA \(\rightarrow\) priority</li>
<li>SSN \(\rightarrow\) priority</li>
</ul>

<p>
transitivity
</p>

<pre class="example">
Apply(SSN, cName, state, date, major)
</pre>

<ul class="org-ul">
<li>cName \(\rightarrow\) date</li>
<li>SSN, cName \(\rightarrow\) major</li>
</ul>

<p>
and
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) state</li>
</ul>

<p>
Functional Dependencies and Keys
</p>

<p>
\(R(\bar{A}, \bar{B})\)
</p>

<p>
Trivial Functional Dependency
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow \bar{B}\), \(\bar{B} \subset \bar{A}\)</li>
</ul>

<p>
Nontrivial FD
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow \bar{B}\), \(\bar{B} \not\subset \bar{A}\)</li>
</ul>

<p>
Completely nontrivial FD (most interested)
</p>
<ul class="org-ul">
<li>\(A \rightarrow B\), \(A \cap B = \varnothing\)</li>
</ul>

<p>
Splitting rule
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow B_1, B_2, \dotsc, B_m \Rightarrow \bar{A} \rightarrow
   B_1, \bar{A} \rightarrow B_2, \dotsc\)</li>
</ul>

<p>
Combining rule
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow B_1, \bar{A} \rightarrow B_2, \dotsc \bar{A}
   \rightarrow B_n \Rightarrow \bar{A} \rightarrow B_1, B_2, \dotsc,
   B_n\)</li>
</ul>

<p>
Trivial-dependency rules
</p>
<ul class="org-ul">
<li>A \(\rightarrow\) B, then A \(\rightarrow\) A \(\cup\) B</li>
<li>A \(\rightarrow\) B, then A \(\rightarrow\) A \(\cap\) B</li>
</ul>

<p>
Transitive rule
</p>
<ul class="org-ul">
<li>A \(\rightarrow\) B, B \(\rightarrow\) C, then A \(\rightarrow\) C</li>
</ul>

<p>
Closure of Attributes
</p>
<ul class="org-ul">
<li>Given relations, FDs, set of attributes \(\bar{A}\)</li>
<li>Find all \(B\) such that \(\bar{A} \rightarrow B\)</li>
</ul>

<p>
\(\bar{A}^+\)
</p>

<p>
apply transitive rule repeatedly to get the closure
</p>

<p>
if \(\bar{A}^+\) = all attrs, then \(\bar{A}\) is a key.
</p>

<p>
Grow algorithms can be used to find all keys given a set of FDs.
</p>

<p>
If \(\bar{A}\) is a key, then all its supersets are keys.  Hence, we are
often only interested the smallest key.
</p>

<p>
Specifying FDs for a relation
</p>
<ul class="org-ul">
<li>\(S_1\) and \(S_2\) sets of FDs</li>
<li>\(S_2\) &ldquo;follows from&rdquo; \(S_1\) if every relation instance satisfying \(S_1\) also
satisfies \(S_2\)
<ul class="org-ul">
<li>\(S_2\): {SSN \(\rightarrow\) priority}</li>
<li>\(S_1\): {SSN \(\rightarrow\) GPA, GPA \(\rightarrow\) priority}</li>
</ul></li>
</ul>

<p>
Does A \(\rightarrow\) B follow from S?
</p>
<ol class="org-ol">
<li>\(A^+\) based S check if B in set.</li>
<li>Armstrong&rsquo;s Axioms</li>
</ol>

<p>
Want: <span class="underline">Minimal</span> set of <span class="underline">completely nontrivial</span> FDs such that <span class="underline">all FDs</span> that
hold on the relation follow from the dependencies in this set
</p>
</div>
</div>

<div id="outline-container-orgc9d3bde" class="outline-4">
<h4 id="boyce-codd-normal-form"><a id="orgc9d3bde"></a><span class="section-number-4">4.1.3</span> <span class="done DONE">DONE</span> Boyce-Codd Normal Form</h4>
<div class="outline-text-4" id="text-boyce-codd-normal-form">
<p>
Decomposition of a relational schema
</p>
<ul class="org-ul">
<li>\(R(A_1, \dotsc, A_n)\)</li>
<li>\(R_1(B_1, \dotsc, B_k)\)</li>
<li>\(R_2(C_1, \dotsc, C_m)\)</li>
</ul>

<p>
Then we want
</p>
<ul class="org-ul">
<li>\(\bar{B} \cup \bar{C} = \bar{A}\)</li>
<li>\(R_1 \Join R_2 = R\)</li>
</ul>

<pre class="example">
Student(SSN, sName, address, HScode, HSname, HScity, GPA, priority)
</pre>

<p>
This is a decomposition.
</p>

<pre class="example">
S1(SSN, sName, address, HScode, GPA, priority)
S2(HScode, HSname, HScity)
</pre>

<p>
This is not a decomposition.
</p>

<pre class="example">
S1(SSN, sName, address, HScode, HSname, HScity)
S2(sName, HSname, GPA, priority)
</pre>

<p>
Good decomposition exhibits lossless join property.
</p>

<p>
BCNF
</p>
<ul class="org-ul">
<li>Relation R with FDs is in BCNF if:
<ul class="org-ul">
<li>For each \(\bar{A} \rightarrow B\), \(\bar{A}\) is a key.</li>
</ul></li>
</ul>

<p>
BCNF violation (redundancy, update/delete anomalies)
</p>

<p>
note: a key can contain another key and thus is a super key.
</p>

<p>
BCNF decomposition algorithm
</p>

<ul class="org-ul">
<li>Input: relation R + FDs for R</li>
<li>Output: decomposition of R into BCNF relations with &ldquo;lossless join&rdquo;</li>
</ul>


<ul class="org-ul">
<li>Compute keys for \(R\)</li>
<li>Repeat until all relations are in BCNF
<ul class="org-ul">
<li>Pick any \(R'\) with \(A \rightarrow B\) that violates BCNF</li>
<li>Decompose \(R'\) into \(R_1(A, B)\) and \(R_2(A, \mathrm{rest})\)</li>
<li>Compute FDs for \(R_1\) and \(R_2\)</li>
<li>Compute keys for \(R_1\) and \(R_2\)</li>
</ul></li>
</ul>

<p>
Randomness can result in different answer.
We can extend \(A \rightarrow BA^+\).
</p>
</div>
</div>

<div id="outline-container-org843bcab" class="outline-4">
<h4 id="multivalued-dependencies-and-4th-normal-form"><a id="org843bcab"></a><span class="section-number-4">4.1.4</span> <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</h4>
<div class="outline-text-4" id="text-multivalued-dependencies-and-4th-normal-form">
<p>
Fourth Normal Form \(\subset\) Boyce-Codd Normal Form
</p>

<p>
\[R \quad  \bar{A} \twoheadrightarrow \bar{B} \quad
  A_1, \dotsc, A_n, B_1, \dotsc, B_n\]
</p>

<p>
\[\forall t, u \in R \, \exists v \in R:\, 
  t[\bar{A}] = u[\bar{A}] \implies
  v[\bar{A}] = t[\bar{A}] \land
  v[\bar{B}] = t[\bar{B}] \land
  v[\mathrm{rest}] = u[\mathrm{rest}]\]
</p>

<p>
Tuple-generating dependencies
</p>

<p>
\(\bar{A} \twoheadrightarrow \bar{B} \implies \bar{A} \twoheadrightarrow \mathrm{rest}\)
</p>

<p>
Trivial Multivalued Dependency
</p>
<ul class="org-ul">
<li>\(B \subset A\) or \(A \cup B =\) all attrs</li>
</ul>

<p>
\(A \rightarrow B \implies A \twoheadrightarrow B\)
</p>

<p>
FD-is-an-MVD rule
</p>

<p>
4NF \(\implies\) BCNF
</p>

<p>
Intersection rule
</p>
<ul class="org-ul">
<li>If \(A \twoheadrightarrow B\), \(A \twoheadrightarrow C\), then \(A
   \twoheadrightarrow B \cap C\)</li>
</ul>

<p>
Transitive rule
</p>
<ul class="org-ul">
<li>If \(A \twoheadrightarrow B\), \(B \twoheadrightarrow C\), then \(A
   \twoheadrightarrow C - B\)</li>
</ul>

<p>
Fourth Normal Form
</p>

<p>
Relation R with MVDs is in 4NF if:
</p>
<ul class="org-ul">
<li>For each nontrivial A \(\twoheadrightarrow\) B, A is a key</li>
</ul>
</div>
</div>

<div id="outline-container-org8daf5d8" class="outline-4">
<h4 id="org8daf5d8"><span class="section-number-4">4.1.5</span> <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</h4>
</div>
</div>

<div id="outline-container-orgccc4c88" class="outline-3">
<h3 id="relational-design-theory-mini-course-exercises"><a id="orgccc4c88"></a><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-relational-design-theory-mini-course-exercises">
<ul class="org-ul">
<li>R(A,B)</li>
<li><del>R(A,C,D)</del></li>
<li>R(A,C)</li>
<li>R(C,D)</li>
</ul>


<ul class="org-ul">
<li>R(C,D)</li>
<li><del>R(A,B,C)</del></li>
<li>R(A,B)</li>
<li>R(A,C)</li>
</ul>


<ul class="org-ul">
<li>R(B,C)</li>
<li><del>R(A,B,D)</del></li>
<li>R(A,B)</li>
<li>R(A,D)</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org61e0e60" class="outline-2">
<h2 id="uml-mini-course"><a id="org61e0e60"></a><span class="section-number-2">5</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/UML/SelfPaced/courseware/ch-unified_modeling_language/">Unified Modeling Language</a> mini-course</h2>
<div class="outline-text-2" id="text-uml-mini-course">
</div>
<div id="outline-container-orge65f214" class="outline-3">
<h3 id="orge65f214"><span class="section-number-3">5.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org29e56c4" class="outline-4">
<h4 id="uml-data-modeling"><a id="org29e56c4"></a><span class="section-number-4">5.1.1</span> <span class="done DONE">DONE</span> UML Data Modeling</h4>
<div class="outline-text-4" id="text-uml-data-modeling">
<p>
Entity-Relationship Model (E/R)
Unified Modeling Language
</p>
<ul class="org-ul">
<li>Data modeling subset</li>
</ul>

<p>
Both are graphical
Both can be translated to relations automatically
</p>
<ul class="org-ul">
<li>Or semi-automatically</li>
</ul>

<p>
UML Data Modeling: 5 concepts
</p>

<ol class="org-ol">
<li>Classes</li>
<li>Associations</li>
<li>Association Classes</li>
<li>Subclasses</li>
<li>Composition &amp; Aggregation</li>
</ol>


<p>
Classes
</p>

<p>
Name, attributes, methods
</p>
<ul class="org-ul">
<li>For data modeling: add &ldquo;pk&rdquo;, drop methods</li>
</ul>

<pre class="example">
|-----------|
|  Student  |
|-----------|
| sID    pk |
| sName     |
| GPA       |
|-----------|
| &lt;methods&gt; |
|-----------|

|-----------|
| College   |
|-----------|
| cName  pk |
| state     |
|-----------|
| &lt;methods&gt; |
|-----------|
</pre>

<p>
Relationships between objects of two classes
</p>

<pre class="example">
|-----------|           |-----------|
|  Student  |           | College   |
|-----------|  Applied  |-----------|
| sID    pk |-----------| cName  pk |
| sName     |          | state     |
| GPA       |           |-----------|
|-----------|           | &lt;methods&gt; |
| &lt;methods&gt; |           |-----------|
|-----------|
</pre>

<p>
Multiplicity of Associations
</p>

<p>
Each object of class C1 is related to at least m and at most n objects
of class C2
</p>

<pre class="example">
|----|                |----|
| C1 |                | C2 |
|----|        m..n    |----|
|    |----------------|    |
|----|      A         |----|
</pre>

<ul class="org-ul">
<li>m..* at least m</li>
<li>0..n at most n</li>
<li>0..* no restrictions</li>
</ul>

<p>
The default is 1..1
</p>

<ul class="org-ul">
<li>1..1 abbreviated as 1</li>
<li>0..* abbreviated as *</li>
</ul>

<p>
Students must apply somewhere and may not apply to more than 5
colleges.  No college takes more than 20,000 applications.
</p>

<pre class="example">
|-----------|                   |-----------|
|  Student  |                   | College   |
|-----------| 0..20000     1..5 |-----------|
| sID    pk |-------------------| cName  pk |
| sName     |      Applied      | state     |
| GPA       |                   |-----------|
|-----------|                   | &lt;methods&gt; |
| &lt;methods&gt; |                   |-----------|
|-----------|
</pre>

<p>
Types of relationships
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">One-to-One</td>
<td class="org-right">0..1</td>
<td class="org-right">0..1</td>
</tr>

<tr>
<td class="org-left">Many-to-One</td>
<td class="org-right">*</td>
<td class="org-right">0..1</td>
</tr>

<tr>
<td class="org-left">Many-to-Many</td>
<td class="org-right">*</td>
<td class="org-right">a</td>
</tr>

<tr>
<td class="org-left">Complete</td>
<td class="org-right">1..</td>
<td class="org-right">1..</td>
</tr>
</tbody>
</table>

<p>
Default is complete one-to-one
</p>


<p>
Association Classes
</p>

<p>
Relationships between objects of two classes,
</p>
<ul class="org-ul">
<li>with attributes on relationships</li>
</ul>

<pre class="example">
|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------|        Applied           |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>

<p>
It&rsquo;s hard to have more than one relationship association between the
same student and college.
</p>

<p>
Eliminating Association Classes
</p>
<ul class="org-ul">
<li>Unnecessary if 0..1 or 1..1 multiplicity</li>
</ul>

<pre class="example">
|----|                |----|
| C1 |                | C2 |
|----| *         1..1 |----|
| A3 |----------------| A4 |
|----|       |        |----|
           |----|
           | AC |
           |----|
           | A1 |
           | A2 |
           |----|
</pre>

<p>
Self-Associations
</p>

<p>
Associations between a class and itself
</p>

<pre class="example">
|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|


|---------|
| College |home
|---------|------|
|         |1..1  | Branch
|         |0..10 |
|---------|------|
           Satellite
</pre>

<p>
Subclasses
</p>

<pre class="example">
                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                          inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN       |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>

<ul class="org-ul">
<li>Superclass = Generalization</li>
<li>Subclass = Specialization</li>
<li>Incomplete (Partial) vs. Complete
<ul class="org-ul">
<li>Complete: every obj in the superclass is in at least one subclass</li>
</ul></li>
<li>Disjoint (Exclusive) vs. Overlapping
<ul class="org-ul">
<li>Disjoint: every obj in the superclass is in at most one subclass</li>
</ul></li>
</ul>


<p>
Composition &amp; Aggregation
</p>
<ul class="org-ul">
<li>Objects of one class belong to objects of another class</li>
</ul>

<pre class="example">
|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |--------------| dName      |
| state    |-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>

<p>
The symbol  indicates composition, implicitly specifying 1..1.
</p>
<ul class="org-ul">
<li>Department belongs to College.</li>
</ul>

<p>
The symbol  indicates aggregation, implicitly specifying 0..1.
</p>
<ul class="org-ul">
<li>Some apartments are owned by or associated with colleges, but not
all of them are.</li>
</ul>
</div>
</div>

<div id="outline-container-org7e43182" class="outline-4">
<h4 id="uml-to-relations"><a id="org7e43182"></a><span class="section-number-4">5.1.2</span> <span class="done DONE">DONE</span> UML to Relations</h4>
<div class="outline-text-4" id="text-uml-to-relations">
<p>
High-Level Database Design Model
</p>
<ul class="org-ul">
<li>User-friendly (graphical) specification language</li>
<li>Translated into model of DBMS</li>
</ul>

<p>
Designs can be translated to relations automatically
</p>
<ul class="org-ul">
<li>Provided every &ldquo;regular&rdquo; class has a key</li>
</ul>

<p>
Every class becomes a relation: pk \(\rightarrow\) primary key
</p>

<p>
Associations
</p>
<ul class="org-ul">
<li>Relation with key from each side</li>
</ul>

<p class="pre">
Applied(sID, cName)
</p>

<p>
Keys for association relations depends on multiplicity
</p>

<pre class="example">
|-------|                      |-------|
|  C1   |                      |  C2   |
|-------| 0..1               * |-------|
| K1 pk |----------------------| K2 pk |
| O1    |          A           | O2    |
|-------|                      |-------|
</pre>

<p class="pre">
C1( <span class="underline">K1</span>, O1)
C2( <span class="underline">K2</span>, O2)
</p>

<p class="pre">
A(K1, <span class="underline">K2</span>)
</p>

<pre class="example">
|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------| *      Applied     1..1  |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>

<p class="pre">
Applied( <span class="underline">sID</span>, cName)
</p>

<p class="pre">
C1( <span class="underline">K1</span>, O1)
C2( <span class="underline">K2</span>, O2)  \(\leftarrow\) C2( <span class="underline">K2</span>, O2, K1)
<del>A(K1, <span class="underline">K2</span>)</del>
</p>

<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)  \(\leftarrow\) Student( <span class="underline">sID</span>, sName, GPA, cName)
College( <span class="underline">cName</span>, state)
<del>Applied( <span class="underline">sID</span>, cName)</del>
</p>

<p>
Association Classes
</p>

<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)
College( <span class="underline">cName</span>, state)
Applied( <span class="underline">sID</span>, cName, date, decision)
</p>

<p>
Require a key for every &ldquo;regular&rdquo; class.
</p>

<p>
Self-Associations
</p>

<pre class="example">
|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|
</pre>


<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)
Sibling( <span class="underline">sID1, sID2</span>)
</p>

<pre class="example">
|----------|
| College  | home
|----------|-------|
| cName pk | 1..1  | Branch
| state    |       |
| enr      | 0..10 |
|----------|-------|
             Satellite
</pre>

<p class="pre">
College( <span class="underline">cName</span>, state, enr)
Branch(home, <span class="underline">satellite</span>)
</p>

<p class="pre">
College( <span class="underline">cName</span>, state, enr, home) ???
</p>


<p>
Subclasses
</p>
<ol class="org-ol">
<li>Subclass relations contain superclass key + specialized attrs.</li>
<li>Subclass relations contain all attributes.</li>
<li>One relation containing all superclass + subclass attrs.</li>
</ol>

<p>
subclasses are not regular classes.
</p>

<pre class="example">
                     |-------|
                     |   S   |  superclass
                     |-------|
                     | K  pk |
                     | A     |
                     |-------|
                                            Subclasses
   |---------------------+-------------------|
   |                                         |
|----|                                     |----|
| S1 |                                     | S2 |
|----|                                     |----|
| B  |                                     | C  |
|----|                                     |----|
</pre>

<ol class="org-ol">
<li>S( <span class="underline">K</span>, A), S1( <span class="underline">K</span>, B), S2( <span class="underline">K</span>, C)</li>
<li>S( <span class="underline">K</span>, A), S1( <span class="underline">K</span>, A, B), S2( <span class="underline">K</span>, A, C)</li>
<li>S( <span class="underline">K</span>, A, B, C)</li>
</ol>

<p>
Heavily overlapping \(\Rightarrow\) design 3
</p>

<p>
Disjoint, Complete \(\Rightarrow\) design 2 with S( <span class="underline">K</span>, A) discarded
</p>

<pre class="example">
                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                          inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN    pk |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>

<p class="pre">
Student( <span class="underline">sID</span>, sName)
ForeignS( <span class="underline">sID</span>, Country)
DomesticS( <span class="underline">sID</span>, State, <span class="underline">SSN</span>)
<del>APStudent(sID)</del> \(\leftarrow\) eliminated, implicated in Took
APCourse( <span class="underline">Course#</span>, title, units)
Took( <span class="underline">sID, Course#</span>, year, grade)
</p>

<p>
Composition &amp; Aggregation
</p>

<pre class="example">
|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |--------------| dName      | Not "regular"
| state    |-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>

<p class="pre">
College( <span class="underline">cName</span>, state)
Department(dName, building, <span class="underline">cName</span>)
Apartment( <span class="underline">addr</span>, #units, cName)
                            
                          nullable
</p>
</div>
</div>
</div>

<div id="outline-container-org831a8a9" class="outline-3">
<h3 id="org831a8a9"><span class="section-number-3">5.2</span> <span class="done DONE">DONE</span> Exercises</h3>
</div>
</div>


<div id="outline-container-orgc820b60" class="outline-2">
<h2 id="indexes-and-transactions-mini-course"><a id="orgc820b60"></a><span class="section-number-2">6</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Indexes/SelfPaced/courseware/ch-indexes/">Indexes and Transactions</a> mini-course</h2>
<div class="outline-text-2" id="text-indexes-and-transactions-mini-course">
</div>
<div id="outline-container-orgef191f5" class="outline-3">
<h3 id="orgef191f5"><span class="section-number-3">6.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org76b4a66" class="outline-4">
<h4 id="indexes"><a id="org76b4a66"></a><span class="section-number-4">6.1.1</span> <span class="done DONE">DONE</span> Indexes</h4>
<div class="outline-text-4" id="text-indexes">
<p>
Indexes
</p>
<ul class="org-ul">
<li>Primary mechanism to get improved performance</li>
<li>Persistent data structure, stored in database</li>
<li>Many interesting implementation issues</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">A</th>
<th scope="col" class="org-right">B</th>
<th scope="col" class="org-left">C</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-left">dog</td>
<td class="org-right">5</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">cow</td>
<td class="org-right">1</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">dog</td>
<td class="org-right">9</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">5</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">6</td>
<td class="org-left">cat</td>
<td class="org-right">8</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-left">cow</td>
<td class="org-right">6</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#x2026;</td>
<td class="org-right">&#x2026;</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
</table>

<p>
Index on T.A
</p>
<ul class="org-ul">
<li>T.A = &rsquo;cow&rsquo;</li>
<li>T.A = &rsquo;cat&rsquo;</li>
</ul>

<p>
Index on T.B
</p>
<ul class="org-ul">
<li>T.B = 2</li>
<li>T.B &lt; 6</li>
<li>4 &lt; T.B  8</li>
</ul>

<p>
Index on T.(A, B)
</p>
<ul class="org-ul">
<li>T.A = &rsquo;cat&rsquo; and T.B &gt; 5</li>
<li>T.A &lt; &rsquo;d&rsquo; and T.B = 1</li>
</ul>

<p>
Utility
</p>
<ul class="org-ul">
<li>Index = difference between full table scans and immediate location
of tuples
<ul class="org-ul">
<li>Orders of magnitude performance difference</li>
</ul></li>

<li>Underlying data structures
<ul class="org-ul">
<li>Balanced trees (B trees, B+ trees)
<ul class="org-ul">
<li>A = V, A &lt; V, V1 &lt;= A &lt;= V2</li>
<li>logarithmic time</li>
</ul></li>
<li>Hash tables
<ul class="org-ul">
<li>constant time</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName
<span class="org-keyword">From</span> student
<span class="org-keyword">Where</span> sID = 18942
</pre>
</div>

<p>
Index on sID
</p>

<p>
Many DBMS&rsquo;s build indexes automatically on PRIMARY KEY (and sometimes
UNIQUE) attributes
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sID
<span class="org-keyword">From</span> Student
<span class="org-keyword">Where</span> sName = <span class="org-string">'Mary'</span> <span class="org-keyword">And</span> GPA &gt; 3.9
</pre>
</div>

<ul class="org-ul">
<li>Index on sName  hash or tree</li>
<li>Index on GPA  tree-based</li>
<li>Index on (sName, GPA)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName, cName
<span class="org-keyword">From</span> Student, Apply
<span class="org-keyword">Where</span> Student.sID = Apply.sID
</pre>
</div>

<ul class="org-ul">
<li>Index on student.sid or apply.sid or both</li>
</ul>

<p>
Query planning &amp; optimization
</p>


<p>
Downsides of Indexes
</p>

<ol class="org-ol">
<li>Extra space - marginal</li>
<li>Index creation - medium</li>
<li>Index maintenance - can offset benefits</li>
</ol>

<p>
Picking which indexes to create
</p>

<p>
Benefits of an index depends on:
</p>
<ul class="org-ul">
<li>Size of table (and possibly layout)</li>
<li>Data distributions</li>
<li>Query vs. update load</li>
</ul>


<p>
&ldquo;Physical design advisors&rdquo;
</p>

<p>
Input: database (statistics) and workload
Output: recommended indexes
</p>

<p>
<span class="underline">Query Optimizer</span> takes <span class="underline">Database statistics</span>, <span class="underline">Query or update</span>, and
<span class="underline">indexes</span> as input and gives <span class="underline">best execution plan with estimated cost</span>
as output.
</p>

<p>
Physical design advisor experiments different indexes through query
optimizer and gives recommended indexes, of which benefits outweigh
drawbacks.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A1, A2, ..., An)
<span class="org-keyword">Create</span> <span class="org-keyword">Unique</span> Index IndexName <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Drop</span> Index IndexName
</pre>
</div>
</div>
</div>

<div id="outline-container-org629192e" class="outline-4">
<h4 id="introduction-to-transactions"><a id="org629192e"></a><span class="section-number-4">6.1.2</span> <span class="done DONE">DONE</span> Introduction to Transactions</h4>
<div class="outline-text-4" id="text-introduction-to-transactions">
<p>
Motivated by two independent requirements
</p>
<ul class="org-ul">
<li>Concurrent database access</li>
<li>Resilience to system failures</li>
</ul>

<p>
<b>Concurrent Access</b>: Attribute-level Inconsistency <a id="org461d907"></a>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1500
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>

<p>
get; modify; put
</p>
<ul class="org-ul">
<li>Possible outcomes</li>
</ul>
\begin{align*}
  15,000 + 2500 &amp;= 17,500 \\
         + 1000 &amp;= 16,000 \\
         + 1500 &amp;= 16,500
\end{align*}

<p>
<b>Concurrent Access</b>: Tuple-level Inconsistency <a id="org6346c72"></a>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>

<p>
get; modify; put
</p>
<ul class="org-ul">
<li>both changes</li>
<li>one of the two changes</li>
</ul>

<p>
<b>Concurrent Access</b>: Table-level Inconsistency <a id="orgd57f0a2"></a>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span>
<span class="org-keyword">Where</span> sID <span class="org-keyword">In</span> (<span class="org-keyword">Select</span> sID <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> GPA &gt; 3.9)
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>

<p>
<b>Concurrent Access</b>: Multi-statement inconsistency <a id="org4f55e46"></a>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Apply;
<span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Archive;
</pre>
</div>

<p>
Concurrency Goal
</p>

<p>
Execute <i>sequence of SQL statements</i> so they appear to be running in
isolation
</p>

<ul class="org-ul">
<li>Simple solution: execute them in isolation</li>
</ul>

<p>
But want to enable concurrency whenever safe to do so
</p>

<ul class="org-ul">
<li>Multiprocessor</li>
<li>Multithreaded</li>
<li>Asynchronous I/O</li>
</ul>

<p>
Resilience to System Failures
</p>

<p>
Rather unpleasant inconsistent state can occur due to crashes when
there bulk loading to DBMS
</p>

<p>
Or
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>

<p>
Crash failure
</p>

<p>
Lots of updates buffered in memory
</p>

<p>
System-Failure Goal
</p>

<p>
Guarantee all-or-nothing execution, regardless of failures
</p>

<p>
Solution for both concurrency and failures
</p>

<p>
<b>Transactions</b>
</p>

<p>
A transaction is a sequence of one or more SQL operations treated as a
unit
</p>
<ul class="org-ul">
<li>Transactions appear to run in isolation</li>
<li>If the system fails, each transaction&rsquo;s changes are reflected
either entirely or not at all</li>
</ul>

<p>
SQL standard:
</p>
<ul class="org-ul">
<li>Transaction begins automatically on first SQL statement</li>
<li>On &ldquo;commit&rdquo; transaction ends and new one begins</li>
<li>Current transaction ends on session termination</li>
<li>&ldquo;Autocommit&rdquo; turns each statement into transaction</li>
</ul>
</div>
</div>

<div id="outline-container-org810b047" class="outline-4">
<h4 id="transaction-properties"><a id="org810b047"></a><span class="section-number-4">6.1.3</span> <span class="done DONE">DONE</span> Transaction Properties</h4>
<div class="outline-text-4" id="text-transaction-properties">
<p>
ACID Properties
</p>
<ul class="org-ul">
<li>Atomicity, Consistency, Isolation, Durability</li>
</ul>

<p>
Isolation
</p>
<ul class="org-ul">
<li><span class="underline">Serializability</span>: <a id="org3899d94"></a> Operations may be interleaved,
but execution must be equivalent to <i>some</i> sequential (serial)
order of all transactions</li>
</ul>

<p>
locking portion of the database
</p>

<p>
<a href="#org461d907">Attribute-level Inconsistency</a>
</p>
<ul class="org-ul">
<li>T1; T2</li>
<li>T2; T1</li>
</ul>

<p>
15,000  17,500
</p>

<p>
<a href="#org6346c72">Tuple-level Inconsistency</a>
</p>
<ul class="org-ul">
<li>T1; T2</li>
<li>T2; T1</li>
</ul>

<p>
both changes
</p>

<p>
<a href="#orgd57f0a2">Table-level Inconsistency</a>
</p>
<ul class="org-ul">
<li>T1; T2</li>
<li>T2; T1</li>
</ul>

<p>
Order matters here.
</p>

<p>
<a href="#org4f55e46">Multi-statement inconsistency</a>
</p>

<p>
Order also matters here.
</p>

<p>
Durability
</p>
<ul class="org-ul">
<li>If system crashes after transaction commits, all effects of
transaction remain in database.</li>
</ul>

<p>
<code>T2 {S1; S2; S3; commit}</code> crashes
</p>

<p>
implemented by logging
</p>

<p>
Atomicity
</p>
<ul class="org-ul">
<li>Each transaction is &ldquo;all-or-nothing,&rdquo; never left half done</li>
</ul>

<p>
<code>T2 { S1; S2; ... crashes ...; commit }</code>
</p>

<p>
Logging
</p>

<p>
Transaction Rollback (= Abort) 
</p>
<ul class="org-ul">
<li>Undoes <span class="underline">partial effects</span> of transaction</li>
<li>Can be <span class="underline">system</span> or <span class="underline">client initiated</span></li>
</ul>

<pre class="example">
Begin Transaction;
&lt;get input from user&gt;
SQL commands based on input
&lt;confirm results with user&gt;
If ans = 'ok' Then Commit; Else Rollback;
</pre>

<p>
Rollback only undoes data itself on database, but doesn&rsquo;t affect
variable, and cash delivery etc.
</p>

<p>
Never hold a transaction for long time.  Locking
</p>

<p>
Consistency
</p>
<ul class="org-ul">
<li>Each client, each transaction:
<ul class="org-ul">
<li>Can assume all constraints hold when transaction begins</li>
<li>Must guarantee all constraints hold when transaction ends</li>
</ul></li>
</ul>

<p>
Serializability  constraints always hold
</p>
</div>
</div>

<div id="outline-container-org5e44606" class="outline-4">
<h4 id="isolation-levels"><a id="org5e44606"></a><span class="section-number-4">6.1.4</span> <span class="done DONE">DONE</span> Isolation Levels</h4>
<div class="outline-text-4" id="text-isolation-levels">
<p>
<a href="#org3899d94">Serializability</a>  Overhead, Reduction in concurrency
</p>

<p>
Weaker &ldquo;Isolation Levels&rdquo; (from weak to strong)
</p>
<ul class="org-ul">
<li>Read Uncommitted</li>
<li>Read Committed</li>
<li>Repeatable Read</li>
<li>Serializable</li>
</ul>


<ul class="org-ul">
<li> Overhead  Concurrency</li>
<li> Consistency Guarantees</li>
</ul>

<p>
Isolation Levels
</p>
<ul class="org-ul">
<li>Per transaction</li>
<li>&ldquo;In the eye of the beholder&rdquo;</li>
</ul>

<p>
Dirty Reads
</p>
<ul class="org-ul">
<li>&ldquo;Dirty&rdquo; data item: written by an uncommitted transaction</li>
</ul>

<p>
Example 1
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(enrollment) <span class="org-keyword">From</span> College
</pre>
</div>

<p>
Example 2
</p>
<div class="org-src-container">
<pre class="src src-sql" id="orgbae3d07"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> GPA <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 2600 <span class="org-keyword">Where</span> sID = 234
</pre>
</div>

<p>
There is no such thing as dirty read within the same transaction.
</p>

<p>
Isolation Level: Read Uncommitted
</p>
<ul class="org-ul">
<li>A transaction may perform dirty reads</li>
</ul>

<p>
<a href="#orgbae3d07">Query</a> concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Uncommitted</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Read Committed
</p>
<ul class="org-ul">
<li>A transaction may <i>not</i> perform dirty reads</li>
</ul>

<p>
Still does not guarantee global serializability
</p>

<p>
<a href="#orgbae3d07">Query</a> concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Committed</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Repeatable Read
</p>
<ul class="org-ul">
<li>A transaction may not perform dirty reads</li>
<li>An item read multiple times cannot change value</li>
</ul>

<p>
Still does not guarantee global serializability
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA;
<span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 1500 <span class="org-keyword">where</span> sID = 123;
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(sizeHS) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Neither T1; T2 Nor T2; T1
</p>

<p>
But a relation <i>can</i> change: &ldquo;phantom&rdquo; tuples
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Student <span class="org-comment">-- [100 new tuples]</span>
</pre>
</div>
<p>
concurrent with &#x2026;
</p>
<div class="org-src-container">
<pre class="src src-sql" id="orgfa2c34c"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
The inserted tuples are called phantom tuples
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Student <span class="org-comment">-- [100 tuples]</span>
</pre>
</div>
<p>
concurrent with <a href="#orgfa2c34c">Query</a>
</p>

<p>
T1 must occur either before or after T2
</p>

<p>
Read Only transactions
</p>
<ul class="org-ul">
<li>Helps system optimize performance</li>
<li>Independent of isolation level</li>
</ul>

<p>
Orthogonal to isolation level
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Read</span> <span class="org-keyword">Only</span>;
<span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Levels: Summary
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">dirty Reads</th>
<th scope="col" class="org-left">nonrepeatable reads</th>
<th scope="col" class="org-left">phantoms</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Read Uncommitted</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Read Committed</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Repeatable Read</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Serializable</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Standard default: Serializable</li>
<li>Weaker isolation levels
<ul class="org-ul">
<li>Increased concurrency + decreased overhead =
increased performance</li>
<li>Weaker consistency guarantees</li>
<li>Some systems have default Repeatable Read</li>
</ul></li>
<li>Isolation level per transaction and &ldquo;eye of the beholder&rdquo;
<ul class="org-ul">
<li>Each transaction&rsquo;s reads must conform to its isolation level</li>
</ul></li>
</ul>

<p>
Note: An entire workload is globally serializable only if every
transaction&rsquo;s isolation level is serializable.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd4c93b2" class="outline-3">
<h3 id="orgd4c93b2"><span class="section-number-3">6.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org375fe21" class="outline-4">
<h4 id="org375fe21"><span class="section-number-4">6.2.1</span> <span class="done DONE">DONE</span> Index Quiz</h4>
<div class="outline-text-4" id="text-6-2-1">
</div>
</div>
<div id="outline-container-orgf9a7a7b" class="outline-4">
<h4 id="orgf9a7a7b"><span class="section-number-4">6.2.2</span> <span class="done DONE">DONE</span> Transaction Quiz</h4>
<div class="outline-text-4" id="text-6-2-2">
</div>
</div>
</div>
</div>


<div id="outline-container-org80b04be" class="outline-2">
<h2 id="constraints-and-triggers-mini-course"><a id="org80b04be"></a><span class="section-number-2">7</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Constraints/SelfPaced/courseware/ch-constraints_and_triggers/">Constraints and Triggers</a> mini-course</h2>
<div class="outline-text-2" id="text-constraints-and-triggers-mini-course">
</div>
<div id="outline-container-orgaf73a09" class="outline-3">
<h3 id="constraints-and-triggers-mini-course-lectures"><a id="orgaf73a09"></a><span class="section-number-3">7.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-constraints-and-triggers-mini-course-lectures">
</div>
<div id="outline-container-org8998615" class="outline-4">
<h4 id="org8998615"><span class="section-number-4">7.1.1</span> <span class="done DONE">DONE</span> Motivation and Overview</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
(Integrity) Constraints  &lt;static&gt;
</p>
<ul class="org-ul">
<li>constrain allowable database states</li>
</ul>


<p>
Triggers &lt;dynamic&gt;
</p>
<ul class="org-ul">
<li>monitor database changes,</li>
<li>check conditions and initiate actions</li>
</ul>


<p>
Integrity Constraints
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by</li>
<li>structure and types</li>
</ul>


<ul class="org-ul">
<li>0.0 &lt; GPA &lt;= 4.0</li>
<li>enrollment &lt; 50,000 (75,000)</li>
</ul>


<p>
Why use them?
</p>
<ul class="org-ul">
<li>Data-entry errors (inserts)</li>
<li>Correctness criteria (updates)</li>
<li>Enforce consistency</li>
<li>Tell system about data</li>
</ul>


<p>
Classification
</p>
<ul class="org-ul">
<li>Non-null</li>
<li>Key</li>
<li>Referential Integrity (foreign key)</li>
</ul>


<p>
Declaring and enforcing constraints
</p>

<p>
Declaration
</p>
<ul class="org-ul">
<li>With original schema - checked after bulk loading</li>
<li>Or later - checked on current DB</li>
</ul>


<p>
Enforcement
</p>
<ul class="org-ul">
<li>Check after every &ldquo;dangerous&rdquo; modification</li>
<li>Deferred constraint checking (transaction)</li>
</ul>


<p>
Triggers
</p>
<ul class="org-ul">
<li>&ldquo;Event-Condition-Action Rules&rdquo;</li>
<li>When <i>event</i> occurs, check <i>condition</i>; if true, do action</li>
</ul>


<p>
Examples
</p>
<ul class="org-ul">
<li>enrollment &gt; 35,000 -&gt; reject all applicants</li>
<li>insert app with GPA &gt; 3.95 -&gt; accept automatically</li>
<li>update sizeHS to be &gt; 7,000 -&gt; change to &ldquo;wrong&rdquo;, raise error</li>
</ul>


<p>
Why use them?
</p>
<ul class="org-ul">
<li>More logic from apps into DBMS</li>
<li>To enforce constraints
<ul class="org-ul">
<li>expressive</li>
<li>constraint &ldquo;repair&rdquo; logic</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span>|<span class="org-keyword">After</span>|Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Constraints and Triggers
</p>
<ul class="org-ul">
<li>For relational databases</li>
<li>SQL standard; systems vary considerably</li>
</ul>

<p>
(Integrity) Constraints
</p>
<ul class="org-ul">
<li>constrain allowable database states</li>
</ul>

<p>
Triggers
</p>
<ul class="org-ul">
<li>monitor database changes,</li>
<li>check conditions and initiate actions</li>
</ul>
</div>
</div>

<div id="outline-container-org22a255c" class="outline-4">
<h4 id="constraints-of-several-types"><a id="org22a255c"></a><span class="section-number-4">7.1.2</span> <span class="done DONE">DONE</span> Constraints of Several Types</h4>
<div class="outline-text-4" id="text-constraints-of-several-types">
<p>
Integrity Constraints
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by structure and types
<ul class="org-ul">
<li>Non-null constraints</li>
<li>Key constraints</li>
<li>Attribute-based and tuple-based constraints (limits)</li>
<li>General assertions (not implemented by any database)</li>
</ul></li>
</ul>

<p>
Not all constraints are implemented.
</p>

<p>
Constraints Demo
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Craig'</span>, <span class="org-keyword">null</span>, 500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed</span>
<span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 456; <span class="org-comment">-- succeed since 456 doesn't exist</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Craig'</span>, 3.5, 500); <span class="org-comment">-- failed, key error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = 123 <span class="org-keyword">where</span> sName = <span class="org-string">'Bob'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID - 111; <span class="org-comment">-- succeed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID + 111; <span class="org-comment">-- failed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text <span class="org-keyword">unique</span>,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Amy'</span>, 3.5, 500); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (456, <span class="org-string">'Doris'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (567, <span class="org-string">'Amy'</span>, 3.8, 1500); <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (cName, <span class="org-keyword">state</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 10000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'NY'</span>, 5000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 2000);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">unique</span>(sID, cName),
    <span class="org-keyword">unique</span>(sID, major)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above succeed.  SQL standard and most systems allow
duplicate null values for unique key.  Most systems do not permit
repeated null values for primary key.
</p>


<p>
Attribute check constraint
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA &lt;= 4.0 <span class="org-keyword">and</span> GPA &gt; 0.0),
    sizeHS <span class="org-type">int</span> <span class="org-keyword">check</span>(sizeHS &lt; 5000)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 4.6, 1500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(decision = <span class="org-string">'N'</span> <span class="org-keyword">or</span> cName &lt;&gt; <span class="org-string">'Stanford'</span> <span class="org-keyword">or</span> major &lt;&gt; <span class="org-string">'CS'</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'N'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>;
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<p>
Both queries failed on SQLite and Postgres, but not in MySQL (MySQL sucks).
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>),
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<p>
The above is equivalent to <code>GPA real not null</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>(A <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> A <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
The above check constraint implements key constraint.  It fails on
SQLite for several reasons.  The order of execution and check matters.
It works for at least some database system.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
                (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
No known database allows subquery, esp. aggregation, in check
expression, so the above query also doesn&rsquo;t work.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
The above table definitions is valid according to SQL standards but no
database implements subquery in check constraint.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    <span class="org-keyword">check</span>(enrollment &gt; (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(sizeHS) <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
Also valid in SQL standard but no database allows this.  Now, suppose
this works for some system, it has other problems.  When student table
changes, the check constraint may no longer be valid.
</p>


<p>
General Assertions
</p>
<ul class="org-ul">
<li>They are very powerful but unfortunately not implemented by any RDBMS.</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> <span class="org-keyword">Key</span>
<span class="org-keyword">check</span> ((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
       (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> ReferentialIntegrity
<span class="org-keyword">check</span>  (<span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student)));
</pre>
</div>

<p>
It&rsquo;s common to write <code>not exists</code> in general assertions.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> AvgAccept
<span class="org-keyword">check</span> (3.0 &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> sID <span class="org-keyword">in</span>
                (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> decision = <span class="org-string">'Y'</span>)));
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb790927" class="outline-4">
<h4 id="referential-integrity"><a id="orgb790927"></a><span class="section-number-4">7.1.3</span> <span class="done DONE">DONE</span> Referential Integrity</h4>
<div class="outline-text-4" id="text-referential-integrity">
<p>
Integrity Constraints
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by
structure and types</li>
</ul>

<p>
Referential integrity = Integrity of references = No &ldquo;dangling pointers&rdquo;
</p>


<p>
Referential integrity from R.A to S.B
</p>
<ul class="org-ul">
<li>Each value in column A of table R must appear in column B of table S
<ul class="org-ul">
<li>A is called the &ldquo;foreign key&rdquo; (Foreign key constraints)</li>
<li>B is usually required to be the <i>primary key</i> for table S or at least <i>unique</i></li>
<li>Multi-attribute foreign keys are allowed</li>
</ul></li>
</ul>

<p>
Referential integrity is directional
</p>

<p>
Referential Integrity Enforcement (R.A to S.B)
</p>
<ul class="org-ul">
<li>Potentially violating modifications:
<ul class="org-ul">
<li>Insert into R</li>
<li>Delete from S</li>
<li>Update R.A</li>
<li>Update S.B</li>
</ul></li>
</ul>

<p>
Special actions:
</p>
<ul class="org-ul">
<li>Delete from S
<ul class="org-ul">
<li>Delete from S
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code></li>
</ul></li>
<li>Update S.B
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID),
    cName text <span class="org-keyword">references</span> College(cName),
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above failed.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Stanford'</span>, <span class="org-string">'CA'</span>, 15000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Berkeley'</span>, <span class="org-string">'CA'</span>, 36000);
</pre>
</div>

<p>
After executing the above queries, the previous queries succeed.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 345 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed, break referential integrity</span>
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 234 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- succeed</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>; <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 234;          <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 123;          <span class="org-comment">-- succeed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = <span class="org-string">'Bezerkeley'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>; <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>;             <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">set</span> <span class="org-keyword">null</span>,
    cName text <span class="org-keyword">references</span> College(cName) <span class="org-keyword">on</span> <span class="org-keyword">update</span> <span class="org-keyword">cascade</span>,
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID &gt; 200;
</pre>
</div>

<p>
The Bezerkeley query now succeeds.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span> (
    A <span class="org-type">int</span>,
    B <span class="org-type">int</span>,
    C <span class="org-type">int</span>,
    <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (A, B),
    <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (B, C) <span class="org-keyword">references</span> T(A, B) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">cascade</span>
);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (1, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (2, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (3, 2, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (4, 3, 2);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (5, 4, 3);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (6, 5, 4);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (7, 6, 5);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (8, 7, 6);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> T <span class="org-keyword">where</span> A = 1;
</pre>
</div>

<p>
The above query will delete all the rows in T.
</p>
</div>
</div>

<div id="outline-container-orgb28428a" class="outline-4">
<h4 id="triggers-introduction"><a id="orgb28428a"></a><span class="section-number-4">7.1.4</span> <span class="done DONE">DONE</span> Triggers Introduction</h4>
<div class="outline-text-4" id="text-triggers-introduction">
<p>
Triggers
</p>
<ul class="org-ul">
<li>&ldquo;Event-Condition-Action Rules&rdquo;</li>
<li>When <i>event</i> occurs, check condition; if true, do action
<ol class="org-ol">
<li>Move monitoring logic from apps into DBMS</li>
<li>Enforce constraints
<ul class="org-ul">
<li>Beyond what constraint system supports</li>
<li>Automatic constraint &ldquo;repair&rdquo;</li>
</ul></li>
</ol></li>
</ul>

<p>
<b>Implementations vary significantly</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span> | <span class="org-keyword">After</span> | Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Events are one of <code>insert on T</code>, <code>delete on T</code>, <code>update [of C1, ..., Cn] on T</code>.
</p>

<p>
<code>[For Each Row]</code> means that the triggers should be executed once for
each modified tuple.
</p>

<p>
When event is an insert, <code>referencing-variables</code> can only reference
the newly inserted data.  When event is a delete, <code>referencing-variables</code>
can only reference the old deleted data.  When event is an update,
<code>referencing-variables</code> can reference both old and new data.
</p>

<p>
If a row-level trigger is concerned and the event is a delete, we can
refer both the old row and old table as different variables.  Old
table does not refer to the old state of the table in the database but
specifically refers to the rows deleted in the delete event.
</p>

<p>
If a statement-level trigger is concerned, only table can be referenced.
</p>

<p>
<code>(Condition)</code> is like SQL <code>where</code> clause.
</p>

<p>
<code>action</code> is the action to be performed when triggered.  This is where
various database systems differ.
</p>

<p>
Referential Integrity:
</p>
<ul class="org-ul">
<li>R.A references S.B, cascaded delete</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> O
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A = O.B
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> OT
<span class="org-comment">-- [ For Each Row ]</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A <span class="org-keyword">in</span> (<span class="org-keyword">Select</span> B <span class="org-keyword">from</span> OT)
</pre>
</div>


<p>
Tricky Issues
</p>

<ul class="org-ul">
<li>Row-level vs. Statement-level
<ul class="org-ul">
<li>New/Old Row and New/Old Table</li>
<li>Before, Instead Of</li>
</ul></li>

<li>Multiple triggers activated at same time</li>

<li>Trigger actions activating other triggers (chaining)
<ul class="org-ul">
<li>Also self-triggering, cycles, nested invocations</li>
</ul></li>

<li>Conditions in <code>When</code> vs. as part of <code>action</code></li>
</ul>


<p>
SQLite supports only row-level triggers.
</p>

<p>
T(K,V) - K key, V value
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-function-name">IncreaseInserts</span>
<span class="org-keyword">After</span> <span class="org-keyword">Insert</span> <span class="org-keyword">On</span> T
<span class="org-keyword">Referencing</span> <span class="org-keyword">New</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> NR, <span class="org-keyword">New</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> NT
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-keyword">When</span> (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> T) &lt;
     (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> NT)
<span class="org-keyword">Update</span> T <span class="org-keyword">set</span> V=V+10 <span class="org-keyword">where</span> K=NR.K
</pre>
</div>

<ul class="org-ul">
<li>No statement-level equivalent</li>
<li>Nondeterministic final state</li>
</ul>
</div>
</div>

<div id="outline-container-org537ffde" class="outline-4">
<h4 id="triggers-demo"><a id="org537ffde"></a><span class="section-number-4">7.1.5</span> <span class="done DONE">DONE</span> Triggers Demo</h4>
<div class="outline-text-4" id="text-triggers-demo">
<ul class="org-ul">
<li>Before and After; Insert, Delete, and Update</li>
<li>New and Old</li>
<li>Conditions and actions</li>
<li>Triggers enforcing constraints</li>
<li>Trigger chaining</li>
<li>Self-triggering, cycles</li>
<li>Conflicts</li>
<li>Nested trigger invocations</li>
</ul>

<p>
Introduction video used SQL standard
</p>
<ul class="org-ul">
<li>No DBMS implements exact standard</li>
<li>Some deviate considerably
<ul class="org-ul">
<li>In both syntax and behavior!</li>
</ul></li>
</ul>

<p>
Postgres &gt; SQLite &gt;&gt; MySQL
</p>

<p>
Postgres
</p>
<ul class="org-ul">
<li>Expressiveness/behavior = full standard
row-level + statement-level, old/new row &amp; table</li>
<li>Cumbersome &amp; awkward syntax</li>
</ul>

<p>
SQLite
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table</li>
</ul>

<p>
MySQL
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table</li>
<li>Only one trigger per event type</li>
<li>Limited trigger chaining</li>
</ul>


<p>
SQLite - row-level triggers, immediate activation
</p>
<ul class="org-ul">
<li><code>For Each Row</code> implicit if not specified</li>
<li>No <code>Old Table</code> or <code>New Table</code></li>
<li>No <code>Referencing</code> clause
<ul class="org-ul">
<li><code>Old</code> and <code>New</code> predefined for <code>Old Row</code> and <code>New Row</code></li>
</ul></li>
<li>Trigger action: SQL statements in <code>begin-end</code> block</li>
</ul>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.GPA &gt; 3.3 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.GPA &lt;= 3.6
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'Stanford'</span>, <span class="org-string">'geology'</span>, <span class="org-keyword">null</span>);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> cName = <span class="org-keyword">New</span>.cName
    <span class="org-keyword">where</span> cName = <span class="org-keyword">Old</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R4</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R5</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R6</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName) &gt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = cName || <span class="org-string">'-Done'</span>
    <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>               <span class="org-comment">-- alternative version using after</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">AutoAccept</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">New</span>.cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span>
      3.7 &lt; (<span class="org-keyword">select</span> GPA <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID) <span class="org-keyword">and</span>
      1200 &lt; (<span class="org-keyword">select</span> sizeHS <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID))
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>
    <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID
          <span class="org-keyword">and</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">TooMany</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> enrollment <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">Old</span>.enrollment &lt;= 16000 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.enrollment &gt; 16000)
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName <span class="org-keyword">and</span> major = <span class="org-string">'EE'</span>;
    <span class="org-keyword">update</span> Apply
        <span class="org-keyword">set</span> decision = <span class="org-string">'U'</span>
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName
              <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>


<p>
self-triggering
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The above query won&rsquo;t enter infinite loop since SQLite disallow a
trigger to be triggered more than once in a trigger processing
session.  But if we like, we can turn on <code>recursive_triggers</code> on.
</p>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
trigger each other in a cycle
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 100
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 2;
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> T1 <span class="org-keyword">where</span> A = 2)
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 3;
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The second trigger is executed first in SQLite.
</p>


<p>
nested trigger invocation
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (1);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (2);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (2);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (3);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
immediate activation semantics of SQLite for triggers
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">select</span> <span class="org-builtin">avg</span>(A) <span class="org-keyword">from</span> T1;
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7441f29" class="outline-3">
<h3 id="org7441f29"><span class="section-number-3">7.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-org491ee8b" class="outline-4">
<h4 id="org491ee8b"><span class="section-number-4">7.2.1</span> <span class="done DONE">DONE</span> Constraints and Triggers</h4>
<div class="outline-text-4" id="text-7-2-1">
</div>
</div>
<div id="outline-container-org213dd1d" class="outline-4">
<h4 id="org213dd1d"><span class="section-number-4">7.2.2</span> <span class="done DONE">DONE</span> SQL Social-Network Triggers</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">FriendSameGrade</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.<span class="org-keyword">name</span> = <span class="org-string">'Friendly'</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Likes
  <span class="org-keyword">select</span> <span class="org-keyword">New</span>.ID, ID
  <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> grade = <span class="org-keyword">New</span>.grade <span class="org-keyword">and</span> ID &lt;&gt; <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &lt; 9 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = <span class="org-keyword">null</span>
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade <span class="org-keyword">is</span> <span class="org-keyword">null</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = 9
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend1</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID1;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">or</span> <span class="org-keyword">ignore</span> <span class="org-keyword">into</span> Friend
  <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.ID2, <span class="org-keyword">New</span>.ID1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">GoUpOneGrade</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.grade + 1 = <span class="org-keyword">New</span>.grade
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = grade + 1
  <span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend
               <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Unfriend</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Likes
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.ID1 = <span class="org-keyword">New</span>.ID1 <span class="org-keyword">and</span> <span class="org-keyword">Old</span>.ID2 &lt;&gt; <span class="org-keyword">New</span>.ID2
     <span class="org-keyword">and</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ((ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
         <span class="org-keyword">or</span> (ID1 = <span class="org-keyword">New</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID2));
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org175ec68" class="outline-2">
<h2 id="views-and-authorization-mini-course"><a id="org175ec68"></a><span class="section-number-2">8</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> <a href="https://lagunita.stanford.edu/courses/DB/Views/SelfPaced/courseware/ch-views/">Views and Authorization</a> mini-course</h2>
<div class="outline-text-2" id="text-views-and-authorization-mini-course">
</div>
<div id="outline-container-orgb9bc388" class="outline-3">
<h3 id="views-and-authorization-mini-course-lectures"><a id="orgb9bc388"></a><span class="section-number-3">8.1</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-views-and-authorization-mini-course-lectures">
</div>
<div id="outline-container-org1441aa8" class="outline-4">
<h4 id="defining-and-using-views"><a id="org1441aa8"></a><span class="section-number-4">8.1.1</span> <span class="done DONE">DONE</span> Defining and Using Views</h4>
<div class="outline-text-4" id="text-defining-and-using-views">
<p>
Three-level vision of database
</p>
<ul class="org-ul">
<li>Physical - Conceptual - Logical</li>
</ul>

<p>
Why use views?
</p>
<ul class="org-ul">
<li>Hide some data from some users</li>
<li>Make some queries easier/more natural</li>
<li>Modularity of database access</li>
</ul>

<p>
Real applications tend to use lots and lots (and lots and lots!) of
views
</p>

<p>
Defining and using views
</p>
<ul class="org-ul">
<li>View \(V = \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n)\)</li>
<li>Schema of \(V\) is schema of query result</li>
<li><p>
Query \(Q\) involving \(V\), conceptually:
</p>
\begin{align*}
    &V := \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n) \\
    &\mathrm{Evaluate}\ Q
\end{align*}</li>
<li>In reality, \(Q\) rewritten to use \(R_1, \dotsc, R_n\) instead of \(V\)</li>
<li>Notes: \(R_i\) could itself be a view</li>
</ul>

<p>
SQL Syntax
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">View</span> <span class="org-function-name">Vname</span> <span class="org-keyword">as</span>
&lt;Query&gt;

<span class="org-keyword">Create</span> <span class="org-keyword">View</span> <span class="org-function-name">Vname</span>(A1, A2, ..., An) <span class="org-keyword">As</span>
&lt;Query&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
The above query is conceptually equivalent to the following.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">temporary</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;

<span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, T
<span class="org-keyword">where</span> Student.sID = T.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;

<span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>;
</pre>
</div>

<p>
Some simple RDBMS often rewrites as the following.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Stuent.sID, sName, GPA
<span class="org-keyword">from</span> Student,
     (<span class="org-keyword">select</span> sID, cName <span class="org-keyword">from</span> Apply
      <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>) <span class="org-keyword">as</span> CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
More powerful RDBMS rewrites as the following.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
      <span class="org-keyword">and</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
Views that use other views
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSberk</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> sizeHS &gt; 500;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> * <span class="org-keyword">from</span> CSberk <span class="org-keyword">where</span> GPA &gt; 3.8;
</pre>
</div>

<p>
Naive rewrite
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> * <span class="org-keyword">from</span>
(<span class="org-keyword">select</span> Student.sID, sName, GPA
 <span class="org-keyword">from</span> Student, (<span class="org-keyword">select</span> sID, cName <span class="org-keyword">from</span> Apply
                <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>) <span class="org-keyword">as</span> CSaccept
 <span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> sizeHS &gt; 500) CSberk
<span class="org-keyword">where</span> GPA &gt; 3.8;
</pre>
</div>

<p>
Flattened rewrite
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
      <span class="org-keyword">and</span> Student.sID = Apply.sID <span class="org-keyword">and</span> Apply.cName = <span class="org-string">'Berkeley'</span>
      <span class="org-keyword">and</span> sizeHS &gt; 500 <span class="org-keyword">and</span> GPA &gt; 3.8;
</pre>
</div>

<p>
The following will result in an error under PostgreSQL since other objects depend on
<code>CSaccept</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept</span>;
</pre>
</div>

<p>
However, under both SQLite and MySQL, the error is not thrown until we
try tot use <code>CSberk</code>.
</p>

<p>
The following probably won&rsquo;t be what you want to do for large
database.  Additionally, this is what Martin Fowler might refer to as
natural aggregate.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Mega</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> College.cName, <span class="org-keyword">state</span>, enrollment,
       Student.sID, sName, GPA, sizeHS, major, decision
<span class="org-keyword">from</span> College, Student, Apply
<span class="org-keyword">where</span> College.cName = Apply.cName <span class="org-keyword">and</span> Student.sID = Apply.sID;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> sID, sName, GPA, cName
<span class="org-keyword">from</span> Mega
<span class="org-keyword">where</span> GPA &gt; 3.5 <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> enrollment &gt; 15000;
</pre>
</div>

<p>
Flattened rewrite
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA, College.cName
<span class="org-keyword">from</span> College, Student, Apply
<span class="org-keyword">where</span> College.cName = Apply.cName <span class="org-keyword">and</span> Student.sID = Apply.sID
      <span class="org-keyword">and</span> GPA &gt; 3.5 <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> enrollment &gt; 15000;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8a8f5b5" class="outline-4">
<h4 id="views-modifications-introduction"><a id="org8a8f5b5"></a><span class="section-number-4">8.1.2</span> <span class="done DONE">DONE</span> View Modifications - Introduction</h4>
<div class="outline-text-4" id="text-views-modifications-introduction">
<p>
Querying views
</p>
<ul class="org-ul">
<li>Once \(V\) defined, can reference \(V\) like any table</li>
<li>Queries involving \(V\) rewritten to use base tables</li>
</ul>

<p>
Modifying views
</p>
<ul class="org-ul">
<li>Once \(V\) defined, can we modify \(V\) like any table?</li>
<li>Doesn&rsquo;t make sense: \(V\) is not stored</li>
<li>Has to make sense: views are some users&rsquo; entire &ldquo;view&rdquo; of the
database</li>
<li>Solution: Modifications to \(V\) rewritten to modify base tables</li>
</ul>

<p>
Usually there are successful translations for view modifications.  The
problem is there are too many and which one the user intends.
</p>

<p>
Suppose we have the following schema.
</p>
\begin{align*}
  & R(A, B) \\
  & V = \Pi_A(R)
\end{align*}

<p>
The table \(R\) has \((1, 2)\) and thus \(V = (1)\).  Say the user wants to
insert \(3\) into \(V\).  Then the attribute \(B\) is undecided for the
newly inserted tuple.
</p>

<p>
A more radical example follows.
</p>
\begin{align*}
  & R(N) = \{ (1), (3), (5) \} \\
  & V = \operatorname{avg}(N) = \{ (3) \}
\end{align*}

<p>
And the user wants to update the average to \(7\), then there are so
many ways to update \(R\) to achieve this.
</p>

<p>
Existent systems do things quite differently.  There are several
approaches.
</p>
<ol class="org-ol">
<li>Rewriting process specified explicitly by view creator
<ul class="org-ul">
<li>+ Can handle all modifications</li>
<li> No guarantee of correctness (or meaningfulness)</li>
</ul></li>
<li>Restrict views + modifications so that translation to base table
modifications is meaningful and unambiguous
<ul class="org-ul">
<li>+ No user intervention</li>
<li> Restrictions are significant</li>
</ul></li>
</ol>

<p>
The first approach is enabled by <code>instead of</code> triggers or rules in
Postgres&rsquo; parlance.  The second approach is actually adopted by SQL
standard.
</p>
</div>
</div>

<div id="outline-container-org1da9940" class="outline-4">
<h4 id="views-modifications-using-triggers"><a id="org1da9940"></a><span class="section-number-4">8.1.3</span> <span class="done DONE">DONE</span> View Modifications Using Triggers</h4>
<div class="outline-text-4" id="text-views-modifications-using-triggers">
<p>
Unlike queries, view modifications cannot be automated in general.
</p>

<p>
The following query will result in an error in SQLite, since it
doesn&rsquo;t allow update to views.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> CSaccept <span class="org-keyword">where</span> sID = 123;
</pre>
</div>

<p>
We can create <code>instead of</code> triggers to achieve it.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSacceptDelete</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> CSaccept
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
  <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID
        <span class="org-keyword">and</span> cName = <span class="org-keyword">Old</span>.cName
        <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
Now it works.
</p>

<p>
Of course, I also need an <code>instead of</code> trigger for the following query
to work.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> CSaccept <span class="org-keyword">set</span> cName = <span class="org-string">'CMU'</span> <span class="org-keyword">where</span> sID = 345;
</pre>
</div>

<p>
An example of erroneous <code>instead of</code> trigger
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSacceptUpdate</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> CSaccept
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Apply
  <span class="org-keyword">set</span> cName = <span class="org-keyword">New</span>.cName
  <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID
        <span class="org-keyword">and</span> cName = <span class="org-keyword">Old</span>.cName
        <span class="org-comment">-- correct condition should be</span>
        <span class="org-comment">--     and major = 'CS' and decision = 'Y';</span>
        <span class="org-keyword">and</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSEE</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> major = <span class="org-string">'EE'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (111, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
</pre>
</div>

<p>
Another example of erroneous <code>instead of</code> trigger
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSEEinsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> CSEE
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-keyword">New</span>.cName, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
What if we do the following?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (222, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>);
</pre>
</div>

<p>
Better trigger follows.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSEEinsert</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span>  <span class="org-function-name">CSEEinsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> CSEE
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> <span class="org-keyword">New</span>.major = <span class="org-string">'EE'</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-keyword">New</span>.cName, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
This time, the following query won&rsquo;t insert data into Apply table.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>);
</pre>
</div>

<p>
The following will successfully insert data into the underlying Apply
table.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>);
</pre>
</div>

<p>
When a view involves aggregation, it is generally a good idea to
disallow user to modify views.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">HSgpa</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sizeHS, <span class="org-builtin">avg</span>(gpa) <span class="org-keyword">as</span> avgGPA
<span class="org-keyword">from</span> Student
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sizeHS;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Majors</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> major <span class="org-keyword">from</span> Apply;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">NonUnique</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student S1
<span class="org-keyword">where</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student S2
              <span class="org-keyword">where</span> S1.sID &lt;&gt; S2.sID
                    <span class="org-keyword">and</span> S2.GPA = S1.GPA <span class="org-keyword">and</span> S2.sizeHS = S1.sizeHS);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Berk</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkInsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Berk
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student)
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'Berkeley'</span>, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Berk
<span class="org-keyword">select</span> sID, <span class="org-string">'psychology'</span> <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>);
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkDelete</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> BerkDelete
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
  <span class="org-keyword">where</span> sID = <span class="org-keyword">old</span>.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> major = <span class="org-keyword">Old</span>.major;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Berk <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkUpdate</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> major <span class="org-keyword">on</span> Berk
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Apply
  <span class="org-keyword">set</span> major = <span class="org-keyword">New</span>.major
  <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sId <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> major = <span class="org-keyword">Old</span>.major;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Berk <span class="org-keyword">set</span> major = <span class="org-string">'physics'</span> <span class="org-keyword">where</span> major = <span class="org-string">'psychology'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
);
</pre>
</div>

<p>
Now we cannot insert into the CSEE view.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">unique</span>(sID, cName, major)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Berk <span class="org-keyword">values</span> (123, <span class="org-string">'EE'</span>);          <span class="org-comment">-- failed.</span>
<span class="org-keyword">update</span> Berk <span class="org-keyword">set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfcb0a42" class="outline-4">
<h4 id="automatic-view-modifications"><a id="orgfcb0a42"></a><span class="section-number-4">8.1.4</span> <span class="done DONE">DONE</span> Automatic View Modifications</h4>
<div class="outline-text-4" id="text-automatic-view-modifications">
<p>
Restrictions in SQL Standard for &ldquo;updatable views&rdquo;:
</p>
<ol class="org-ol">
<li><code>select</code> (no <code>distinct</code>) on single table <code>T</code></li>
<li>Attributes not in view can be <code>null</code> or have default value</li>
<li>Subqueries must not refer to <code>T</code></li>
<li>No <code>group by</code> or aggregation</li>
</ol>

<p>
MySQL is the only database (among MySQL, SQLite, and PostgreSQL) that
supports automatic view modifications.  However, it is a little bit
more generous than the SQL standard.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (111, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (222, <span class="org-string">'Berkeley'</span>, <span class="org-string">'psychology'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSaccept <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>);
</pre>
</div>

<p>
All of the above queries will succeed.  The second query will insert a
row with <code>'psychology'</code> major into <code>Apply</code> table, which won&rsquo;t reflect
in the view <code>CSEE</code>.  And the last query will insert a row with <code>null</code>
major and decision into <code>Apply</code> table.  Both of the results are not
what we want.
</p>

<p>
We can fix it like this.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSEE2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> major = <span class="org-string">'EE'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
The <code>delete</code> and <code>insert</code> operations on <code>HSgpa</code> view will fail under
both MySQL and SQL standard, since it contains aggregation.
</p>

<p>
Views with subqueries that does not refer to outer table can be
modified.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Bio</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major <span class="org-keyword">like</span> <span class="org-string">'bio%'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Bio <span class="org-keyword">where</span> sName = <span class="org-string">'Bob'</span>;
</pre>
</div>

<p>
For the above query, both MySQL and SQL standard will delete Bob from
only the <code>Student</code> table, but not from the <code>Apply</code> table.  Of course,
if the database is set up with proper referential integrity
constraints, Bob will be deleted from <code>Apply</code> table due to it.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Bio <span class="org-keyword">values</span> (555, <span class="org-string">'Karen'</span>, 3.9, 1000);
</pre>
</div>

<p>
Karen will be inserted into <code>Student</code> table but won&rsquo;t appear in the
<code>Bio</code> view.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Bio2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major <span class="org-keyword">like</span> <span class="org-string">'bio%'</span>)
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
Now the following query will fail.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Bio2 <span class="org-keyword">values</span> (666, <span class="org-string">'Lori'</span>, 3.9, 1000);
</pre>
</div>

<p>
The <code>with check option</code> comes with an efficiency cost.
</p>

<p>
MySQL does allow some modification on join view, whereas SQL standard
doesn&rsquo;t.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Stan</span>(sID, aID, sName, major) <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, Apply.sID, sName, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Stan <span class="org-keyword">set</span> sName = <span class="org-string">'CS major'</span> <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>;
</pre>
</div>

<p>
The above query succeeds but the following will cause row being
updated to disappear from the view <code>Stan</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Stan <span class="org-keyword">set</span> aID = 666 <span class="org-keyword">where</span> aID = 123;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Stan2</span>(sID, aID, sName, major) <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, Apply.sID, sName, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
Now the same query will fail for view <code>Stan2</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan(sID, sName) <span class="org-keyword">values</span> (777, <span class="org-string">'Lance'</span>);
</pre>
</div>

<p>
The above query will insert Lance only into <code>Student</code> table with
<code>null</code> GPA and high school size.  This is not what we want.  Also, the
same query will fail on view <code>Stan2</code>.  However, by inserting a
correspondent row into <code>Apply</code>, we can make it succeed, as shown
below.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (888, <span class="org-string">'Stanford'</span>, <span class="org-string">'history'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan2(sID, sName) <span class="org-keyword">values</span> (888, <span class="org-string">'Mary'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (999, <span class="org-string">'MIT'</span>, <span class="org-string">'history'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan2(sID, sName) <span class="org-keyword">values</span> (999, <span class="org-string">'Nancy'</span>);
</pre>
</div>

<p>
The second <code>insert</code> query will fail since Nancy doesn&rsquo;t apply to
Stanford.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Stan <span class="org-keyword">where</span> sID = 123;
</pre>
</div>

<p>
We cannot delete from join view under MySQL.
</p>

<p>
Under SQL standard, a view is either updatable or not, meaning that if
a view is updatable, then we can apply <code>insert</code>, <code>delete</code>, <code>update</code> on
it.  However, a view can be partially updatable under MySQL since it
is a little bit more generous.
</p>
</div>
</div>

<div id="outline-container-org4bdda24" class="outline-4">
<h4 id="materialized-views"><a id="org4bdda24"></a><span class="section-number-4">8.1.5</span> <span class="done DONE">DONE</span> Materialized Views</h4>
<div class="outline-text-4" id="text-materialized-views">
<p>
The views discussed in the previous section are sometimes called
virtual views.
</p>

<p>
Materialized views have an additional advantage:
</p>
<ul class="org-ul">
<li>improved query performance.</li>
</ul>

<p>
Materialized views
</p>
<ul class="org-ul">
<li>View \(V = \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n)\)</li>
<li>Create table \(V\) with schema of query result</li>
<li>Execute \(\mathrm{ViewQuery}\) and put results in \(V\)</li>
<li>Queries refer to \(V\) as if it&rsquo;s a table</li>
</ul>

<p>
But&#x2026;
</p>
<ul class="org-ul">
<li>\(V\) could be very large</li>
<li>Modifications to \(R_1, R_2, \dotsc, R_n \Rightarrow\)
<ul class="org-ul">
<li>recompute or modify \(V\)</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> materialized <span class="org-keyword">view</span> <span class="org-function-name">CA</span>-CS <span class="org-keyword">as</span>
<span class="org-keyword">select</span> C.cName, S.sName
<span class="org-keyword">from</span> College C, Student S, Apply A
<span class="org-keyword">where</span> C.cName = A.cName <span class="org-keyword">and</span> S.sID = A.sID
      <span class="org-keyword">and</span> C.<span class="org-keyword">state</span> = <span class="org-string">'CA'</span> <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>

<ul class="org-ul">
<li>+ Can use <code>CA-CS</code> as if it&rsquo;s a table (it is!)</li>
<li> Modifications to base data invalidate view (cf. general
assertions)</li>
</ul>

<p>
Modifications on modifications views?
</p>
<ul class="org-ul">
<li>Good news: just update the stored table</li>
<li>Bad news: base tables must stay in sync
<ul class="org-ul">
<li>Same issues as with virtual views</li>
</ul></li>
</ul>

<p>
Picking which materialized views to create
</p>
<ul class="org-ul">
<li>(Efficiency) benefits of a materialized view depend on:
<ul class="org-ul">
<li>Size of data</li>
<li>Complexity of view</li>
<li>Number of queries using view</li>
<li>Number of modifications affecting view
<ul class="org-ul">
<li>Also &ldquo;incremental maintenance&rdquo; versus full recomputation</li>
</ul></li>
</ul></li>
</ul>

<p>
Query-Update trade off (cf. indexes)
</p>

<p>
Automatic query rewriting to use materialized views
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> materialized <span class="org-keyword">view</span> <span class="org-function-name">CA</span>-Apply <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply A
<span class="org-keyword">where</span> cName <span class="org-keyword">in</span> (<span class="org-keyword">select</span> cName <span class="org-keyword">from</span> College <span class="org-keyword">where</span> <span class="org-keyword">state</span> = <span class="org-string">'CA'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> S.sID, S.GPA
<span class="org-keyword">from</span> College C, Student S, Apply A
<span class="org-keyword">where</span> C.cName = A.cName <span class="org-keyword">and</span> S.sID =A.sID
      <span class="org-keyword">and</span> S.GPA &gt; 3.5 <span class="org-keyword">and</span> C.<span class="org-keyword">state</span> = <span class="org-string">'CA'</span> <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>

<p>
The above query will be rewritten as something like the following.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> S.sID, S.GPA
<span class="org-keyword">from</span> Student S, CA-Apply A
<span class="org-keyword">where</span> S.sID = A.sID <span class="org-keyword">and</span> S.GPA &gt; 3.5 <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc7281d" class="outline-4">
<h4 id="authorization"><a id="orgbc7281d"></a><span class="section-number-4">8.1.6</span> <span class="done DONE">DONE</span> Authorization</h4>
<div class="outline-text-4" id="text-authorization">
<p>
Database Authorization
</p>
<ul class="org-ul">
<li>Make sure users see only the data they&rsquo;re supposed to see</li>
<li>Guard the database against modifications by malicious users</li>
</ul>

<p>
Users have <i>privileges</i> and can only operate on data for which they are
<i>authorized</i>.
</p>
<ul class="org-ul">
<li><code>Select on R</code> or <code>Select(A1, ..., An) on R</code></li>
<li><code>Insert on R</code> or <code>Insert(A1, ..., An) on R</code></li>
<li><code>Update on R</code> or <code>Update(A1, ..., An) on R</code></li>
<li><code>Delete on R</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> <span class="org-type">dec</span> = <span class="org-string">'Y'</span>
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> GPA &gt; 3.9)
</pre>
</div>

<p>
For the above query, we need the following privileges.
</p>
<ul class="org-ul">
<li>Apply: <code>update(dec)</code>, <code>select(sID)</code></li>
<li>Student: <code>select(sID, GPA)</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply)
</pre>
</div>

<ul class="org-ul">
<li>Student: <code>delete</code></li>
<li>Apply: <code>select(sID)</code></li>
</ul>

<p>
<i>Select student info for Stanford applicants only</i>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">SS</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>)
</pre>
</div>

<ul class="org-ul">
<li>SS: <code>select</code></li>
</ul>

<p>
<i>Delete Berkeley applications only</i>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">BA</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>
</pre>
</div>

<ul class="org-ul">
<li>BA: <code>delete</code></li>
</ul>

<p>
Note: Updatable views is required to provide modification privileges
through views
</p>

<p>
In fact, authorization is one of the most important uses of views in database
systems.
</p>

<p>
Obtaining Privileges
</p>
<ul class="org-ul">
<li>Relation creator is <i>owner</i></li>
<li>Owner has all privileges and may <i>grant</i> privileges</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">grant</span> privs <span class="org-keyword">on</span> R <span class="org-keyword">to</span> users
  [<span class="org-keyword">with</span> <span class="org-keyword">grant</span> <span class="org-keyword">option</span>]
</pre>
</div>

<p>
Revoking Privileges
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">revoke</span> privs <span class="org-keyword">on</span> R <span class="org-keyword">from</span> users
  [<span class="org-keyword">cascade</span> | <span class="org-keyword">restrict</span>]
</pre>
</div>

<p>
Cascade: Also revoke privileges granted from privileges being revoked
(transitively), unless also granted from antoher source.
</p>

<p>
Restrict: Disallow if <i>Cascade</i> would revoke any other
privileges. (This is the default.)
</p>
</div>
</div>
</div>

<div id="outline-container-orgcb5f8db" class="outline-3">
<h3 id="views-and-authorization-mini-course-exercises"><a id="orgcb5f8db"></a><span class="section-number-3">8.2</span> <span class="todo TODO">TODO</span> Exercises</h3>
<div class="outline-text-3" id="text-views-and-authorization-mini-course-exercises">
</div>
<div id="outline-container-org0aee223" class="outline-4">
<h4 id="views-quiz"><a id="org0aee223"></a><span class="section-number-4">8.2.1</span> <span class="todo TODO">TODO</span> Views Quiz</h4>
<div class="outline-text-4" id="text-views-quiz">
</div>
</div>
<div id="outline-container-org7c43210" class="outline-4">
<h4 id="authorization-quiz"><a id="org7c43210"></a><span class="section-number-4">8.2.2</span> <span class="todo TODO">TODO</span> Authorization Quiz</h4>
<div class="outline-text-4" id="text-authorization-quiz">
</div>
</div>
<div id="outline-container-org04d0719" class="outline-4">
<h4 id="sql-movie-rating-view-modification"><a id="org04d0719"></a><span class="section-number-4">8.2.3</span> <span class="todo TODO">TODO</span> SQL Movie-Rating View Modification</h4>
<div class="outline-text-4" id="text-sql-movie-rating-view-modification">
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Lei Zhao</p>
<p class="date">Created: 2017-12-30 Sat 13:27</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
