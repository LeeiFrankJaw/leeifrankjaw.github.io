<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-12-29 Fri 23:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Intro to DB</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Lei Zhao" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link type="text/css" href="../styles/syntax-highlight.css" rel="stylesheet"/>
<link type="text/css" href="../styles/layout.css" rel="stylesheet"/>
<script type="text/javascript" src="../src/post.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Intro to DB</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1d4a531">1. <span class="done DONE">DONE</span> SQL mini-course</a>
<ul>
<li><a href="#orgfffc712">1.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#org6f0d513">1.1.1. <span class="done DONE">DONE</span> The Join family of Operators</a></li>
<li><a href="#orgbf065f6">1.1.2. <span class="done DONE">DONE</span> Aggregation</a></li>
<li><a href="#org43c1bec">1.1.3. <span class="done DONE">DONE</span> NULL values</a></li>
<li><a href="#org74ff35d">1.1.4. <span class="done DONE">DONE</span> Data Modification Statements</a></li>
</ul>
</li>
<li><a href="#orgd662949">1.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org379c402">1.2.1. <span class="done DONE">DONE</span> Movie-Rating Query Core</a></li>
<li><a href="#org8d53610">1.2.2. <span class="done DONE">DONE</span> Movie-Rating Query Extras</a></li>
<li><a href="#org9096038">1.2.3. <span class="done DONE">DONE</span> Social-Network Query Core</a></li>
<li><a href="#org15ef96b">1.2.4. <span class="done DONE">DONE</span> Social-Network Query Extras</a></li>
<li><a href="#org5782072">1.2.5. <span class="done DONE">DONE</span> Movie-Rating Modification</a></li>
<li><a href="#org58ff4d7">1.2.6. <span class="done DONE">DONE</span> Social-Network Modification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xpath-and-xquery-mini-course">2. <span class="done DONE">DONE</span> XPath and XQuery mini-course</a>
<ul>
<li><a href="#orga33a09e">2.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#xpath-introduction">2.1.1. <span class="done DONE">DONE</span> XPath Introduction</a></li>
<li><a href="#xpath-demo">2.1.2. <span class="done DONE">DONE</span> XPath Demo</a></li>
<li><a href="#xquery-introduction">2.1.3. <span class="done DONE">DONE</span> XQuery Introduction</a></li>
<li><a href="#xquery-demo">2.1.4. <span class="done DONE">DONE</span> XQuery Demo</a></li>
</ul>
</li>
<li><a href="#orgdc5af5d">2.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#course-catalog-xpath-and-xquery">2.2.1. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery</a></li>
<li><a href="#course-catalog-xpath-and-xquery-extras">2.2.2. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Extras</a></li>
<li><a href="#world-countries-xpath-and-xquery">2.2.3. <span class="done DONE">DONE</span> World-Countries XPath and XQuery</a></li>
<li><a href="#world-countries-xpath-and-xquery-extras">2.2.4. <span class="done DONE">DONE</span> World-Countries XPath and XQuery Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xslt-mini-course">3. <span class="done DONE">DONE</span> XSLT mini-course</a>
<ul>
<li><a href="#xslt-mini-course-lectures">3.1. <span class="done DONE">DONE</span> Lecture videos</a></li>
<li><a href="#org592265c">3.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#course-catalog-xslt">3.2.1. <span class="done DONE">DONE</span> Course-Catalog XSLT</a></li>
<li><a href="#course-catalog-xslt-extras">3.2.2. <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</a></li>
<li><a href="#world-countries-xslt">3.2.3. <span class="done DONE">DONE</span> World-Countries XSLT</a></li>
<li><a href="#world-countries-xslt-extras">3.2.4. <span class="done DONE">DONE</span> World-Countries XSLT Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#relational-design-theory-mini-course">4. <span class="done DONE">DONE</span> Relational Design Theory mini-course</a>
<ul>
<li><a href="#relational-design-theory-mini-course-lectures">4.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#org05625ab">4.1.1. <span class="done DONE">DONE</span> Overview</a></li>
<li><a href="#functional-dependencies">4.1.2. <span class="done DONE">DONE</span> Functional Dependencies</a></li>
<li><a href="#boyce-codd-normal-form">4.1.3. <span class="done DONE">DONE</span> Boyce-Codd Normal Form</a></li>
<li><a href="#multivalued-dependencies-and-4th-normal-form">4.1.4. <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</a></li>
<li><a href="#org906691f">4.1.5. <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</a></li>
</ul>
</li>
<li><a href="#relational-design-theory-mini-course-exercises">4.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#uml-mini-course">5. <span class="done DONE">DONE</span> Unified Modeling Language mini-course</a>
<ul>
<li><a href="#org6c5d8d8">5.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#uml-data-modeling">5.1.1. <span class="done DONE">DONE</span> UML Data Modeling</a></li>
<li><a href="#org9f6c3c1">5.1.2. <span class="done DONE">DONE</span> UML to Relations</a></li>
</ul>
</li>
<li><a href="#org36ed050">5.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#orgda65a8e">6. <span class="done DONE">DONE</span> Indexes and Transactions mini-course</a>
<ul>
<li><a href="#org3819964">6.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#orge9873c6">6.1.1. <span class="done DONE">DONE</span> Indexes</a></li>
<li><a href="#org56260cb">6.1.2. <span class="done DONE">DONE</span> Introduction to Transactions</a></li>
<li><a href="#org0b13657">6.1.3. <span class="done DONE">DONE</span> Transaction Properties</a></li>
<li><a href="#org3604f8b">6.1.4. <span class="done DONE">DONE</span> Isolation Levels</a></li>
</ul>
</li>
<li><a href="#org4e1aac3">6.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org8103cc1">6.2.1. <span class="done DONE">DONE</span> Index Quiz</a></li>
<li><a href="#orgadd34de">6.2.2. <span class="done DONE">DONE</span> Transaction Quiz</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org44099e0">7. <span class="done DONE">DONE</span> Constraints and Triggers mini-course</a>
<ul>
<li><a href="#orgc2d2801">7.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#orge57a2bc">7.1.1. <span class="done DONE">DONE</span> Motivation and Overview</a></li>
<li><a href="#orgba9516a">7.1.2. <span class="done DONE">DONE</span> Constraints of Several Types</a></li>
<li><a href="#org6297c7e">7.1.3. <span class="done DONE">DONE</span> Referential Integrity</a></li>
<li><a href="#org9149f74">7.1.4. <span class="done DONE">DONE</span> Triggers Introduction</a></li>
<li><a href="#orga0fbef4">7.1.5. <span class="done DONE">DONE</span> Triggers Demo</a></li>
</ul>
</li>
<li><a href="#org81204d0">7.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#orgad623f0">7.2.1. <span class="done DONE">DONE</span> Constraints and Triggers</a></li>
<li><a href="#org03c4999">7.2.2. <span class="done DONE">DONE</span> SQL Social-Network Triggers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#views-and-authorization-mini-course">8. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Views and Authorization mini-course</a>
<ul>
<li><a href="#views-and-authorization-mini-course-lectures">8.1. <span class="todo IN_PROGRESS">IN-PROGRESS</span> Lecture Videos</a>
<ul>
<li><a href="#defining-and-using-views">8.1.1. <span class="done DONE">DONE</span> Defining and Using Views</a></li>
<li><a href="#views-modifications-introduction">8.1.2. <span class="done DONE">DONE</span> View Modifications - Introduction</a></li>
<li><a href="#views-modifications-using-triggers">8.1.3. <span class="done DONE">DONE</span> View Modifications Using Triggers</a></li>
<li><a href="#automatic-view-modifications">8.1.4. <span class="done DONE">DONE</span> Automatic View Modifications</a></li>
<li><a href="#materialized-views">8.1.5. <span class="done DONE">DONE</span> Materialized Views</a></li>
<li><a href="#authorization">8.1.6. <span class="done DONE">DONE</span> Authorization</a></li>
</ul>
</li>
<li><a href="#views-and-authorization-mini-course-exercises">8.2. <span class="todo TODO">TODO</span> Exercises</a>
<ul>
<li><a href="#views-quiz">8.2.1. <span class="todo TODO">TODO</span> Views Quiz</a></li>
<li><a href="#authorization-quiz">8.2.2. <span class="todo TODO">TODO</span> Authorization Quiz</a></li>
<li><a href="#sql-movie-rating-view-modification">8.2.3. <span class="todo TODO">TODO</span> SQL Movie-Rating View Modification</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<a href="https://lagunita.stanford.edu/courses/DB/2014/SelfPaced/about">Database</a> on Lagunita<br />
</p>

<div id="outline-container-org1d4a531" class="outline-2">
<h2 id="org1d4a531"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/">SQL</a> mini-course</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgfffc712" class="outline-3">
<h3 id="orgfffc712"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org6f0d513" class="outline-4">
<h4 id="org6f0d513"><span class="section-number-4">1.1.1</span> <span class="done DONE">DONE</span> The Join family of Operators</h4>
<div class="outline-text-4" id="text-1-1-1">
</div>
</div>
<div id="outline-container-orgbf065f6" class="outline-4">
<h4 id="orgbf065f6"><span class="section-number-4">1.1.2</span> <span class="done DONE">DONE</span> Aggregation</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student;

<span class="org-keyword">select</span> <span class="org-builtin">min</span>(GPA)
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span>;

<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> College
<span class="org-keyword">where</span> enrollment &gt; 15000;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>)) -
       (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>));

<span class="org-keyword">select</span> cName, <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName;

<span class="org-keyword">select</span> <span class="org-keyword">state</span>, <span class="org-builtin">sum</span>(enrollment)
<span class="org-keyword">from</span> College
<span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">state</span>;

<span class="org-keyword">select</span> cName, major, <span class="org-builtin">max</span>(mx - mn)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> cName, major, <span class="org-builtin">min</span>(GPA) <span class="org-keyword">as</span> mn, <span class="org-builtin">max</span>(GPA) <span class="org-keyword">as</span> mx
      <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> cName, major) <span class="org-keyword">M</span>;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span>
     (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, cName
      <span class="org-keyword">from</span> Apply) <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">left</span> <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
<span class="org-keyword">union</span>
<span class="org-keyword">select</span> sID, sName, 0
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &lt; 5;

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> cName <span class="org-keyword">from</span> Apply) S
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = S.cName) &lt; 5;


<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID) &lt; 5;

<span class="org-keyword">select</span> major
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> major
<span class="org-keyword">having</span> <span class="org-builtin">max</span>(GPA) &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student);
</pre>
</div>
</div>
</div>

<div id="outline-container-org43c1bec" class="outline-4">
<h4 id="org43c1bec"><span class="section-number-4">1.1.3</span> <span class="done DONE">DONE</span> NULL values</h4>
<div class="outline-text-4" id="text-1-1-3">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> sID, sName, GPA
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> GPA &gt; 3.5 <span class="org-keyword">or</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">null</span>;

<span class="org-keyword">select</span> sID, sName, GPA, sizeHS
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> sizeHS &lt; 1600 <span class="org-keyword">or</span> sizeHS &gt;= 1600;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
</pre>
</div>
<p>
SQL uses three-valued logic (<a href="https://en.wikipedia.org/wiki/Three-valued_logic">3VL</a>).<br />
</p>
</div>
</div>

<div id="outline-container-org74ff35d" class="outline-4">
<h4 id="org74ff35d"><span class="section-number-4">1.1.4</span> <span class="done DONE">DONE</span> Data Modification Statements</h4>
<div class="outline-text-4" id="text-1-1-4">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College
<span class="org-keyword">values</span> (<span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'PA'</span>, 11500);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'EE'</span>, <span class="org-string">'Y'</span>
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName &lt;&gt; <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      decision = <span class="org-string">'N'</span>;

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College
<span class="org-keyword">where</span> cName <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> cName
                    <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'economics'</span>,
    decision = <span class="org-string">'Y'</span>
<span class="org-keyword">where</span> cName = <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> GPA &lt; 3.6);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'CSE'</span>
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA)
                           <span class="org-keyword">from</span> Apply <span class="org-keyword">join</span> Student <span class="org-keyword">using</span>(sID)
                           <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA &gt;= <span class="org-keyword">all</span> (<span class="org-keyword">select</span> GPA
                                <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
                                <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">update</span> Student
<span class="org-keyword">set</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA) <span class="org-keyword">from</span> Student),
    sizeHS = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(sizeHS) <span class="org-keyword">from</span> Student);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd662949" class="outline-3">
<h3 id="orgd662949"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org379c402" class="outline-4">
<h4 id="org379c402"><span class="section-number-4">1.2.1</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Find the titles of all movies directed by Steven Spielberg.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director = <span class="org-string">'Steven Spielberg'</span>;
</pre>
</div>

<p>
Find all years that have a movie that received a rating of 4 or 5, and<br />
sort them in increasing order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">year</span>
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> stars &gt;= 4)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">year</span>;
</pre>
</div>

<p>
Find the titles of all movies that have no ratings.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
Some reviewers didn't provide a date with their rating.  Find the<br />
names of all reviewers who have ratings with a NULL value for the<br />
date.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> ratingDate <span class="org-keyword">is</span> <span class="org-keyword">null</span>);
</pre>
</div>

<p>
Write a query to return the ratings data in a more readable format:<br />
reviewer name, movie title, stars, and ratingDate.  Also, sort the<br />
data, first by reviewer name, then by movie title, and lastly by<br />
number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars, ratingDate
<span class="org-keyword">from</span> Reviewer <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>, title, stars;
</pre>
</div>

<p>
For all cases where the same reviewer rated the same movie twice and<br />
gave it a higher rating the second time, return the reviewer's name<br />
and the title of the movie.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID, mID
      <span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Rating R2 <span class="org-keyword">using</span>(rID, mID)
      <span class="org-keyword">where</span> R1.stars &gt; R2.stars <span class="org-keyword">and</span>
            R1.ratingDate &gt; R2.ratingDate <span class="org-keyword">and</span>
            (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Rating
             <span class="org-keyword">where</span> rID = R1.rID <span class="org-keyword">and</span> mID = R1.mID) = 2)
      <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID);
</pre>
</div>

<p>
For each movie that has at least one rating, find the highest number<br />
of stars that movie received.  Return the movie title and number of<br />
stars.  Sort by movie title.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, <span class="org-builtin">max</span>(stars)
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> mID
<span class="org-keyword">order</span> <span class="org-keyword">by</span> title;
</pre>
</div>

<p>
For each movie, return the title and the 'rating spread', that is, the<br />
difference between highest and lowest ratings given to that movie.<br />
Sort by rating spread from highest to lowest, then by movie title.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, spread
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">max</span>(stars) - <span class="org-builtin">min</span>(stars) <span class="org-keyword">as</span> spread
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> spread <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the difference between the average rating of movies released<br />
before 1980 and the average rating of movies released after 1980.<br />
(Make sure to calculate the average rating for each movie, then the<br />
average of those averages for movies before 1980 and movies after.<br />
Don't just calculate the overall average rating before and after<br />
1980.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span>
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &lt; 1980) -
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &gt;= 1980);
</pre>
</div>
</div>
</div>
<div id="outline-container-org8d53610" class="outline-4">
<h4 id="org8d53610"><span class="section-number-4">1.2.2</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Find the names of all reviewers who rated Gone with the Wind.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> mID = (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Movie
                           <span class="org-keyword">where</span> title = <span class="org-string">'Gone with the Wind'</span>));
</pre>
</div>

<p>
For any rating where the reviewer is the same as the director of the<br />
movie, return the reviewer name, movie title, and number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> director = <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Return all reviewer names and movie names together in a single list,<br />
alphabetized.  (Sorting by the first name of the reviewer and first<br />
word in the title is fine; no need for special processing on last<br />
names or removing "The".)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Reviewer
      <span class="org-keyword">union</span>
      <span class="org-keyword">select</span> title <span class="org-keyword">as</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Movie)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Find the titles of all movies not reviewed by Chris Jackson.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating
                  <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer
                                <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Chris Jackson'</span>));
</pre>
</div>

<p>
For all pairs of reviewers such that both reviewers gave a rating to<br />
the same movie, return the names of both reviewers.  Eliminate<br />
duplicates, don't pair reviewers with themselves, and include each<br />
pair only once.  For each pair, return the names in the pair in<br />
alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R1.<span class="org-keyword">name</span>, R2.<span class="org-keyword">name</span>
<span class="org-keyword">from</span> (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R1 <span class="org-keyword">join</span>
     (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R2
<span class="org-keyword">on</span> R1.mID = R2.mID <span class="org-keyword">and</span>
   R1.rID &lt;&gt; R2.rID <span class="org-keyword">and</span>
   R1.<span class="org-keyword">name</span> &lt;= R2.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each rating that is the lowest (fewest stars) currently in the<br />
database, return the reviewer name, movie title, and number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Reviewer R2 <span class="org-keyword">join</span> Movie <span class="org-keyword">M</span>
<span class="org-keyword">on</span> R1.rID = R2.rID <span class="org-keyword">and</span>
   R1.mID = <span class="org-keyword">m</span>.mID <span class="org-keyword">and</span>
   stars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(stars) <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
List movie titles and average ratings, from highest-rated to<br />
lowest-rated.  If two or more movies have the same average rating,<br />
list them in alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, avgStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> avgStars <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the names of all reviewers who have contributed three or more<br />
ratings.  (As an extra challenge, try writing the query without HAVING<br />
or without COUNT.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
      <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3)
     <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3;

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating R
              <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                            <span class="org-keyword">from</span> Rating S
                            <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                  (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                   stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                  rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                                          <span class="org-keyword">from</span> Rating
                                          <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                                (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                                (mID &lt;&gt; S.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; S.stars))));
</pre>
</div>

<p>
Some directors directed more than one movie.  For all such directors,<br />
return the titles of all movies directed by them, along with the<br />
director name.  Sort by director name, then movie title.  (As an extra<br />
challenge, try writing the query both with and without COUNT.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">group</span> <span class="org-keyword">by</span> director
                   <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;

<span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">where</span> director = R.director <span class="org-keyword">and</span>
                         mID &lt;&gt; R.mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;
</pre>
</div>

<p>
Find the movie(s) with the highest average rating. Return the movie<br />
title(s) and average rating.  (Hint: This query is more difficult to<br />
write in SQLite than other systems; you might think of it as finding<br />
the highest average rating and then choosing the movie(s) with that<br />
average rating.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
Find the movie(s) with the lowest average rating.  Return the movie<br />
title(s) and average rating.  (Hint: This query may be more difficult<br />
to write in SQLite than other systems; you might think of it as<br />
finding the lowest average rating and then choosing the movie(s) with<br />
that average rating.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
For each director, return the director's name together with the<br />
title(s) of the movie(s) they directed that received the highest<br />
rating among all of their movies, and the value of that rating.<br />
Ignore movies whose director is NULL.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director, title, maxStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> director,
             (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(stars)
              <span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
              <span class="org-keyword">where</span> director = D.director) <span class="org-keyword">as</span> maxStars
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director <span class="org-keyword">from</span> Movie
            <span class="org-keyword">where</span> director <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>) D)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(director) <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> stars = maxStars;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9096038" class="outline-4">
<h4 id="org9096038"><span class="section-number-4">1.2.3</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
Find the names of all students who are friends with someone named<br />
Gabriel.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
             <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = ID <span class="org-keyword">and</span>
                   ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID
                           <span class="org-keyword">from</span> Highschooler
                           <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Gabriel'</span>));
</pre>
</div>

<p>
For every student who likes someone 2 or more grades younger than<br />
themselves, return that student's name and grade, and the name and<br />
grade of the student they like.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) -
      (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2) &gt;= 2;
</pre>
</div>

<p>
For every pair of students who both like each other, return the name<br />
and grade of both students.  Include each pair only once, with the two<br />
names in alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID1 &lt; ID2
<span class="org-keyword">intersect</span>
<span class="org-keyword">select</span> ID2, ID1
<span class="org-keyword">from</span> Likes;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2)
<span class="org-keyword">from</span> Likes R
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1) &lt;
      (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2) <span class="org-keyword">and</span>
      ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes
              <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span> ID2 = R.ID1);
</pre>
</div>

<p>
Find all students who do not appear in the Likes table (as a student<br />
who likes or is liked) and return their names and grades.  Sort by<br />
grade, then by name within each grade.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes) <span class="org-keyword">and</span>
      ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Likes)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For every situation where student A likes student B, but we have no<br />
information about whom B likes (that is, B does not appear as an ID1<br />
in the Likes table), return A and B's names and grades.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID2 <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes);
</pre>
</div>

<p>
Find names and grades of students who only have friends in the same<br />
grade. Return the result sorted by grade, then by name within each<br />
grade.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
                 <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) &lt;&gt;
                       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2))
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each student A who likes a student B where the two are not<br />
friends, find if they have a friend C in common (who can introduce<br />
them!).  For all such trios, return the name and grade of A, B, and C.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes
      <span class="org-keyword">except</span>
      <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend) T
     <span class="org-keyword">join</span> Highschooler
<span class="org-keyword">on</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID1) <span class="org-keyword">and</span>
   ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID2);
</pre>
</div>

<p>
Find the difference between the number of students in the school and<br />
the number of different first names.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(ID) - <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> <span class="org-keyword">name</span>)
<span class="org-keyword">from</span> Highschooler;
</pre>
</div>

<p>
Find the name and grade of all students who are liked by more than one<br />
other student.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> name2, grade2
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, name1, grade1, ID2, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name2, grade <span class="org-keyword">as</span> grade2
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name1, grade <span class="org-keyword">as</span> grade1, ID2
            <span class="org-keyword">from</span> Likes <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID1 = H.ID)
                 <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID2 = H.ID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID2
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1;
</pre>
</div>
</div>
</div>

<div id="outline-container-org15ef96b" class="outline-4">
<h4 id="org15ef96b"><span class="section-number-4">1.2.4</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
For every situation where student A likes student B, but student B<br />
likes a different student C, return the names and grades of A, B, and<br />
C.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> H1.<span class="org-keyword">name</span>, H1.grade,
       H2.<span class="org-keyword">name</span>, H2.grade,
       H3.<span class="org-keyword">name</span>, H3.grade
<span class="org-keyword">from</span> Likes R <span class="org-keyword">join</span> Likes S
     <span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span>
        S.ID2 &lt;&gt; R.ID1
     <span class="org-keyword">join</span> Highschooler H1
     <span class="org-keyword">on</span> R.ID1 = H1.ID
     <span class="org-keyword">join</span> Highschooler H2
     <span class="org-keyword">on</span> R.ID2 = H2.ID
     <span class="org-keyword">join</span> Highschooler H3
     <span class="org-keyword">on</span> S.ID2 = H3.ID;
</pre>
</div>

<p>
Find those students for whom all of their friends are in different<br />
grades from themselves.  Return the students' names and grades.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler R
<span class="org-keyword">where</span> <span class="org-keyword">not</span> <span class="org-keyword">exists</span>
      (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
       <span class="org-keyword">where</span> ID1 = R.ID <span class="org-keyword">and</span>
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler
        <span class="org-keyword">where</span> ID = ID2 <span class="org-keyword">and</span>
              grade = R.grade));
</pre>
</div>

<p>
What is the average number of friends per student? (Your result should<br />
be just one number.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Friend
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1);
</pre>
</div>

<p>
The above code doesn't consider the situation where there exists a<br />
student who has no friend.  The following code handle that situation<br />
correctly.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Friend
              <span class="org-keyword">where</span> ID1 = ID) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Highschooler);
</pre>
</div>

<p>
Find the number of students who are either friends with Cassandra or<br />
are friends of friends of Cassandra.  Do not count Cassandra, even<br />
though technically she is a friend of a friend.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> <span class="org-keyword">name</span> &lt;&gt; <span class="org-string">'Cassandra'</span> <span class="org-keyword">and</span>
      <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend R
              <span class="org-keyword">where</span> R.ID1 = ID <span class="org-keyword">and</span>
                    (R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                               <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>) <span class="org-keyword">or</span>
                     R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Friend
                               <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span>
                                     ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                                             <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>))));

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, ID2, ID3
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> L1.ID1, L1.ID2, L2.ID2 <span class="org-keyword">as</span> ID3
            <span class="org-keyword">from</span> Friend L1 <span class="org-keyword">join</span> Friend L2
            <span class="org-keyword">on</span> L1.ID2 = L2.ID1 <span class="org-keyword">and</span>
               L2.ID2 &lt;&gt; L1.ID1))
     <span class="org-keyword">join</span> Highschooler R <span class="org-keyword">on</span> ID1 = R.ID
     <span class="org-keyword">join</span> Highschooler S <span class="org-keyword">on</span> ID2 = S.ID
     <span class="org-keyword">join</span> Highschooler T <span class="org-keyword">on</span> ID3 = T.ID
<span class="org-keyword">where</span> S.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span> <span class="org-keyword">or</span> T.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>;
</pre>
</div>

<p>
Find the name and grade of the student(s) with the greatest number of<br />
friends.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1)
<span class="org-keyword">from</span> Friend
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(num)
                   <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
                         <span class="org-keyword">from</span> Friend
                         <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1));
</pre>
</div>
</div>
</div>

<div id="outline-container-org5782072" class="outline-4">
<h4 id="org5782072"><span class="section-number-4">1.2.5</span> <span class="done DONE">DONE</span> Movie-Rating <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-5">
<p>
Add the reviewer Roger Ebert to your database, with an rID of 209.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Reviewer <span class="org-keyword">values</span> (209, <span class="org-string">'Roger Ebert'</span>);
</pre>
</div>

<p>
Insert 5-star ratings by James Cameron for all movies in the database.<br />
Leave the review date as NULL.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Rating
<span class="org-keyword">select</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'James Cameron'</span>),
       mID, 5, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Movie;
</pre>
</div>

<p>
For all movies that have an average rating of 4 stars or higher, add<br />
25 to the release year.  (Update the existing tuples; don't insert new<br />
tuples.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Movie
<span class="org-keyword">set</span> <span class="org-keyword">year</span> = <span class="org-keyword">year</span> + 25
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = Movie.mID) &gt;= 4;
</pre>
</div>

<p>
Remove all ratings where the movie's year is before 1970 or after<br />
2000, and the rating is fewer than 4 stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Rating
<span class="org-keyword">where</span> stars &lt; 4 <span class="org-keyword">and</span>
      ((<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &lt; 1970 <span class="org-keyword">or</span>
       (<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &gt; 2000)
</pre>
</div>
</div>
</div>

<div id="outline-container-org58ff4d7" class="outline-4">
<h4 id="org58ff4d7"><span class="section-number-4">1.2.6</span> <span class="done DONE">DONE</span> Social-Network <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-6">
<p>
It's time for the seniors to graduate.  Remove all 12th graders from<br />
Highschooler.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> grade = 12;
</pre>
</div>

<p>
If two students A and B are friends, and A likes B but not vice-versa,<br />
remove the Likes tuple.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> *
              <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                    <span class="org-keyword">except</span>
                    <span class="org-keyword">select</span> ID2, ID1 <span class="org-keyword">from</span> Likes
                    <span class="org-keyword">intersect</span>
                    <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes)
              <span class="org-keyword">where</span> ID1 = Likes.ID1 <span class="org-keyword">and</span> ID2 = Likes.ID2);
</pre>
</div>

<p>
For all cases where A is friends with B, and B is friends with C, add<br />
a new friendship for the pair A and C.  Do not add duplicate<br />
friendships, friendships that already exist, or friendships with<br />
oneself.  (This one is a bit challenging; congratulations if you get<br />
it right.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Friend
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R.ID1, S.ID2
<span class="org-keyword">from</span> Friend R <span class="org-keyword">join</span> Friend S
<span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span> S.ID2 &lt;&gt; R.ID1 <span class="org-keyword">and</span>
   <span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = R.ID1 <span class="org-keyword">and</span>
                   ID2 = S.ID2);
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org849fb70" class="outline-2">
<h2 id="xpath-and-xquery-mini-course"><a id="org849fb70"></a><span class="section-number-2">2</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XPath/SelfPaced/courseware/ch-querying_xml/">XPath and XQuery</a> mini-course</h2>
<div class="outline-text-2" id="text-xpath-and-xquery-mini-course">
</div>
<div id="outline-container-orga33a09e" class="outline-3">
<h3 id="orga33a09e"><span class="section-number-3">2.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org0ad431a" class="outline-4">
<h4 id="xpath-introduction"><a id="org0ad431a"></a><span class="section-number-4">2.1.1</span> <span class="done DONE">DONE</span> XPath Introduction</h4>
<div class="outline-text-4" id="text-xpath-introduction">
<p>
Not nearly as mature as Querying Relational<br />
</p>
<ul class="org-ul">
<li>XPath - path expressions + conditions<br /></li>
<li>XSLT - XPath + transformations, output<br /></li>
<li>XQuery - XPath + full-featured Q.L.<br /></li>
</ul>

<p>
Think of XML as a tree<br />
</p>

<p>
Basic Constructs<br />
</p>
<pre class="example">
/ root element and separator
{element name} or *
@{attribute name}
// any descendants including self
[condition] e.g. [@price &lt; 50]
[number] nth sub-element
</pre>

<p>
Built-in functions (lots of them)<br />
</p>
<pre class="example">
contains(s1, s2)
name()
</pre>

<p>
Navigation "axes" (13 of them)<br />
</p>
<pre class="example">
parent::
following-sibling::
descendants:: (does not match self, cf. //)
self::
</pre>

<p>
XPath queries operate on and return <i>sequence</i> of elements<br />
Sometimes result can be expressed as XML, but not always<br />
</p>
</div>
</div>

<div id="outline-container-org46c1460" class="outline-4">
<h4 id="xpath-demo"><a id="org46c1460"></a><span class="section-number-4">2.1.2</span> <span class="done DONE">DONE</span> XPath Demo</h4>
<div class="outline-text-4" id="text-xpath-demo">
<p>
Get the titles of books in the bookstore where the price is lower<br />
than 90 and Jeffrey Widom is an author.<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[@Price &lt; 90 and
        Authors/Author[Last_name = "Widom" and
        First_Name="Jeffrey"]]/Title
</pre>

<p>
Get the titles of books where "Ullman" is an author and "Widom" is not<br />
an author.  <b>The below code doesn't work since there is no way using<br />
XPath language alone to achieve the query.</b><br />
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman" and
        Authors/Author/Last_Name != "Widom"]/Title
</pre>

<p>
Get all magazines where there's a book with the same title.  (An<br />
example of <i>self-join</i> in XPath)<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")//Magazine[
        Title = doc("BookstoreQ.xml")//Book/Title]
</pre>

<p>
The equal sign in the above code is implicitly existentially<br />
quantified.  There is a lot of implicit existential quantification in<br />
XPath and XQuery.<br />
</p>

<p>
All Elements whose parent is not "Bookstore" or "Book".<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore//*[
        name(parent::*) != "Bookstore"
        and name(parent::*) != "Book"]
</pre>

<p>
The above code use the navigation access <code>parent::</code>.<br />
</p>

<p>
All books and magazines with non-unique titles.<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/(Book|Magazine)[
        Title = following-sibling::*/Title
        or Title = preceding-sibling::*/Title]
</pre>

<p>
Books where every author's first name includes "J".  This query will<br />
need universal quantification.<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")//Book[
        count(Authors/Author[contains(First_Name, "J")]) =
        count(Authors/Author/First_Name)]
</pre>

<p>
The built-in function <code>count</code> is used to simulate universal<br />
quantification.  This technique can solve previously undoable query.<br />
</p>

<p>
Titles of books where "Ullman" is an author and "Widom" is not<br />
an author.<br />
</p>

<pre class="example">
doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman"
        and count(Authors/Author[Last_Name = "Widom"]) = 0]/Title
</pre>
</div>
</div>

<div id="outline-container-org618eed1" class="outline-4">
<h4 id="xquery-introduction"><a id="org618eed1"></a><span class="section-number-4">2.1.3</span> <span class="done DONE">DONE</span> XQuery Introduction</h4>
<div class="outline-text-4" id="text-xquery-introduction">
<ol class="org-ol">
<li>XQuery is a expression language (compositional)<br /></li>
<li>Each expression operates on and returns sequence of elements<br /></li>
<li>XPath is one type of expression<br /></li>
</ol>

<p>
XQuery: FLWOR expression<br />
</p>

<pre class="example">
For $var in expr
Let $var := expr
Where condition
Order By expr
Return expr
</pre>

<p>
Mixing queries and XML<br />
</p>

<pre class="example">
&lt;Result&gt; { ...query goes here... } &lt;/Result&gt;
</pre>
</div>
</div>

<div id="outline-container-orgf83823a" class="outline-4">
<h4 id="xquery-demo"><a id="orgf83823a"></a><span class="section-number-4">2.1.4</span> <span class="done DONE">DONE</span> XQuery Demo</h4>
<div class="outline-text-4" id="text-xquery-demo">
<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; 90
  and $b/Authors/Author/Last_Name = "Ullman"
return $b/Title
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { $b/Authors/Author/First_Name }
       &lt;/Book&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { for $fn in $b/Authors/Authors/Author/First_Name
           where contains($b/Title, $fn) return $fn }
       &lt;/Book&gt;
</pre>

<pre class="example">
&lt;Average&gt;
  { let $plist := doc("BookstoreQ.xml")/Bookstore/Book/@Price
    return avg($plist) }
&lt;/Average&gt;
</pre>

<pre class="example">
let $a := avg(doc("BookstoreQ.xml")/Bookstore/Book/@Price)
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; $a
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
order by xs:int($b/@Price)
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>

<pre class="example">
for $n in distinct-values(doc("BookstoreQ.xml")//Last_Name)
return &lt;Last_Name&gt; { $n } &lt;/Last_Name&gt;
</pre>

<pre class="example">
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where every $fn in $b/Authors/Author/First_Name
        satisfies contains($fn, "J")
return $b
</pre>

<pre class="example">
for $b1 in doc("BookstoreQ.xml")/Bookstore/Book
for $b2 in doc("BookstoreQ.xml")/Bookstore/Book
where $b1/Authors/Author/Last_Name = $b2/Authors/Author/Last_Name
      and $b1/Title &lt; $b2/Title
return
    &lt;BookPair&gt;
        &lt;Title1&gt; { data($b1/Title) } &lt;/Title1&gt;
        &lt;Title2&gt; { data($b2/Title) } &lt;/Title2&gt;
    &lt;/BookPair&gt;
</pre>

<p>
Again, implicitly existential quantification.<br />
</p>

<pre class="example">
&lt;InvertedBookstore&gt;
    { for $ln in distinct-values(doc("BookstoreQ.xml")//Author/Last_Name)
      for $fn in distinct-values(doc("BookstoreQ.xml")//Author[
                                      Last_name=$ln]/First_Name)
      return
          &lt;Author&gt;
              &lt;First_Name&gt; { $fn } &lt;/First_name&gt;
              &lt;Last_Name { $ln } &lt;/Last_Name&gt;
              { for $b in doc("BookstoreQ.xml")/Bookstore/Book[
                               Authors/Atuhor/Last_Name=$ln]
                return &lt;Book&gt;
                          { $b/@ISBN } { $b/@Price } { $/@Edition }
                          { $b/Title } { $b/Remark }
                       &lt;/Book&gt;
          &lt;/Author&gt; }
&lt;/InvertedBookstore&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdc5af5d" class="outline-3">
<h3 id="orgdc5af5d"><span class="section-number-3">2.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org10d79a9" class="outline-4">
<h4 id="course-catalog-xpath-and-xquery"><a id="org10d79a9"></a><span class="section-number-4">2.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery</h4>
<div class="outline-text-4" id="text-course-catalog-xpath-and-xquery">
<p>
Return all Title elements (of both departments and courses).<br />
</p>

<pre class="example">
doc("courses.xml")//Title
</pre>

<p>
Return last names of all department chairs.<br />
</p>

<pre class="example">
doc("courses.xml")//Department/Chair//Last_Name
</pre>

<p>
Return titles of courses with enrollment greater than 500.<br />
</p>

<pre class="example">
doc("courses.xml")//Course[@Enrollment &gt; 500]/Title
</pre>

<p>
Return titles of departments that have some course that takes "CS106B"<br />
as a prerequisite.<br />
</p>

<pre class="example">
doc("courses.xml")//Department[Course/Prerequisites[Prereq = "CS106B"]]/Title
</pre>

<p>
Return last names of all professors or lecturers who use a middle<br />
initial.  Don't worry about eliminating duplicates.<br />
</p>

<pre class="example">
doc("courses.xml")//(Lecturer|Professor)[Middle_Initial]/Last_Name
</pre>

<p>
Return the count of courses that have a cross-listed course (i.e.,<br />
that have "Cross-listed" in their description).<br />
</p>

<pre class="example">
count(doc("courses.xml")//Course[contains(Description, "Cross-listed")])
</pre>

<p>
Return the average enrollment of all courses in the CS department.<br />
</p>

<pre class="example">
avg(doc("courses.xml")//Department[@Code="CS"]/Course/@Enrollment)
</pre>

<p>
Return last names of instructors teaching at least one course that has<br />
"system" in its description and enrollment greater than 100.<br />
</p>

<pre class="example">
doc("courses.xml")//Course[@Enrollment &gt; 100 and contains(Description, "system")]/Instructors//Last_Name
</pre>

<p>
Return the title of the course with the largest enrollment.<br />
</p>

<pre class="example">
for $c in doc("courses.xml")//Course
where every $e in doc("courses.xml")//Course/@Enrollment
        satisfies xs:int($e) &lt;= xs:int($c/@Enrollment)
return $c/Title
</pre>

<p>
Only one of the function call <code>xs:int</code> shown above is necessary since<br />
the other operand will go through type promotion.<br />
</p>
</div>
</div>

<div id="outline-container-orga649d98" class="outline-4">
<h4 id="course-catalog-xpath-and-xquery-extras"><a id="orga649d98"></a><span class="section-number-4">2.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Extras</h4>
<div class="outline-text-4" id="text-course-catalog-xpath-and-xquery-extras">
<p>
Return the course number of the course that is cross-listed as "LING180".<br />
</p>

<pre class="example">
data(doc("courses.xml")//Course[contains(Description, "Cross-listed as LING180")]/@Number)
</pre>

<p>
Return course numbers of courses that have the same title as some<br />
other course.  (Hint: You might want to use the "preceding" and<br />
"following" navigation axes for this query, which were not covered in<br />
the video or our demo script; they match any preceding or following<br />
node, not just siblings.)<br />
</p>

<pre class="example">
for $c1 in doc("courses.xml")//Course
where some $c2 in doc("courses.xml")//Course
      satisfies $c1 != $c2
                and $c1/Title = $c2/Title
return data($c1/@Number)
</pre>

<p>
Return course numbers of courses taught by an instructor with first<br />
name "Daphne" or "Julie".<br />
</p>

<pre class="example">
data(doc("courses.xml")//Course[Instructors//First_Name = ("Daphne", "Julie")]/@Number)
</pre>

<p>
Return the number (count) of courses that have no lecturers as<br />
instructors.<br />
</p>

<pre class="example">
count(doc("courses.xml")//Course[not(Instructors[Lecturer])])
</pre>

<p>
Return titles of courses taught by the chair of a department.  For<br />
this question, you may assume that all professors have distinct last<br />
names.<br />
</p>

<pre class="example">
doc("courses.xml")//Course[
    Instructors/Professor/Last_Name =
        doc("courses.xml")//Department/Chair/Professor/Last_Name
]/Title
</pre>

<pre class="example">
for $c in doc("courses.xml")//Course
where $c/Instructors/(Professor|Lecturer)/Last_Name
          = doc("courses.xml")//Department/Chair/(Professor|Lecturer)/Last_Name
return $c/Title
</pre>

<pre class="example">
for $c in doc("courses.xml")//Course
where some $t1 in $c/Instructors/(Professor|Lecturer)
      satisfies some $t2 in
                doc("courses.xml")//Department/Chair/(Professor|Lecturer)
                satisfies deep-equal($t1/*, $t2/*)
return $c/Title
</pre>

<p>
Return titles of courses that have both a lecturer and a professor as<br />
instructors.  Return each title only once.<br />
</p>

<pre class="example">
doc("courses.xml")//Course[Instructors/Lecturer and Instructors/Professor]/Title
</pre>

<p>
Return titles of courses taught by a professor with the last name "Ng"<br />
but not by a professor with the last name "Thrun".<br />
</p>

<pre class="example">
for $c in doc("courses.xml")//Course[Instructors/Professor/Last_Name = "Ng"]
where every $ln in $c/Instructors/Professor/Last_Name
      satisfies $ln != "Thrun"
return $c/Title
</pre>

<pre class="example">
doc("courses.xml")//Course[Instructors[
        Professor/Last_Name = "Ng" and
        count(Professor[Last_Name = "Thrun"]) = 0]]/Title
</pre>

<p>
Return course numbers of courses that have a course taught by Eric<br />
Roberts as a prerequisite.<br />
</p>

<pre class="example">
for $c in doc("courses.xml")//Course
where some $p in $c/Prerequisites/Prereq
      satisfies $p = data(
          doc("courses.xml")//Course[
              Instructors/(Professor|Lecturer)[
                  First_Name = "Eric" and
                  Last_Name = "Roberts"]]/@Number)
return data($c/@Number)
</pre>

<p>
Create a summary of CS classes: List all CS department courses in<br />
order of enrollment.  For each course include only its Enrollment (as<br />
an attribute) and its Title (as a subelement).<br />
</p>

<pre class="example">
&lt;Summary&gt;
    { for $c in doc("courses.xml")//Department[@Code="CS"]/Course
      order by xs:int($c/@Enrollment)
      return &lt;Course&gt;
                 { $c/@Enrollment }
                 { $c/Title }
             &lt;/Course&gt; }
&lt;/Summary&gt;
</pre>

<p>
Return a "Professors" element that contains as subelements a listing<br />
of all professors in all departments, sorted by last name with each<br />
professor appearing once.  The "Professor" subelements should have the<br />
same structure as in the original data.  For this question, you may<br />
assume that all professors have distinct last names.  Watch out &#x2013; the<br />
presence/absence of middle initials may require some special handling.<br />
(This problem is quite challenging; congratulations if you get it<br />
right.)<br />
</p>

<pre class="example">
&lt;Professors&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      order by $ln
      return (doc("courses.xml")//Professor[Last_Name=$ln])[1] }
&lt;/Professors&gt;
</pre>

<p>
Expanding on the previous question, create an inverted course listing:<br />
Return an "Inverted_Course_Catalog" element that contains as<br />
subelements professors together with the courses they teach, sorted by<br />
last name.  You may still assume that all professors have distinct last<br />
names.  The "Professor" subelements should have the same structure as<br />
in the original data, with an additional single "Courses" subelement<br />
under Professor, containing a further "Course" subelement for each<br />
course number taught by that professor.  Professors who do not teach<br />
any courses should have no Courses subelement at all.  (This problem is<br />
very challenging; extra congratulations if you get it right.)<br />
</p>

<pre class="example">
&lt;Inverted_Course_Catalog&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      let $prof := (doc("courses.xml")//Professor[Last_Name=$ln])[1]
      order by $ln
      return &lt;Professor&gt;
                 { $prof/First_Name } { $prof/Middle_Initial }
                 { $prof/Last_Name }
                 { let $cs :=
                       &lt;Courses&gt;
                           { for $c in doc("courses.xml")//Course[
                                 Instructors/Professor/Last_Name = $ln]
                             return &lt;Course&gt;
                                        { data($c/@Number) }
                                    &lt;/Course&gt; }
                       &lt;/Courses&gt;
                   return $cs[Course] }
             &lt;/Professor&gt;}
&lt;/Inverted_Course_Catalog&gt;
</pre>
</div>
</div>

<div id="outline-container-org1a2ce91" class="outline-4">
<h4 id="world-countries-xpath-and-xquery"><a id="org1a2ce91"></a><span class="section-number-4">2.2.3</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery</h4>
<div class="outline-text-4" id="text-world-countries-xpath-and-xquery">
<p>
Return the area of Mongolia.<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[@name="Mongolia"]/@area)
</pre>

<p>
Return the names of all cities that have the same name as the country<br />
in which they are located.<br />
</p>

<pre class="example">
for $c in doc("countries.xml")//country[@name = city/name]
return $c/city[name = $c/@name]/name
</pre>

<pre class="example">
for $c in doc("countries.xml")//country[@name = city/name]
return &lt;name&gt; { data($c/@name) } &lt;/name&gt;
</pre>

<p>
Return the average population of Russian-speaking countries.<br />
</p>

<pre class="example">
avg(data(doc("countries.xml")//country[language = "Russian"]/@population))
</pre>

<p>
Return the names of all countries that have at least three cities with<br />
population greater than 3 million.<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[count(city[xs:int(population) &gt; 3000000]) &gt;= 3]/@name)
</pre>

<p>
The function call <code>xs:int</code> in the above code is actually unnecessary<br />
since type promotion would occur due to right-hand operand.<br />
</p>

<p>
Create a list of French-speaking and German-speaking countries.  The<br />
result should take the form:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;result&gt;
  &lt;French&gt;
    { for $cn in data(doc("countries.xml")//country[language = "French"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/French&gt;
  &lt;German&gt;
    { for $cn in data(doc("countries.xml")//country[language = "German"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/German&gt;
&lt;/result&gt;
</pre>

<pre class="example">
&lt;result&gt;
  { let $langs := ("French", "German")
    for $lang in $langs
    return element {$lang}
    { for $cn in data(doc("countries.xml")//country[language=$lang]/@name)
          return &lt;country&gt; { $cn } &lt;/country&gt; } }
&lt;/result&gt;
</pre>

<p>
Return the countries with the highest and lowest population densities.<br />
Note that because the "/" operator has its own meaning in XPath and<br />
XQuery, the division operator is infix "div".  To compute population<br />
density use "(@population div @area)".  You can assume density values<br />
are unique.  The result should take the form:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">highest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">highest</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">lowest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">lowest</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;result&gt;
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &gt;= $c2/@population div $c2/@area
    return &lt;highest density="{$density}"&gt; { data($c1/@name) } &lt;/highest&gt; }
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &lt;= $c2/@population div $c2/@area
    return &lt;lowest density="{$density}"&gt; { data($c1/@name) } &lt;/lowest&gt; }
&lt;/result&gt;
</pre>
</div>
</div>

<div id="outline-container-orge963eca" class="outline-4">
<h4 id="world-countries-xpath-and-xquery-extras"><a id="orge963eca"></a><span class="section-number-4">2.2.4</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery Extras</h4>
<div class="outline-text-4" id="text-world-countries-xpath-and-xquery-extras">
<p>
Return the names of all countries with population greater than 100<br />
million.<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[@population &gt; 100000000]/@name)
</pre>

<p>
Return the names of all countries where over 50% of the population<br />
speaks German.  (Hint: Depending on your solution, you may want to use<br />
".", which refers to the "current element" within an XPath<br />
expression.)<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[language[@percentage &gt; 50.0] = "German"]/@name)
</pre>

<p>
Return the names of all countries where a city in that country<br />
contains more than one-third of the country's population.<br />
</p>

<pre class="example">
for $c in doc("countries.xml")//country
where some $cp in $c/city/population
      satisfies $cp div $c/@population &gt; 1 div 3
return data($c/@name)
</pre>

<p>
Return the population density of Qatar.  Note: Since the "/" operator<br />
has its own meaning in XPath and XQuery, the division operator is<br />
"div".  To compute population density use "(@population div @area)".<br />
</p>

<pre class="example">
let $c := doc("countries.xml")//country[@name="Qatar"]
return $c/@population div $c/@area
</pre>

<p>
Return the names of all countries whose population is less than one<br />
thousandth that of some city (in any country).<br />
</p>

<pre class="example">
let $countries := doc("countries.xml")//country
for $c in $countries
where some $city in $countries/city
      satisfies $city/population * 0.001 &gt; $c/@population
return data($c/@name)
</pre>

<p>
Return all city names that appear more than once, i.e., there is more<br />
than one city with that name in the data.  Return only one instance of<br />
each such city name.  (Hint: You might want to use the "preceding"<br />
and/or "following" navigation axes for this query, which were not<br />
covered in the video or our demo script; they match any preceding or<br />
following node, not just siblings.)<br />
</p>

<pre class="example">
let $cities := doc("countries.xml")//city
for $city in distinct-values($cities/name)
where count($cities[name = $city]) &gt; 1
return &lt;name&gt;{$city}&lt;/name&gt;
</pre>

<p>
Return the names of all countries containing a city such that some<br />
other country has a city of the same name.  (Hint: You might want to<br />
use the "preceding" and/or "following" navigation axes for this query,<br />
which were not covered in the video or our demo script; they match any<br />
preceding or following node, not just siblings.)<br />
</p>

<pre class="example">
let $countries := doc("countries.xml")//country
for $c in $countries
where some $c2 in $countries
      satisfies not($c2 is $c)
                and $c/city/name = $c2/city/name
return data($c/@name)
</pre>

<p>
Return the names of all countries whose name textually contains a<br />
language spoken in that country.  For instance, Uzbek is spoken in<br />
Uzbekistan, so return Uzbekistan.  (Hint: You may want to use ".",<br />
which refers to the "current element" within an XPath expression.)<br />
</p>

<pre class="example">
for $c in doc("countries.xml")//country
where some $lang in $c/language
      satisfies contains($c/@name, $lang)
return data($c/@name)
</pre>

<p>
Return the names of all countries in which people speak a language<br />
whose name textually contains the name of the country.  For instance,<br />
Japanese is spoken in Japan, so return Japan.  (Hint: You may want to<br />
use ".", which refers to the "current element" within an XPath<br />
expression.)<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[language[contains(., ../@name)]]/@name)
</pre>

<p>
Return all languages spoken in a country whose name textually contains<br />
the language name.  For instance, German is spoken in Germany, so<br />
return German.  (Hint: Depending on your solution, may want to use<br />
data(.), which returns the text value of the "current element" within<br />
an XPath expression.)<br />
</p>

<pre class="example">
data(doc("countries.xml")//country/language[contains(../@name, .)])
</pre>

<p>
Return all languages whose name textually contains the name of a<br />
country in which the language is spoken.  For instance, Icelandic is<br />
spoken in Iceland, so return Icelandic.  (Hint: Depending on your<br />
solution, may want to use data(.), which returns the text value of the<br />
"current element" within an XPath expression.)<br />
</p>

<pre class="example">
data(doc("countries.xml")//country/language[contains(., ../@name)])
</pre>

<p>
Return the number of countries where Russian is spoken.<br />
</p>

<pre class="example">
count(doc("countries.xml")//country[language = "Russian"])
</pre>

<p>
Return the names of all countries for which the data does not include<br />
any languages or cities, but the country has more than 10 million<br />
people.<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[not(language or city) and @population &gt; 10000000]/@name)
</pre>

<p>
Return the name of the country with the highest population.  (Hint: You<br />
may need to explicitly cast population numbers as integers with<br />
xs:int() to get the correct answer.)<br />
</p>

<pre class="example">
data(doc("countries.xml")//country[
    @population = max(doc("countries.xml")//country/@population)
]/@name)
#+END_EXAMPLE)

Return the name of the country that has the city with the highest
population.  (Hint: You may need to explicitly cast population numbers
as integers with xs:int() to get the correct answer.)

#+BEGIN_EXAMPLE
data(doc("countries.xml")//country[
    city/population = max(doc("countries.xml")//city/population)
]/@name)
</pre>

<p>
Return the average number of languages spoken in countries where<br />
Russian is spoken.<br />
</p>

<pre class="example">
avg(for $c in doc("countries.xml")//country[language = "Russian"]
return count($c/language))
</pre>

<p>
Return all country-language pairs where the language is spoken in the<br />
country and the name of the country textually contains the language<br />
name.  Return each pair as a country element with language attribute,<br />
e.g.,<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">French</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">French Guiana</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
for $c in doc("countries.xml")//country
for $lang in $c/language
where contains($c/@name, $lang)
return &lt;country language="{$lang}"&gt; { data($c/@name) } &lt;/country&gt;
</pre>

<p>
Return all countries that have at least one city with population<br />
greater than 7 million.  For each one, return the country name along<br />
with the cities greater than 7 million, in the format:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">country-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
for $country in doc("countries.xml")//country
let $c := &lt;country&gt;
              { $country/@name }
              { for $city in $country/city
                where $city/population &gt; 7000000
                return &lt;big&gt;{data($city/name)}&lt;/big&gt; }
          &lt;/country&gt;
return $c[big]
</pre>

<p>
Return all countries where at least one language is listed, but the<br />
total percentage for all listed languages is less than 90%.  Return the<br />
country element with its name attribute and its language subelements,<br />
but no other attributes or subelements.<br />
</p>

<pre class="example">
for $country in doc("countries.xml")//country[language]
where sum($country/language/@percentage) &lt; 90
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>

<p>
Return all countries where at least one language is listed, and every<br />
listed language is spoken by less than 20% of the population.  Return<br />
the country element with its name attribute and its language<br />
subelements, but no other attributes or subelements.<br />
</p>

<pre class="example">
for $country in doc("countries.xml")//country[language]
where every $lang in $country/language
      satisfies $lang/@percentage &lt; 20
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>

<p>
Find all situations where one country's most popular language is<br />
another country's least popular, and both countries list more than one<br />
language.  (Hint: You may need to explicitly cast percentages as<br />
floating-point numbers with xs:float() to get the correct answer.)<br />
Return the name of the language and the two countries, each in the<br />
format:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LangPair</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">lang-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LangPair</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
let $countries := doc("countries.xml")//country[count(language) &gt; 1]
for $c in $countries
for $lang in $c/language
where every $lang2 in $c/language
      satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
return (&lt;LangPair language="{$lang}"&gt;
            &lt;MostPopular&gt;{data($c/@name)}&lt;/MostPopular&gt;
            { for $c2 in $countries[language = $lang]
              let $lang3 := $c2/language[. = $lang]
              where every $lang2 in $c2/language
                    satisfies xs:float($lang3/@percentage) &lt;= $lang2/@percentage
              return &lt;LeastPopular&gt; {data($c2/@name)}&lt;/LeastPopular&gt; }
        &lt;/LangPair&gt;)[LeastPopular]
</pre>

<pre class="example">
let $countries :=
    for $c in doc("countries.xml")//country[count(language) &gt; 1]
    let $most_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
        return &lt;MostPopular&gt;{data($lang)}&lt;/MostPopular&gt;
    let $least_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &lt;= $lang2/@percentage
        return &lt;LeastPopular&gt;{data($lang)}&lt;/LeastPopular&gt;
    return &lt;country&gt;
               {$c/@name}
               {$most_lang}
               {$least_lang}
           &lt;/country&gt;
for $c1 in $countries
for $c2 in $countries
where $c1/MostPopular = $c2/LeastPopular
return &lt;LangPair language="{$c1/MostPopular}"&gt;
           &lt;MostPopular&gt;{data($c1/@name)}&lt;/MostPopular&gt;
           &lt;LeastPopular&gt;{data($c2/@name)}&lt;/LeastPopular&gt;
       &lt;/LangPair&gt;
</pre>

<p>
For each language spoken in one or more countries, create a "language"<br />
element with a "name" attribute and one "country" subelement for each<br />
country in which the language is spoken.  The "country" subelements<br />
should have two attributes: the country "name", and "speakers"<br />
containing the number of speakers of that language (based on language<br />
percentage and the country's population).  Order the result by<br />
language name, and enclose the entire list in a single "languages"<br />
element.  For example, your result might look like:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">language</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Arabic</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Iran</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">660942</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Saudi Arabia</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">19409058</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Yemen</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">13483178</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">language</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<pre class="example">
&lt;languages&gt;
    { for $lang in distinct-values(doc("countries.xml")//language)
      order by $lang
      return &lt;language name="{$lang}"&gt;
                 { for $c in doc("countries.xml")//country[language = $lang]
                   return &lt;country name="{$c/@name}"
                                   speakers="{xs:int(
                                       $c/language[. = $lang]/@percentage
                                           div 100 * $c/@population)}"&gt;
                          &lt;/country&gt; }
             &lt;/language&gt; }
&lt;/languages&gt;
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orga694def" class="outline-2">
<h2 id="xslt-mini-course"><a id="orga694def"></a><span class="section-number-2">3</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XSLT/SelfPaced/courseware/ch-querying_xml/">XSLT</a> mini-course</h2>
<div class="outline-text-2" id="text-xslt-mini-course">
</div>
<div id="outline-container-org0f51f51" class="outline-3">
<h3 id="xslt-mini-course-lectures"><a id="org0f51f51"></a><span class="section-number-3">3.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-xslt-mini-course-lectures">
<ul class="org-ul">
<li>XSL = Extensible Stylesheet Language<br /></li>
<li>XSLT = XSL (with) transformations<br /></li>
</ul>

<p>
XSLT is more widely used than XSL.<br />
</p>

<p>
XSLT: Rule-Based Transformations<br />
</p>

<ul class="org-ul">
<li>Match template and replace<br /></li>
<li>Recursively match template<br /></li>
<li>Extract values<br /></li>
<li>Iteration (for-each)<br /></li>
<li>Conditionals (if)<br /></li>
</ul>

<p>
Catches:<br />
</p>

<ul class="org-ul">
<li>Strange default/whitespace behavior<br /></li>
<li>Implicit template priority scheme<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org592265c" class="outline-3">
<h3 id="org592265c"><span class="section-number-3">3.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org5ea8590" class="outline-4">
<h4 id="course-catalog-xslt"><a id="org5ea8590"></a><span class="section-number-4">3.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XSLT</h4>
<div class="outline-text-4" id="text-course-catalog-xslt">
<p>
Return a list of department titles.<br />
</p>

<p>
Your solution should fill in the following stylesheet:<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match=...&gt;
        ... template body ...
    &lt;/xsl:template&gt;
    ... more templates as needed ...
&lt;/xsl:stylesheet&gt;
</pre>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department/Title"&gt;
        &lt;xsl:copy-of select="."/&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Return a list of department elements with no attributes and two<br />
subelements each: the department title and the entire Chair subelement<br />
structure.<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department"&gt;
      &lt;Department&gt;
        &lt;xsl:copy-of select="Title"/&gt;
        &lt;xsl:copy-of select="Chair"/&gt;
      &lt;/Department&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-orgd7a7f46" class="outline-4">
<h4 id="course-catalog-xslt-extras"><a id="orgd7a7f46"></a><span class="section-number-4">3.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</h4>
<div class="outline-text-4" id="text-course-catalog-xslt-extras">
<p>
Return all courses with enrollment greater than 500.  Retain the<br />
structure of Course elements from the original data.<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Course[@Enrollment &amp;gt; 500]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Remove from the data all courses with enrollment greater than 60, or<br />
with no enrollment listed.  Otherwise the structure of the data should<br />
be the same.<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="Course[not(@Enrollment) or @Enrollment &amp;gt; 60]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create a summarized version of the EE part of the course catalog.  For<br />
each course in EE, return a Course element, with its Number and Title<br />
as attributes, its Description as a subelement, and the last name of<br />
each instructor as an Instructor subelement.  Discard all information<br />
about department titles, chairs, enrollment, and prerequisites, as<br />
well as all courses in departments other than EE.  (Note: To specify<br />
quotes within an already-quoted XPath expression, use quot;.)<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='EE']"&gt;
    &lt;xsl:for-each select="Course"&gt;
      &lt;Course Number="{@Number}"
              Title="{Title}"&gt;
        &lt;xsl:copy-of select="Description"/&gt;
        &lt;xsl:for-each select="Instructors//Last_Name"&gt;
          &lt;Instructor&gt;&lt;xsl:value-of select="."/&gt;&lt;/Instructor&gt;
        &lt;/xsl:for-each&gt;
      &lt;/Course&gt;
    &lt;/xsl:for-each&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create an HTML table with one-pixel border that lists all CS<br />
department courses with enrollment greater than 200.  Each row should<br />
contain three cells: the course number in italics, course title in<br />
bold, and enrollment.  Sort the rows alphabetically by course title.<br />
No header is needed.  (Note: For formatting, just use "table<br />
border=1", and "&lt;b&gt;" and "&lt;i&gt;" tags for bold and italics respectively.<br />
To specify quotes within an already-quoted XPath expression, use<br />
quot;.)<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='CS']"&gt;
    &lt;table border="1"&gt;
      &lt;xsl:for-each select="Course[@Enrollment &amp;gt; 200]"&gt;
        &lt;xsl:sort select="Title"/&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;i&gt;&lt;xsl:value-of select="@Number"/&gt;&lt;/i&gt;&lt;/td&gt;
          &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="Title"/&gt;&lt;/b&gt;&lt;/td&gt;
          &lt;td&gt;&lt;xsl:value-of select="@Enrollment"/&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/xsl:for-each&gt;
    &lt;/table&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-org358471c" class="outline-4">
<h4 id="world-countries-xslt"><a id="org358471c"></a><span class="section-number-4">3.2.3</span> <span class="done DONE">DONE</span> World-Countries XSLT</h4>
<div class="outline-text-4" id="text-world-countries-xslt">
<p>
Return all countries with population between 9 and 10 million.  Retain<br />
the structure of country elements from the original data.<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[9000000 &amp;lt;= @population and @population &amp;lt;= 10000000]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create a table using HTML constructs that lists all countries that<br />
have more than 3 languages.  Each row should contain the country name<br />
in bold, population, area, and number of languages.  Sort the rows in<br />
descending order of number of languages.  No header is needed for the<br />
table, but use &lt;table border="1"&gt; to make it format nicely, should you<br />
choose to check your result in a browser.  (Hint: You may find the<br />
data-type and order attributes of &lt;xsl:sort&gt; to be useful.)<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="countries"&gt;
    &lt;html&gt;
      &lt;table border="1"&gt;
        &lt;xsl:for-each select="country[count(language) &amp;gt; 3]"&gt;
          &lt;xsl:sort select="count(language)"
                    order="descending"/&gt;
          &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@area"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="count(language)"/&gt;&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/xsl:for-each&gt;
      &lt;/table&gt;
    &lt;/html&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Create an alternate version of the countries database: for each<br />
country, include its name and population as subelements, and the number<br />
of languages and number of cities as attributes (called "languages"<br />
and "cities" respectively).<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country"&gt;
    &lt;country languages="{count(language)}"
             cities="{count(city)}"&gt;
      &lt;name&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/name&gt;
      &lt;population&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/population&gt;
    &lt;/country&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>

<div id="outline-container-org5a53628" class="outline-4">
<h4 id="world-countries-xslt-extras"><a id="org5a53628"></a><span class="section-number-4">3.2.4</span> <span class="done DONE">DONE</span> World-Countries XSLT Extras</h4>
<div class="outline-text-4" id="text-world-countries-xslt-extras">
<p>
Find all country names containing the string "stan"; return each one<br />
within a "Stan" element.  (Note: To specify quotes within an<br />
already-quoted XPath expression, use quot;.)<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[contains(@name, 'stan')]"&gt;
    &lt;Stan&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/Stan&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>

<p>
Remove from the data all countries with area greater than 40,000 and<br />
all countries with no cities listed.  Otherwise the structure of the<br />
data should be the same.<br />
</p>

<pre class="example">
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country[@area &amp;gt; 40000 or not(city)]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgb7e9268" class="outline-2">
<h2 id="relational-design-theory-mini-course"><a id="orgb7e9268"></a><span class="section-number-2">4</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/RD/SelfPaced/courseware/ch-relational_design_theory/">Relational Design Theory</a> mini-course</h2>
<div class="outline-text-2" id="text-relational-design-theory-mini-course">
</div>
<div id="outline-container-org1defa32" class="outline-3">
<h3 id="relational-design-theory-mini-course-lectures"><a id="org1defa32"></a><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-relational-design-theory-mini-course-lectures">
</div>
<div id="outline-container-org05625ab" class="outline-4">
<h4 id="org05625ab"><span class="section-number-4">4.1.1</span> <span class="done DONE">DONE</span> Overview</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Design "anomalies"<br />
</p>
<ul class="org-ul">
<li>Redundancy<br /></li>
<li>Update anomaly<br /></li>
<li>Deletion anomaly<br /></li>
</ul>

<p>
Design by decomposition<br />
</p>
<ul class="org-ul">
<li>Start with "mega" relations containing everything<br /></li>
<li>Decompose into smaller, better relations with same info<br /></li>
<li>Can do decomposition automatically<br /></li>
</ul>

<p>
Automatic decomposition<br />
</p>
<ul class="org-ul">
<li>"Mega" relations + <i>properties of the data</i><br /></li>
<li>System decomposes based on properties<br /></li>
<li>Final set of relations satisfies <i>normal form</i><br />
<ul class="org-ul">
<li>No anomalies, no lost information<br /></li>
</ul></li>
</ul>

<p>
Properties and Normal Forms<br />
</p>
<ul class="org-ul">
<li>Functional dependencies \(\Rightarrow\) Boyce-Codd Normal Form<br /></li>
<li>Multivalued dependencies \(\Rightarrow\) Fourth Normal Form<br /></li>
</ul>

<p>
4NF \(\subset\) BCNF<br />
</p>

<p>
Functional Dependencies and BCNF<br />
</p>
<ul class="org-ul">
<li>Apply(SSN, sName, cName)<br />
<ul class="org-ul">
<li>Redundancy; Update &amp; Deletion Anomalies<br /></li>
<li>Storing SSN-sName pair once for each college<br /></li>
</ul></li>

<li><i>Functional Dependency</i> SSN \(\rightarrow\) sName<br />
<ul class="org-ul">
<li>Same SSN always has same sName<br /></li>
<li>Should store each SSN's sName only once<br /></li>
</ul></li>

<li><i>Boyce-Codd Normal Form</i> If A \(\rightarrow\) B then A is a key<br /></li>
</ul>

<p>
SSN should be a key but not.<br />
</p>

<ul class="org-ul">
<li>Decompose: Student(SSN, sName) Apply(SSN, cName)<br /></li>
</ul>

<p>
Pull out SSN and sName into its own relation<br />
</p>

<p>
Multivalued Dependencies and 4NF<br />
</p>
<ul class="org-ul">
<li>Apply(SSN, cName, HS)<br />
<ul class="org-ul">
<li>Redundancy; Update &amp; Deletion Anomalies<br /></li>
<li>Multiplicative effect<br />
<ul class="org-ul">
<li>C colleges, H high school<br /></li>
<li>C * H tuples<br /></li>
<li>Should be C + H<br /></li>
</ul></li>
<li>Not addressed by BCNF: No functional dependencies<br /></li>
</ul></li>

<li><i>Multivalued Dependency</i> SSN \(\twoheadrightarrow\) cName, SSN \(\twoheadrightarrow\) HS<br />
<ul class="org-ul">
<li>Given SSN has every combination of cName with HS<br /></li>
<li>Should store each cName and each HS for an SSN once<br /></li>
</ul></li>

<li><i>Fourth Normal Form</i> If A \(\twoheadrightarrow\) B then A is a key<br /></li>

<li>Decompose: Apply(SSN, cName) HighSchool(SSN, HS)<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org8538554" class="outline-4">
<h4 id="functional-dependencies"><a id="org8538554"></a><span class="section-number-4">4.1.2</span> <span class="done DONE">DONE</span> Functional Dependencies</h4>
<div class="outline-text-4" id="text-functional-dependencies">
<p>
Functional dependencies are generally useful concepts<br />
</p>
<ul class="org-ul">
<li>Data storage - compression<br /></li>
<li>Reasoning about queries - optimization<br /></li>
</ul>

<p>
Functional dependencies generalizes keys.<br />
</p>

<pre class="example">
Student(SS, sName, address, HScode, HSname, HScity, GPA, priority)
</pre>

<p>
Suppose priority is determined by GPA<br />
</p>

<p>
Two tuples with same GPA have same priority<br />
</p>

<p>
\[\forall t, u \in \mathrm{Student}\colon\,
  t.\mathrm{GPA} = u.\mathrm{GPA} \Rightarrow t.\mathrm{priority} = u.\mathrm{priority}\]<br />
</p>

<p>
GPA \(\rightarrow\) priority<br />
</p>

<p>
\[\forall t, u \in R\colon\,
  t[A_1, \dotsc, A_n] = u[A_1, \dotsc, A_n] \Rightarrow t[B_1, \dotsc, B_n] = u[B_1, \dotsc, B_n]\]<br />
</p>

<p>
\(A_1, \dotsc, A_n \rightarrow B_1, \dotsc, B_n\)<br />
</p>

<p>
\(\bar{A} \rightarrow \bar{B}\)<br />
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) sName<br /></li>
<li>SSN \(\rightarrow\) address (assume students don't work)<br /></li>
<li>HScode \(\rightarrow\) HSname, HScity<br /></li>
<li>HSname, HScity \(\rightarrow\) HScode (assume no schools with same name in the same city)<br /></li>
</ul>

<p>
And<br />
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) GPA<br /></li>
<li>GPA \(\rightarrow\) priority<br /></li>
<li>SSN \(\rightarrow\) priority<br /></li>
</ul>

<p>
transitivity<br />
</p>

<pre class="example">
Apply(SSN, cName, state, date, major)
</pre>

<ul class="org-ul">
<li>cName \(\rightarrow\) date<br /></li>
<li>SSN, cName \(\rightarrow\) major<br /></li>
</ul>

<p>
and<br />
</p>

<ul class="org-ul">
<li>SSN \(\rightarrow\) state<br /></li>
</ul>

<p>
Functional Dependencies and Keys<br />
</p>

<p>
\(R(\bar{A}, \bar{B})\)<br />
</p>

<p>
Trivial Functional Dependency<br />
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow \bar{B}\), \(\bar{B} \subset \bar{A}\)<br /></li>
</ul>

<p>
Nontrivial FD<br />
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow \bar{B}\), \(\bar{B} \not\subset \bar{A}\)<br /></li>
</ul>

<p>
Completely nontrivial FD (most interested)<br />
</p>
<ul class="org-ul">
<li>\(A \rightarrow B\), \(A \cap B = \varnothing\)<br /></li>
</ul>

<p>
Splitting rule<br />
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow B_1, B_2, \dotsc, B_m \Rightarrow \bar{A} \rightarrow
   B_1, \bar{A} \rightarrow B_2, \dotsc\)<br /></li>
</ul>

<p>
Combining rule<br />
</p>
<ul class="org-ul">
<li>\(\bar{A} \rightarrow B_1, \bar{A} \rightarrow B_2, \dotsc \bar{A}
   \rightarrow B_n \Rightarrow \bar{A} \rightarrow B_1, B_2, \dotsc,
   B_n\)<br /></li>
</ul>

<p>
Trivial-dependency rules<br />
</p>
<ul class="org-ul">
<li>A \(\rightarrow\) B, then A \(\rightarrow\) A \(\cup\) B<br /></li>
<li>A \(\rightarrow\) B, then A \(\rightarrow\) A \(\cap\) B<br /></li>
</ul>

<p>
Transitive rule<br />
</p>
<ul class="org-ul">
<li>A \(\rightarrow\) B, B \(\rightarrow\) C, then A \(\rightarrow\) C<br /></li>
</ul>

<p>
Closure of Attributes<br />
</p>
<ul class="org-ul">
<li>Given relations, FDs, set of attributes \(\bar{A}\)<br /></li>
<li>Find all \(B\) such that \(\bar{A} \rightarrow B\)<br /></li>
</ul>

<p>
\(\bar{A}^+\)<br />
</p>

<p>
apply transitive rule repeatedly to get the closure<br />
</p>

<p>
if \(\bar{A}^+\) = all attrs, then \(\bar{A}\) is a key.<br />
</p>

<p>
Grow algorithms can be used to find all keys given a set of FDs.<br />
</p>

<p>
If \(\bar{A}\) is a key, then all its supersets are keys.  Hence, we are<br />
often only interested the smallest key.<br />
</p>

<p>
Specifying FDs for a relation<br />
</p>
<ul class="org-ul">
<li>\(S_1\) and \(S_2\) sets of FDs<br /></li>
<li>\(S_2\) "follows from" \(S_1\) if every relation instance satisfying \(S_1\) also<br />
satisfies \(S_2\)<br />
<ul class="org-ul">
<li>\(S_2\): {SSN \(\rightarrow\) priority}<br /></li>
<li>\(S_1\): {SSN \(\rightarrow\) GPA, GPA \(\rightarrow\) priority}<br /></li>
</ul></li>
</ul>

<p>
Does A \(\rightarrow\) B follow from S?<br />
</p>
<ol class="org-ol">
<li>\(A^+\) based S check if B in set.<br /></li>
<li>Armstrong's Axioms<br /></li>
</ol>

<p>
Want: <span class="underline">Minimal</span> set of <span class="underline">completely nontrivial</span> FDs such that <span class="underline">all FDs</span> that<br />
hold on the relation follow from the dependencies in this set<br />
</p>
</div>
</div>

<div id="outline-container-org3d5d365" class="outline-4">
<h4 id="boyce-codd-normal-form"><a id="org3d5d365"></a><span class="section-number-4">4.1.3</span> <span class="done DONE">DONE</span> Boyce-Codd Normal Form</h4>
<div class="outline-text-4" id="text-boyce-codd-normal-form">
<p>
Decomposition of a relational schema<br />
</p>
<ul class="org-ul">
<li>\(R(A_1, \dotsc, A_n)\)<br /></li>
<li>\(R_1(B_1, \dotsc, B_k)\)<br /></li>
<li>\(R_2(C_1, \dotsc, C_m)\)<br /></li>
</ul>

<p>
Then we want<br />
</p>
<ul class="org-ul">
<li>\(\bar{B} \cup \bar{C} = \bar{A}\)<br /></li>
<li>\(R_1 \Join R_2 = R\)<br /></li>
</ul>

<pre class="example">
Student(SSN, sName, address, HScode, HSname, HScity, GPA, priority)
</pre>

<p>
This is a decomposition.<br />
</p>

<pre class="example">
S1(SSN, sName, address, HScode, GPA, priority)
S2(HScode, HSname, HScity)
</pre>

<p>
This is not a decomposition.<br />
</p>

<pre class="example">
S1(SSN, sName, address, HScode, HSname, HScity)
S2(sName, HSname, GPA, priority)
</pre>

<p>
Good decomposition exhibits lossless join property.<br />
</p>

<p>
BCNF<br />
</p>
<ul class="org-ul">
<li>Relation R with FDs is in BCNF if:<br />
<ul class="org-ul">
<li>For each \(\bar{A} \rightarrow B\), \(\bar{A}\) is a key.<br /></li>
</ul></li>
</ul>

<p>
BCNF violation (redundancy, update/delete anomalies)<br />
</p>

<p>
note: a key can contain another key and thus is a super key.<br />
</p>

<p>
BCNF decomposition algorithm<br />
</p>

<ul class="org-ul">
<li>Input: relation R + FDs for R<br /></li>
<li>Output: decomposition of R into BCNF relations with "lossless join"<br /></li>
</ul>


<ul class="org-ul">
<li>Compute keys for \(R\)<br /></li>
<li>Repeat until all relations are in BCNF<br />
<ul class="org-ul">
<li>Pick any \(R'\) with \(A \rightarrow B\) that violates BCNF<br /></li>
<li>Decompose \(R'\) into \(R_1(A, B)\) and \(R_2(A, \mathrm{rest})\)<br /></li>
<li>Compute FDs for \(R_1\) and \(R_2\)<br /></li>
<li>Compute keys for \(R_1\) and \(R_2\)<br /></li>
</ul></li>
</ul>

<p>
Randomness can result in different answer.<br />
We can extend \(A \rightarrow BA^+\).<br />
</p>
</div>
</div>

<div id="outline-container-org2ed7123" class="outline-4">
<h4 id="multivalued-dependencies-and-4th-normal-form"><a id="org2ed7123"></a><span class="section-number-4">4.1.4</span> <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</h4>
<div class="outline-text-4" id="text-multivalued-dependencies-and-4th-normal-form">
<p>
Fourth Normal Form \(\subset\) Boyce-Codd Normal Form<br />
</p>

<p>
\[R \quad  \bar{A} \twoheadrightarrow \bar{B} \quad
  A_1, \dotsc, A_n, B_1, \dotsc, B_n\]<br />
</p>

<p>
\[\forall t, u \in R \, \exists v \in R:\, 
  t[\bar{A}] = u[\bar{A}] \implies
  v[\bar{A}] = t[\bar{A}] \land
  v[\bar{B}] = t[\bar{B}] \land
  v[\mathrm{rest}] = u[\mathrm{rest}]\]<br />
</p>

<p>
Tuple-generating dependencies<br />
</p>

<p>
\(\bar{A} \twoheadrightarrow \bar{B} \implies \bar{A} \twoheadrightarrow \mathrm{rest}\)<br />
</p>

<p>
Trivial Multivalued Dependency<br />
</p>
<ul class="org-ul">
<li>\(B \subset A\) or \(A \cup B =\) all attrs<br /></li>
</ul>

<p>
\(A \rightarrow B \implies A \twoheadrightarrow B\)<br />
</p>

<p>
FD-is-an-MVD rule<br />
</p>

<p>
4NF \(\implies\) BCNF<br />
</p>

<p>
Intersection rule<br />
</p>
<ul class="org-ul">
<li>If \(A \twoheadrightarrow B\), \(A \twoheadrightarrow C\), then \(A
   \twoheadrightarrow B \cap C\)<br /></li>
</ul>

<p>
Transitive rule<br />
</p>
<ul class="org-ul">
<li>If \(A \twoheadrightarrow B\), \(B \twoheadrightarrow C\), then \(A
   \twoheadrightarrow C - B\)<br /></li>
</ul>

<p>
Fourth Normal Form<br />
</p>

<p>
Relation R with MVDs is in 4NF if:<br />
</p>
<ul class="org-ul">
<li>For each nontrivial A \(\twoheadrightarrow\) B, A is a key<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org906691f" class="outline-4">
<h4 id="org906691f"><span class="section-number-4">4.1.5</span> <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</h4>
</div>
</div>

<div id="outline-container-org79b09d5" class="outline-3">
<h3 id="relational-design-theory-mini-course-exercises"><a id="org79b09d5"></a><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-relational-design-theory-mini-course-exercises">
<ul class="org-ul">
<li>R(A,B)<br /></li>
<li><del>R(A,C,D)</del><br /></li>
<li>R(A,C)<br /></li>
<li>R(C,D)<br /></li>
</ul>


<ul class="org-ul">
<li>R(C,D)<br /></li>
<li><del>R(A,B,C)</del><br /></li>
<li>R(A,B)<br /></li>
<li>R(A,C)<br /></li>
</ul>


<ul class="org-ul">
<li>R(B,C)<br /></li>
<li><del>R(A,B,D)</del><br /></li>
<li>R(A,B)<br /></li>
<li>R(A,D)<br /></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org2ba581f" class="outline-2">
<h2 id="uml-mini-course"><a id="org2ba581f"></a><span class="section-number-2">5</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/UML/SelfPaced/courseware/ch-unified_modeling_language/">Unified Modeling Language</a> mini-course</h2>
<div class="outline-text-2" id="text-uml-mini-course">
</div>
<div id="outline-container-org6c5d8d8" class="outline-3">
<h3 id="org6c5d8d8"><span class="section-number-3">5.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orga8d41d9" class="outline-4">
<h4 id="uml-data-modeling"><a id="orga8d41d9"></a><span class="section-number-4">5.1.1</span> <span class="done DONE">DONE</span> UML Data Modeling</h4>
<div class="outline-text-4" id="text-uml-data-modeling">
<p>
Entity-Relationship Model (E/R)<br />
Unified Modeling Language<br />
</p>
<ul class="org-ul">
<li>Data modeling subset<br /></li>
</ul>

<p>
Both are graphical<br />
Both can be translated to relations automatically<br />
</p>
<ul class="org-ul">
<li>Or semi-automatically<br /></li>
</ul>

<p>
UML Data Modeling: 5 concepts<br />
</p>

<ol class="org-ol">
<li>Classes<br /></li>
<li>Associations<br /></li>
<li>Association Classes<br /></li>
<li>Subclasses<br /></li>
<li>Composition &amp; Aggregation<br /></li>
</ol>


<p>
Classes<br />
</p>

<p>
Name, attributes, methods<br />
</p>
<ul class="org-ul">
<li>For data modeling: add "pk", drop methods<br /></li>
</ul>

<pre class="example">
|-----------|
|  Student  |
|-----------|
| sID    pk |
| sName     |
| GPA       |
|-----------|
| &lt;methods&gt; |
|-----------|

|-----------|
| College   |
|-----------|
| cName  pk |
| state     |
|-----------|
| &lt;methods&gt; |
|-----------|
</pre>

<p>
Relationships between objects of two classes<br />
</p>

<pre class="example">
|-----------|           |-----------|
|  Student  |           | College   |
|-----------|  Applied  |-----------|
| sID    pk |-----------| cName  pk |
| sName     |          | state     |
| GPA       |           |-----------|
|-----------|           | &lt;methods&gt; |
| &lt;methods&gt; |           |-----------|
|-----------|
</pre>

<p>
Multiplicity of Associations<br />
</p>

<p>
Each object of class C1 is related to at least m and at most n objects<br />
of class C2<br />
</p>

<pre class="example">
|----|                |----|
| C1 |                | C2 |
|----|        m..n    |----|
|    |----------------|    |
|----|      A         |----|
</pre>

<ul class="org-ul">
<li>m..* at least m<br /></li>
<li>0..n at most n<br /></li>
<li>0..* no restrictions<br /></li>
</ul>

<p>
The default is 1..1<br />
</p>

<ul class="org-ul">
<li>1..1 abbreviated as 1<br /></li>
<li>0..* abbreviated as *<br /></li>
</ul>

<p>
Students must apply somewhere and may not apply to more than 5<br />
colleges.  No college takes more than 20,000 applications.<br />
</p>

<pre class="example">
|-----------|                   |-----------|
|  Student  |                   | College   |
|-----------| 0..20000     1..5 |-----------|
| sID    pk |-------------------| cName  pk |
| sName     |      Applied      | state     |
| GPA       |                   |-----------|
|-----------|                   | &lt;methods&gt; |
| &lt;methods&gt; |                   |-----------|
|-----------|
</pre>

<p>
Types of relationships<br />
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">One-to-One</td>
<td class="org-right">0..1</td>
<td class="org-right">0..1</td>
</tr>

<tr>
<td class="org-left">Many-to-One</td>
<td class="org-right">*</td>
<td class="org-right">0..1</td>
</tr>

<tr>
<td class="org-left">Many-to-Many</td>
<td class="org-right">*</td>
<td class="org-right">a</td>
</tr>

<tr>
<td class="org-left">Complete</td>
<td class="org-right">1..</td>
<td class="org-right">1..</td>
</tr>
</tbody>
</table>

<p>
Default is complete one-to-one<br />
</p>


<p>
Association Classes<br />
</p>

<p>
Relationships between objects of two classes,<br />
</p>
<ul class="org-ul">
<li>with attributes on relationships<br /></li>
</ul>

<pre class="example">
|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------|        Applied           |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>

<p>
It's hard to have more than one relationship association between the<br />
same student and college.<br />
</p>

<p>
Eliminating Association Classes<br />
</p>
<ul class="org-ul">
<li>Unnecessary if 0..1 or 1..1 multiplicity<br /></li>
</ul>

<pre class="example">
|----|                |----|
| C1 |                | C2 |
|----| *         1..1 |----|
| A3 |----------------| A4 |
|----|       |        |----|
           |----|
           | AC |
           |----|
           | A1 |
           | A2 |
           |----|
</pre>

<p>
Self-Associations<br />
</p>

<p>
Associations between a class and itself<br />
</p>

<pre class="example">
|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|


|---------|
| College |home
|---------|------|
|         |1..1  | Branch
|         |0..10 |
|---------|------|
           Satellite
</pre>

<p>
Subclasses<br />
</p>

<pre class="example">
                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                          inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN       |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>

<p>
Superclass = Generalization<br />
Subclass = Specialization<br />
</p>

<p>
Incomplete (Partial) vs. Complete<br />
</p>

<p>
Complete: every obj in the superclass is in at least one subclass<br />
</p>

<p>
Disjoint (Exclusive) vs. Overlapping<br />
</p>

<p>
Disjoint: every obj in the superclass is in at most one subclass<br />
</p>


<p>
Composition &amp; Aggregation<br />
</p>

<p>
Objects of one class belong to objects of another class<br />
</p>

<pre class="example">
|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |--------------| dName      |
| state    |-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>

<p>
The symbol  indicates composition, implicitly specifying 1..1.<br />
Department belongs to College.<br />
</p>

<p>
The symbol  indicates aggregation, implicitly specifying 0..1.<br />
Some apartments are owned by or associated with colleges, but not all<br />
of them are.<br />
</p>
</div>
</div>

<div id="outline-container-org9f6c3c1" class="outline-4">
<h4 id="org9f6c3c1"><span class="section-number-4">5.1.2</span> <span class="done DONE">DONE</span> UML to Relations</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
High-Level Database Design Model<br />
  User-friendly (graphical) specification language<br />
  Translated into model of DBMS<br />
</p>

<p>
Designs can be translated to relations automatically<br />
  Provided every "regular" class has a key<br />
</p>

<p>
Every class becomes a relation: pk -&gt; primary key<br />
</p>

<p>
Associations<br />
</p>

<p>
Relation with key from each side<br />
</p>

<p>
Applied(sID, cName)<br />
</p>

<p>
Keys for association relations depends on multiplicity<br />
</p>

<pre class="example">
|-------|                      |-------|
|  C1   |                      |  C2   |
|-------| 0..1               * |-------|
| K1 pk |----------------------| K2 pk |
| O1    |          A           | O2    |
|-------|                      |-------|
</pre>

<p class="pre">
C1( <span class="underline">K1</span>, O1)<br />
C2( <span class="underline">K2</span>, O2)<br />
</p>

<p class="pre">
A(K1, <span class="underline">K2</span>)<br />
</p>

<pre class="example">
|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------| *      Applied     1..1  |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>

<p class="pre">
Applied( <span class="underline">sID</span>, cName)<br />
</p>

<p class="pre">
C1( <span class="underline">K1</span>, O1)<br />
C2( <span class="underline">K2</span>, O2)  &lt;&#x2013; C2( <span class="underline">K2</span>, O2, K1)<br />
<del>A(K1, <span class="underline">K2</span>)</del><br />
</p>

<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)  &lt;&#x2013; Student( <span class="underline">sID</span>, sName, GPA, cName)<br />
College( <span class="underline">cName</span>, state)<br />
<del>Applied( <span class="underline">sID</span>, cName)</del><br />
</p>

<p>
Association Classes<br />
</p>

<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)<br />
College( <span class="underline">cName</span>, state)<br />
Applied( <span class="underline">sID</span>, cName, date, decision)<br />
</p>

<p>
Require a key for every "regular" class.<br />
</p>

<p>
Self-Associations<br />
</p>

<pre class="example">
|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|
</pre>


<p class="pre">
Student( <span class="underline">sID</span>, sName, GPA)<br />
Sibling( <span class="underline">sID1, sID2</span>)<br />
</p>

<pre class="example">
|----------|
| College  | home
|----------|-------|
| cName pk | 1..1  | Branch
| state    |       |
| enr      | 0..10 |
|----------|-------|
             Satellite
</pre>

<p class="pre">
College( <span class="underline">cName</span>, state, enr)<br />
Branch(home, <span class="underline">satellite</span>)<br />
</p>

<p class="pre">
College( <span class="underline">cName</span>, state, enr, home) ???<br />
</p>


<p>
Subclasses<br />
</p>
<ol class="org-ol">
<li>Subclass relations contain superclass key + specialized attrs.<br /></li>
<li>Subclass relations contain all attributes.<br /></li>
<li>One relation containing all superclass + subclass attrs.<br /></li>
</ol>

<p>
subclasses are not regular classes.<br />
</p>

<pre class="example">
                     |-------|
                     |   S   |  superclass
                     |-------|
                     | K  pk |
                     | A     |
                     |-------|
                                            Subclasses
   |---------------------+-------------------|
   |                                         |
|----|                                     |----|
| S1 |                                     | S2 |
|----|                                     |----|
| B  |                                     | C  |
|----|                                     |----|
</pre>

<ol class="org-ol">
<li>S( <span class="underline">K</span>, A), S1( <span class="underline">K</span>, B), S2( <span class="underline">K</span>, C)<br /></li>
<li>S( <span class="underline">K</span>, A), S1( <span class="underline">K</span>, A, B), S2( <span class="underline">K</span>, A, C)<br /></li>
<li>S( <span class="underline">K</span>, A, B, C)<br /></li>
</ol>

<p>
Heavily overlapping =&gt; design 3<br />
</p>

<p>
Disjoint, Complete =&gt; design 2 with S( <span class="underline">K</span>, A) discarded<br />
</p>

<pre class="example">
                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                          inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN    pk |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>

<p class="pre">
Student( <span class="underline">sID</span>, sName)<br />
ForeignS( <span class="underline">sID</span>, Country)<br />
DomesticS( <span class="underline">sID</span>, State, <span class="underline">SSN</span>)<br />
<del>APStudent(sID)</del> &lt;&#x2013; eliminated, implicated in Took<br />
APCourse( <span class="underline">Course#</span>, title, units)<br />
Took( <span class="underline">sID, Course#</span>, year, grade)<br />
</p>

<p>
Composition &amp; Aggregation<br />
</p>

<pre class="example">
|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |--------------| dName      | Not "regular"
| state    |-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>

<p class="pre">
College( <span class="underline">cName</span>, state)<br />
Department(dName, building, <span class="underline">cName</span>)<br />
Apartment( <span class="underline">addr</span>, #units, cName)<br />
                            <br />
                          nullable<br />
</p>
</div>
</div>
</div>

<div id="outline-container-org36ed050" class="outline-3">
<h3 id="org36ed050"><span class="section-number-3">5.2</span> <span class="done DONE">DONE</span> Exercises</h3>
</div>
</div>


<div id="outline-container-orgda65a8e" class="outline-2">
<h2 id="orgda65a8e"><span class="section-number-2">6</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Indexes/SelfPaced/courseware/ch-indexes/">Indexes and Transactions</a> mini-course</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org3819964" class="outline-3">
<h3 id="org3819964"><span class="section-number-3">6.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-orge9873c6" class="outline-4">
<h4 id="orge9873c6"><span class="section-number-4">6.1.1</span> <span class="done DONE">DONE</span> Indexes</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
Indexes<br />
</p>
<ul class="org-ul">
<li>Primary mechanism to get improved performance<br /></li>
<li>Persistent data structure, stored in database<br /></li>
<li>Many interesting implementation issues<br /></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">A</th>
<th scope="col" class="org-right">B</th>
<th scope="col" class="org-left">C</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-left">dog</td>
<td class="org-right">5</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">cow</td>
<td class="org-right">1</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">dog</td>
<td class="org-right">9</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">5</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">6</td>
<td class="org-left">cat</td>
<td class="org-right">8</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-left">cow</td>
<td class="org-right">6</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#x2026;</td>
<td class="org-right">&#x2026;</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
</table>

<p>
Index on T.A<br />
</p>

<p>
T.A = 'cow'<br />
T.A = 'cat'<br />
</p>

<p>
Index on T.B<br />
</p>

<p>
T.B = 2<br />
T.B &lt; 6<br />
4 &lt; T.B &lt;= 8<br />
</p>

<p>
Index on T.(A, B)<br />
</p>

<p>
T.A = 'cat' and T.B &gt; 5<br />
T.A &lt; 'd' and T.B = 1<br />
</p>

<p>
Utility<br />
</p>
<ul class="org-ul">
<li>Index = difference between full table scans and immediate location<br />
of tuples<br />
<ul class="org-ul">
<li>Orders of magnitude performance difference<br /></li>
</ul></li>

<li>Underlying data structures<br />
<ul class="org-ul">
<li>Balanced trees (B trees, B+ trees)<br />
<ul class="org-ul">
<li>A = V, A &lt; V, V1 &lt;= A &lt;= V2<br /></li>
<li>logarithmic time<br /></li>
</ul></li>
<li>Hash tables<br />
<ul class="org-ul">
<li>constant time<br /></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName
<span class="org-keyword">From</span> student
<span class="org-keyword">Where</span> sID = 18942
</pre>
</div>

<p>
Index on sID<br />
</p>

<p>
Many DBMS's build indexes automatically on PRIMARY KEY (and sometimes<br />
UNIQUE) attributes<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sID
<span class="org-keyword">From</span> Student
<span class="org-keyword">Where</span> sName = <span class="org-string">'Mary'</span> <span class="org-keyword">And</span> GPA &gt; 3.9
</pre>
</div>

<p>
Index on sName  hash or tree<br />
Index on GPA  tree-based<br />
Index on (sName, GPA)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName, cName
<span class="org-keyword">From</span> Student, Apply
<span class="org-keyword">Where</span> Student.sID = Apply.sID
</pre>
</div>

<p>
Index on student.sid or apply.sid or both<br />
</p>

<p>
Query planning &amp; optimization<br />
</p>


<p>
Downsides of Indexes<br />
</p>

<ol class="org-ol">
<li>Extra space - marginal<br /></li>
<li>Index creation - medium<br /></li>
<li>Index maintenance - can offset benefits<br /></li>
</ol>

<p>
Picking which indexes to create<br />
</p>

<p>
Benefits of an index depends on:<br />
</p>
<ul class="org-ul">
<li>Size of table (and possibly layout)<br /></li>
<li>Data distributions<br /></li>
<li>Query vs. update load<br /></li>
</ul>


<p>
"Physical design advisors"<br />
</p>

<p>
Input: database (statistics) and workload<br />
Output: recommended indexes<br />
</p>

<p>
<span class="underline">Query Optimizer</span> takes <span class="underline">Database statistics</span>, <span class="underline">Query or update</span>, and<br />
<span class="underline">indexes</span> as input and gives <span class="underline">best execution plan with estimated cost</span><br />
as output.<br />
</p>

<p>
Physical design advisor experiments different indexes through query<br />
optimizer and gives recommended indexes, of which benefits outweigh<br />
drawbacks.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A1, A2, ..., An)
<span class="org-keyword">Create</span> <span class="org-keyword">Unique</span> Index IndexName <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Drop</span> Index IndexName
</pre>
</div>
</div>
</div>

<div id="outline-container-org56260cb" class="outline-4">
<h4 id="org56260cb"><span class="section-number-4">6.1.2</span> <span class="done DONE">DONE</span> Introduction to Transactions</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
Motivated by two independent requirements<br />
</p>
<ul class="org-ul">
<li>Concurrent database access<br /></li>
<li>Resilience to system failures<br /></li>
</ul>

<p>
<b>Concurrent Access</b>: Attribute-level Inconsistency <a id="orga898020"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1500
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>

<p>
get; modify; put<br />
</p>

<p>
Possible outcomes<br />
</p>
\begin{align*}
  15,000 + 2500 &amp;= 17,500 \\
         + 1000 &amp;= 16,000 \\
         + 1500 &amp;= 16,500
\end{align*}

<p>
<b>Concurrent Access</b>: Tuple-level Inconsistency <a id="org786d32e"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>

<p>
get; modify; put<br />
</p>

<p>
both changes<br />
one of the two changes<br />
</p>

<p>
<b>Concurrent Access</b>: Table-level Inconsistency <a id="org16b250d"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span>
<span class="org-keyword">Where</span> sID <span class="org-keyword">In</span> (<span class="org-keyword">Select</span> sID <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> GPA &gt; 3.9)
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>

<p>
<b>Concurrent Access</b>: Multi-statement inconsistency <a id="orgcc9e6a4"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Apply;
<span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Archive;
</pre>
</div>

<p>
Concurrency Goal<br />
</p>

<p>
Execute <i>sequence of SQL statements</i> so they appear to be running in<br />
isolation<br />
</p>

<ul class="org-ul">
<li>Simple solution: execute them in isolation<br /></li>
</ul>

<p>
But want to enable concurrency whenever safe to do so<br />
</p>

<ul class="org-ul">
<li>Multiprocessor<br /></li>
<li>Multithreaded<br /></li>
<li>Asynchronous I/O<br /></li>
</ul>

<p>
Resilience to System Failures<br />
</p>

<p>
Rather unpleasant inconsistent state can occur due to crashes when<br />
there bulk loading to DBMS<br />
</p>

<p>
Or<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>

<p>
Crash failure<br />
</p>

<p>
Lots of updates buffered in memory<br />
</p>

<p>
System-Failure Goal<br />
</p>

<p>
Guarantee all-or-nothing execution, regardless of failures<br />
</p>

<p>
Solution for both concurrency and failures<br />
</p>

<p>
<b>Transactions</b><br />
</p>

<p>
A transaction is a sequence of one or more SQL operations treated as a<br />
unit<br />
</p>
<ul class="org-ul">
<li>Transactions appear to run in isolation<br /></li>
<li>If the system fails, each transaction's changes are reflected<br />
either entirely or not at all<br /></li>
</ul>

<p>
SQL standard:<br />
</p>
<ul class="org-ul">
<li>Transaction begins automatically on first SQL statement<br /></li>
<li>On "commit" transaction ends and new one begins<br /></li>
<li>Current transaction ends on session termination<br /></li>
<li>"Autocommit" turns each statement into transaction<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org0b13657" class="outline-4">
<h4 id="org0b13657"><span class="section-number-4">6.1.3</span> <span class="done DONE">DONE</span> Transaction Properties</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
ACID Properties<br />
Atomicity, Consistency, Isolation, Durability<br />
</p>

<p>
Isolation<br />
</p>

<p>
<span class="underline">Serializability</span>  <a id="org6a7b5ea"></a><br />
Operations may be interleaved, but execution must be equivalent to<br />
<i>some</i> sequential (serial) order of all transactions<br />
</p>

<p>
locking portion of the database<br />
</p>

<p>
<a href="#orga898020">Attribute-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
15,000  17,500<br />
</p>

<p>
<a href="#org786d32e">Tuple-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
both changes<br />
</p>

<p>
<a href="#org16b250d">Table-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
Order matters here.<br />
</p>

<p>
<a href="#orgcc9e6a4">Multi-statement inconsistency</a><br />
</p>

<p>
Order also matters here.<br />
</p>

<p>
Durability<br />
</p>

<p>
If system crashes after transaction commits, all effects of<br />
transaction remain in database.<br />
</p>

<p>
T2 {S1; S2; S3; commit} crashes<br />
</p>

<p>
implemented by logging<br />
</p>

<p>
Atomicity<br />
</p>

<p>
Each transaction is "all-or-nothing," never left half done<br />
</p>

<p>
T2 { S1; S2; &#x2026; crashes &#x2026;; commit }<br />
</p>

<p>
Logging<br />
</p>

<p>
Transaction Rollback (= Abort) <br />
</p>
<ul class="org-ul">
<li>Undoes <span class="underline">partial effects</span> of transaction<br /></li>
<li>Can be <span class="underline">system</span> or <span class="underline">client initiated</span><br /></li>
</ul>

<pre class="example">
Begin Transaction;
&lt;get input from user&gt;
SQL commands based on input
&lt;confirm results with user&gt;
If ans = 'ok' Then Commit; Else Rollback;
</pre>

<p>
Rollback only undoes data itself on database, but doesn't affect<br />
variable, and cash delivery etc.<br />
</p>

<p>
Never hold a transaction for long time.  Locking<br />
</p>

<p>
Consistency<br />
</p>

<p>
Each client, each transaction:<br />
</p>
<ul class="org-ul">
<li>Can assume all constraints hold when transaction begins<br /></li>
<li>Must guarantee all constraints hold when transaction ends<br /></li>
</ul>

<p>
Serializability  constraints always hold<br />
</p>
</div>
</div>

<div id="outline-container-org3604f8b" class="outline-4">
<h4 id="org3604f8b"><span class="section-number-4">6.1.4</span> <span class="done DONE">DONE</span> Isolation Levels</h4>
<div class="outline-text-4" id="text-6-1-4">
<p>
<a href="#org6a7b5ea">Serializability</a>  Overhead, Reduction in concurrency<br />
</p>

<p>
Weaker "Isolation Levels" (from weak to strong)<br />
</p>
<ul class="org-ul">
<li>Read Uncommitted<br /></li>
<li>Read Committed<br /></li>
<li>Repeatable Read<br /></li>
<li>Serializable<br /></li>
</ul>

<p>
 Overhead  Concurrency<br />
 Consistency Guarantees<br />
</p>

<p>
Isolation Levels<br />
</p>
<ul class="org-ul">
<li>Per transaction<br /></li>
<li>"In the eye of the beholder"<br /></li>
</ul>

<p>
Dirty Reads<br />
"Dirty" data item: written by an uncommitted transaction<br />
</p>

<p>
Example 1<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(enrollment) <span class="org-keyword">From</span> College
</pre>
</div>

<p>
Example 2<br />
</p>
<div class="org-src-container">
<pre class="src src-sql" id="org198a43c"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> GPA <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 2600 <span class="org-keyword">Where</span> sID = 234
</pre>
</div>

<p>
There is no such thing as dirty read within the same transaction.<br />
</p>

<p>
Isolation Level: Read Uncommitted<br />
</p>
<ul class="org-ul">
<li>A transaction may perform dirty reads<br /></li>
</ul>

<p>
<a href="#org198a43c">Query</a> concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Uncommitted</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Read Committed<br />
</p>
<ul class="org-ul">
<li>A transaction may <i>not</i> perform dirty reads<br /></li>
</ul>

<p>
Still does not guarantee global serializability<br />
</p>

<p>
<a href="#org198a43c">Query</a> concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Committed</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Repeatable Read<br />
</p>
<ul class="org-ul">
<li>A transaction may not perform dirty reads<br /></li>
<li>An item read multiple times cannot change value<br /></li>
</ul>

<p>
Still does not guarantee global serializability<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA;
<span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 1500 <span class="org-keyword">where</span> sID = 123;
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(sizeHS) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Neither T1; T2 Nor T2; T1<br />
</p>

<p>
But a relation <i>can</i> change: "phantom" tuples<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Student <span class="org-comment">-- [100 new tuples]</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql" id="org8dfe903"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
The inserted tuples are called phantom tuples<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Student <span class="org-comment">-- [100 tuples]</span>
</pre>
</div>
<p>
concurrent with <a href="#org8dfe903">Query</a><br />
</p>

<p>
T1 must occur either before or after T2<br />
</p>

<p>
Read Only transactions<br />
</p>
<ul class="org-ul">
<li>Helps system optimize performance<br /></li>
<li>Independent of isolation level<br /></li>
</ul>

<p>
Orthogonal to isolation level<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Read</span> <span class="org-keyword">Only</span>;
<span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Levels: Summary<br />
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">dirty Reads</th>
<th scope="col" class="org-left">nonrepeatable reads</th>
<th scope="col" class="org-left">phantoms</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Read Uncommitted</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Read Committed</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Repeatable Read</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Serializable</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Standard default: Serializable<br /></li>
<li>Weaker isolation levels<br />
<ul class="org-ul">
<li>Increased concurrency + decreased overhead =<br />
increased performance<br /></li>
<li>Weaker consistency guarantees<br /></li>
<li>Some systems have default Repeatable Read<br /></li>
</ul></li>
<li>Isolation level per transaction and "eye of the beholder"<br />
<ul class="org-ul">
<li>Each transaction's reads must conform to its isolation level<br /></li>
</ul></li>
</ul>

<p>
Note: An entire workload is globally serializable only if every<br />
transaction's isolation level is serializable.<br />
</p>
</div>
</div>
</div>

<div id="outline-container-org4e1aac3" class="outline-3">
<h3 id="org4e1aac3"><span class="section-number-3">6.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org8103cc1" class="outline-4">
<h4 id="org8103cc1"><span class="section-number-4">6.2.1</span> <span class="done DONE">DONE</span> Index Quiz</h4>
<div class="outline-text-4" id="text-6-2-1">
</div>
</div>
<div id="outline-container-orgadd34de" class="outline-4">
<h4 id="orgadd34de"><span class="section-number-4">6.2.2</span> <span class="done DONE">DONE</span> Transaction Quiz</h4>
<div class="outline-text-4" id="text-6-2-2">
</div>
</div>
</div>
</div>


<div id="outline-container-org44099e0" class="outline-2">
<h2 id="org44099e0"><span class="section-number-2">7</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Constraints/SelfPaced/courseware/ch-constraints_and_triggers/">Constraints and Triggers</a> mini-course</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orgc2d2801" class="outline-3">
<h3 id="orgc2d2801"><span class="section-number-3">7.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-7-1">
</div>
<div id="outline-container-orge57a2bc" class="outline-4">
<h4 id="orge57a2bc"><span class="section-number-4">7.1.1</span> <span class="done DONE">DONE</span> Motivation and Overview</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
(Integrity) Constraints  &lt;static&gt;<br />
  constrain allowable database states<br />
</p>


<p>
Triggers &lt;dynamic&gt;<br />
  monitor database changes,<br />
  check conditions and initiate actions<br />
</p>


<p>
Integrity Constraints<br />
  Impose restrictions on allowable data, beyond those imposed by<br />
  structure and types<br />
</p>


<p>
0.0 &lt; GPA &lt;= 4.0<br />
enrollment &lt; 50,000 (75,000)<br />
</p>


<p>
Why use them?<br />
  Data-entry errors (inserts)<br />
  Correctness criteria (updates)<br />
  Enforce consistency<br />
  Tell system about data<br />
</p>


<p>
Classification<br />
  Non-null<br />
  Key<br />
  Referential Integrity (foreign key)<br />
</p>


<p>
Declaring and enforcing constraints<br />
</p>

<p>
Declaration<br />
</p>
<ul class="org-ul">
<li>With original schema - checked after bulk loading<br /></li>
<li>Or later - checked on current DB<br /></li>
</ul>


<p>
Enforcement<br />
</p>
<ul class="org-ul">
<li>Check after every "dangerous" modification<br /></li>
<li>Deferred constraint checking (transaction)<br /></li>
</ul>


<p>
Triggers<br />
"Event-Condition-Action Rules"<br />
When <i>event</i> occurs, check <i>condition</i>; if true, do action<br />
</p>


<p>
Examples<br />
  enrollment &gt; 35,000 -&gt; reject all applicants<br />
  insert app with GPA &gt; 3.95 -&gt; accept automatically<br />
  update sizeHS to be &gt; 7,000 -&gt; change to "wrong", raise error<br />
</p>


<p>
Why use them?<br />
More logic from apps into DBMS<br />
To enforce constraints<br />
</p>
<ul class="org-ul">
<li>expressive<br /></li>
<li>constraint "repair" logic<br /></li>
</ul>




<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span>|<span class="org-keyword">After</span>|Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Constraints and Triggers<br />
</p>
<ul class="org-ul">
<li>For relational databases<br /></li>
<li>SQL standard; systems vary considerably<br /></li>
</ul>

<p>
(Integrity) Constraints<br />
</p>
<ul class="org-ul">
<li>constrain allowable database states<br /></li>
</ul>

<p>
Triggers<br />
</p>
<ul class="org-ul">
<li>monitor database changes,<br /></li>
<li>check conditions and initiate actions<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orgba9516a" class="outline-4">
<h4 id="orgba9516a"><span class="section-number-4">7.1.2</span> <span class="done DONE">DONE</span> Constraints of Several Types</h4>
<div class="outline-text-4" id="text-7-1-2">
<p>
Integrity Constraints<br />
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by structure and types<br />
<ul class="org-ul">
<li>Non-null constraints<br /></li>
<li>Key constraints<br /></li>
<li>Attribute-based and tuple-based constraints (limits)<br /></li>
<li>General assertions (not implemented by any database)<br /></li>
</ul></li>
</ul>

<p>
Not all constraints are implemented.<br />
</p>

<p>
Constraints Demo<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Craig'</span>, <span class="org-keyword">null</span>, 500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed</span>
<span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 456; <span class="org-comment">-- succeed since 456 doesn't exist</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Craig'</span>, 3.5, 500); <span class="org-comment">-- failed, key error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = 123 <span class="org-keyword">where</span> sName = <span class="org-string">'Bob'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID - 111; <span class="org-comment">-- succeed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID + 111; <span class="org-comment">-- failed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text <span class="org-keyword">unique</span>,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Amy'</span>, 3.5, 500); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (456, <span class="org-string">'Doris'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (567, <span class="org-string">'Amy'</span>, 3.8, 1500); <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (cName, <span class="org-keyword">state</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 10000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'NY'</span>, 5000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 2000);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">unique</span>(sID, cName),
    <span class="org-keyword">unique</span>(sID, major)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above succeed.  SQL standard and most systems allow<br />
duplicate null values for unique key.  Most systems do not permit<br />
repeated null values for primary key.<br />
</p>


<p>
Attribute check constraint<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA &lt;= 4.0 <span class="org-keyword">and</span> GPA &gt; 0.0),
    sizeHS <span class="org-type">int</span> <span class="org-keyword">check</span>(sizeHS &lt; 5000)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 4.6, 1500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(decision = <span class="org-string">'N'</span> <span class="org-keyword">or</span> cName &lt;&gt; <span class="org-string">'Stanford'</span> <span class="org-keyword">or</span> major &lt;&gt; <span class="org-string">'CS'</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'N'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>;
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<p>
Both queries failed on SQLite and Postgres, but not in MySQL (MySQL sucks).<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>),
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<p>
The above is equivalent to <code>GPA real not null</code>.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>(A <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> A <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
The above check constraint implements key constraint.  It fails on<br />
SQLite for several reasons.  The order of execution and check matters.<br />
It works for at least some database system.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
                (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
No known database allows subquery, esp. aggregation, in check<br />
expression, so the above query also doesn't work.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
The above table definitions is valid according to SQL standards but no<br />
database implements subquery in check constraint.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    <span class="org-keyword">check</span>(enrollment &gt; (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(sizeHS) <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
Also valid in SQL standard but no database allows this.  Now, suppose<br />
this works for some system, it has other problems.  When student table<br />
changes, the check constraint may no longer be valid.<br />
</p>


<p>
General Assertions<br />
</p>
<ul class="org-ul">
<li>They are very powerful but unfortunately not implemented by any RDBMS.<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> <span class="org-keyword">Key</span>
<span class="org-keyword">check</span> ((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
       (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> ReferentialIntegrity
<span class="org-keyword">check</span>  (<span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student)));
</pre>
</div>

<p>
It's common to write <code>not exists</code> in general assertions.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> AvgAccept
<span class="org-keyword">check</span> (3.0 &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> sID <span class="org-keyword">in</span>
                (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> decision = <span class="org-string">'Y'</span>)));
</pre>
</div>
</div>
</div>

<div id="outline-container-org6297c7e" class="outline-4">
<h4 id="org6297c7e"><span class="section-number-4">7.1.3</span> <span class="done DONE">DONE</span> Referential Integrity</h4>
<div class="outline-text-4" id="text-7-1-3">
<p>
Integrity Constraints<br />
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by<br />
structure and types<br /></li>
</ul>

<p>
Referential integrity = Integrity of references = No "dangling pointers"<br />
</p>


<p>
Referential integrity from R.A to S.B<br />
</p>
<ul class="org-ul">
<li>Each value in column A of table R must appear in column B of table S<br />
<ul class="org-ul">
<li>A is called the "foreign key" (Foreign key constraints)<br /></li>
<li>B is usually required to be the <i>primary key</i> for table S or at least <i>unique</i><br /></li>
<li>Multi-attribute foreign keys are allowed<br /></li>
</ul></li>
</ul>

<p>
Referential integrity is directional<br />
</p>

<p>
Referential Integrity Enforcement (R.A to S.B)<br />
</p>
<ul class="org-ul">
<li>Potentially violating modifications:<br />
<ul class="org-ul">
<li>Insert into R<br /></li>
<li>Delete from S<br /></li>
<li>Update R.A<br /></li>
<li>Update S.B<br /></li>
</ul></li>
</ul>

<p>
Special actions:<br />
</p>
<ul class="org-ul">
<li>Delete from S<br />
<ul class="org-ul">
<li>Delete from S<br />
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code><br /></li>
</ul></li>
<li>Update S.B<br />
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code><br /></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID),
    cName text <span class="org-keyword">references</span> College(cName),
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above failed.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Stanford'</span>, <span class="org-string">'CA'</span>, 15000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Berkeley'</span>, <span class="org-string">'CA'</span>, 36000);
</pre>
</div>

<p>
After executing the above queries, the previous queries succeed.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 345 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed, break referential integrity</span>
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 234 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- succeed</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>; <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 234;          <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 123;          <span class="org-comment">-- succeed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = <span class="org-string">'Bezerkeley'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>; <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>;             <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">set</span> <span class="org-keyword">null</span>,
    cName text <span class="org-keyword">references</span> College(cName) <span class="org-keyword">on</span> <span class="org-keyword">update</span> <span class="org-keyword">cascade</span>,
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID &gt; 200;
</pre>
</div>

<p>
The Bezerkeley query now succeeds.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span> (
    A <span class="org-type">int</span>,
    B <span class="org-type">int</span>,
    C <span class="org-type">int</span>,
    <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (A, B),
    <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (B, C) <span class="org-keyword">references</span> T(A, B) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">cascade</span>
);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (1, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (2, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (3, 2, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (4, 3, 2);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (5, 4, 3);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (6, 5, 4);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (7, 6, 5);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (8, 7, 6);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> T <span class="org-keyword">where</span> A = 1;
</pre>
</div>

<p>
The above query will delete all the rows in T.<br />
</p>
</div>
</div>

<div id="outline-container-org9149f74" class="outline-4">
<h4 id="org9149f74"><span class="section-number-4">7.1.4</span> <span class="done DONE">DONE</span> Triggers Introduction</h4>
<div class="outline-text-4" id="text-7-1-4">
<p>
Triggers<br />
</p>
<ul class="org-ul">
<li>"Event-Condition-Action Rules"<br /></li>
<li>When <i>event</i> occurs, check condition; if true, do action<br />
<ol class="org-ol">
<li>Move monitoring logic from apps into DBMS<br /></li>
<li>Enforce constraints<br />
<ul class="org-ul">
<li>Beyond what constraint system supports<br /></li>
<li>Automatic constraint "repair"<br /></li>
</ul></li>
</ol></li>
</ul>

<p>
<b>Implementations vary significantly</b><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span> | <span class="org-keyword">After</span> | Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Events are one of <code>insert on T</code>, <code>delete on T</code>, <code>update [of C1, ..., Cn] on T</code>.<br />
</p>

<p>
<code>[For Each Row]</code> means that the triggers should be executed once for<br />
each modified tuple.<br />
</p>

<p>
When event is an insert, <code>referencing-variables</code> can only reference<br />
the newly inserted data.  When event is a delete, <code>referencing-variables</code><br />
can only reference the old deleted data.  When event is an update,<br />
<code>referencing-variables</code> can reference both old and new data.<br />
</p>

<p>
If a row-level trigger is concerned and the event is a delete, we can<br />
refer both the old row and old table as different variables.  Old<br />
table does not refer to the old state of the table in the database but<br />
specifically refers to the rows deleted in the delete event.<br />
</p>

<p>
If a statement-level trigger is concerned, only table can be referenced.<br />
</p>

<p>
<code>(Condition)</code> is like SQL <code>where</code> clause.<br />
</p>

<p>
<code>action</code> is the action to be performed when triggered.  This is where<br />
various database systems differ.<br />
</p>

<p>
Referential Integrity:<br />
</p>
<ul class="org-ul">
<li>R.A references S.B, cascaded delete<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> O
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A = O.B
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> OT
<span class="org-comment">-- [ For Each Row ]</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A <span class="org-keyword">in</span> (<span class="org-keyword">Select</span> B <span class="org-keyword">from</span> OT)
</pre>
</div>


<p>
Tricky Issues<br />
</p>

<ul class="org-ul">
<li>Row-level vs. Statement-level<br />
<ul class="org-ul">
<li>New/Old Row and New/Old Table<br /></li>
<li>Before, Instead Of<br /></li>
</ul></li>

<li>Multiple triggers activated at same time<br /></li>

<li>Trigger actions activating other triggers (chaining)<br />
<ul class="org-ul">
<li>Also self-triggering, cycles, nested invocations<br /></li>
</ul></li>

<li>Conditions in <code>When</code> vs. as part of <code>action</code><br /></li>
</ul>


<p>
SQLite supports only row-level triggers.<br />
</p>

<p>
T(K,V) - K key, V value<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-function-name">IncreaseInserts</span>
<span class="org-keyword">After</span> <span class="org-keyword">Insert</span> <span class="org-keyword">On</span> T
<span class="org-keyword">Referencing</span> <span class="org-keyword">New</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> NR, <span class="org-keyword">New</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> NT
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-keyword">When</span> (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> T) &lt;
     (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> NT)
<span class="org-keyword">Update</span> T <span class="org-keyword">set</span> V=V+10 <span class="org-keyword">where</span> K=NR.K
</pre>
</div>

<ul class="org-ul">
<li>No statement-level equivalent<br /></li>
<li>Nondeterministic final state<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orga0fbef4" class="outline-4">
<h4 id="orga0fbef4"><span class="section-number-4">7.1.5</span> <span class="done DONE">DONE</span> Triggers Demo</h4>
<div class="outline-text-4" id="text-7-1-5">
<ul class="org-ul">
<li>Before and After; Insert, Delete, and Update<br /></li>
<li>New and Old<br /></li>
<li>Conditions and actions<br /></li>
<li>Triggers enforcing constraints<br /></li>
<li>Trigger chaining<br /></li>
<li>Self-triggering, cycles<br /></li>
<li>Conflicts<br /></li>
<li>Nested trigger invocations<br /></li>
</ul>

<p>
Introduction video used SQL standard<br />
</p>
<ul class="org-ul">
<li>No DBMS implements exact standard<br /></li>
<li>Some deviate considerably<br />
<ul class="org-ul">
<li>In both syntax and behavior!<br /></li>
</ul></li>
</ul>

<p>
Postgres &gt; SQLite &gt;&gt; MySQL<br />
</p>

<p>
Postgres<br />
</p>
<ul class="org-ul">
<li>Expressiveness/behavior = full standard<br />
row-level + statement-level, old/new row &amp; table<br /></li>
<li>Cumbersome &amp; awkward syntax<br /></li>
</ul>

<p>
SQLite<br />
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table<br /></li>
</ul>

<p>
MySQL<br />
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table<br /></li>
<li>Only one trigger per event type<br /></li>
<li>Limited trigger chaining<br /></li>
</ul>


<p>
SQLite - row-level triggers, immediate activation<br />
</p>
<ul class="org-ul">
<li><code>For Each Row</code> implicit if not specified<br /></li>
<li>No <code>Old Table</code> or <code>New Table</code><br /></li>
<li>No <code>Referencing</code> clause<br />
<ul class="org-ul">
<li><code>Old</code> and <code>New</code> predefined for <code>Old Row</code> and <code>New Row</code><br /></li>
</ul></li>
<li>Trigger action: SQL statements in <code>begin-end</code> block<br /></li>
</ul>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.GPA &gt; 3.3 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.GPA &lt;= 3.6
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'Stanford'</span>, <span class="org-string">'geology'</span>, <span class="org-keyword">null</span>);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> cName = <span class="org-keyword">New</span>.cName
    <span class="org-keyword">where</span> cName = <span class="org-keyword">Old</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R4</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R5</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R6</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName) &gt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = cName || <span class="org-string">'-Done'</span>
    <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>               <span class="org-comment">-- alternative version using after</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">AutoAccept</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">New</span>.cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span>
      3.7 &lt; (<span class="org-keyword">select</span> GPA <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID) <span class="org-keyword">and</span>
      1200 &lt; (<span class="org-keyword">select</span> sizeHS <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID))
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>
    <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID
          <span class="org-keyword">and</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">TooMany</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> enrollment <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">Old</span>.enrollment &lt;= 16000 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.enrollment &gt; 16000)
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName <span class="org-keyword">and</span> major = <span class="org-string">'EE'</span>;
    <span class="org-keyword">update</span> Apply
        <span class="org-keyword">set</span> decision = <span class="org-string">'U'</span>
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName
              <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>


<p>
self-triggering<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The above query won't enter infinite loop since SQLite disallow a<br />
trigger to be triggered more than once in a trigger processing<br />
session.  But if we like, we can turn on <code>recursive_triggers</code> on.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
trigger each other in a cycle<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 100
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 2;
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> T1 <span class="org-keyword">where</span> A = 2)
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 3;
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The second trigger is executed first in SQLite.<br />
</p>


<p>
nested trigger invocation<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (1);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (2);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (2);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (3);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
immediate activation semantics of SQLite for triggers<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">select</span> <span class="org-builtin">avg</span>(A) <span class="org-keyword">from</span> T1;
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org81204d0" class="outline-3">
<h3 id="org81204d0"><span class="section-number-3">7.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-orgad623f0" class="outline-4">
<h4 id="orgad623f0"><span class="section-number-4">7.2.1</span> <span class="done DONE">DONE</span> Constraints and Triggers</h4>
<div class="outline-text-4" id="text-7-2-1">
</div>
</div>
<div id="outline-container-org03c4999" class="outline-4">
<h4 id="org03c4999"><span class="section-number-4">7.2.2</span> <span class="done DONE">DONE</span> SQL Social-Network Triggers</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">FriendSameGrade</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.<span class="org-keyword">name</span> = <span class="org-string">'Friendly'</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Likes
  <span class="org-keyword">select</span> <span class="org-keyword">New</span>.ID, ID
  <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> grade = <span class="org-keyword">New</span>.grade <span class="org-keyword">and</span> ID &lt;&gt; <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &lt; 9 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = <span class="org-keyword">null</span>
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade <span class="org-keyword">is</span> <span class="org-keyword">null</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = 9
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend1</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID1;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">or</span> <span class="org-keyword">ignore</span> <span class="org-keyword">into</span> Friend
  <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.ID2, <span class="org-keyword">New</span>.ID1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">GoUpOneGrade</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.grade + 1 = <span class="org-keyword">New</span>.grade
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = grade + 1
  <span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend
               <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Unfriend</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Likes
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.ID1 = <span class="org-keyword">New</span>.ID1 <span class="org-keyword">and</span> <span class="org-keyword">Old</span>.ID2 &lt;&gt; <span class="org-keyword">New</span>.ID2
     <span class="org-keyword">and</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ((ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
         <span class="org-keyword">or</span> (ID1 = <span class="org-keyword">New</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID2));
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd357445" class="outline-2">
<h2 id="views-and-authorization-mini-course"><a id="orgd357445"></a><span class="section-number-2">8</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> <a href="https://lagunita.stanford.edu/courses/DB/Views/SelfPaced/courseware/ch-views/">Views and Authorization</a> mini-course</h2>
<div class="outline-text-2" id="text-views-and-authorization-mini-course">
</div>
<div id="outline-container-orga9f9185" class="outline-3">
<h3 id="views-and-authorization-mini-course-lectures"><a id="orga9f9185"></a><span class="section-number-3">8.1</span> <span class="todo IN_PROGRESS">IN-PROGRESS</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-views-and-authorization-mini-course-lectures">
</div>
<div id="outline-container-orgd2ef9ed" class="outline-4">
<h4 id="defining-and-using-views"><a id="orgd2ef9ed"></a><span class="section-number-4">8.1.1</span> <span class="done DONE">DONE</span> Defining and Using Views</h4>
<div class="outline-text-4" id="text-defining-and-using-views">
<p>
Three-level vision of database<br />
</p>
<ul class="org-ul">
<li>Physical - Conceptual - Logical<br /></li>
</ul>

<p>
Why use views?<br />
</p>
<ul class="org-ul">
<li>Hide some data from some users<br /></li>
<li>Make some queries easier/more natural<br /></li>
<li>Modularity of database access<br /></li>
</ul>

<p>
Real applications tend to use lots and lots (and lots and lots!) of<br />
views<br />
</p>

<p>
Defining and using views<br />
</p>
<ul class="org-ul">
<li>View \(V = \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n)\)<br /></li>
<li>Schema of \(V\) is schema of query result<br /></li>
<li><p>
Query \(Q\) involving \(V\), conceptually:<br />
</p>
\begin{align*}
    &V := \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n) \\
    &\mathrm{Evaluate}\ Q
\end{align*}</li>
<li>In reality, \(Q\) rewritten to use \(R_1, \dotsc, R_n\) instead of \(V\)<br /></li>
<li>Notes: \(R_i\) could itself be a view<br /></li>
</ul>

<p>
SQL Syntax<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">View</span> <span class="org-function-name">Vname</span> <span class="org-keyword">as</span>
&lt;Query&gt;

<span class="org-keyword">Create</span> <span class="org-keyword">View</span> <span class="org-function-name">Vname</span>(A1, A2, ..., An) <span class="org-keyword">As</span>
&lt;Query&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
The above query is conceptually equivalent to the following.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">temporary</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;

<span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, T
<span class="org-keyword">where</span> Student.sID = T.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;

<span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>;
</pre>
</div>

<p>
Some simple RDBMS often rewrites as the following.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Stuent.sID, sName, GPA
<span class="org-keyword">from</span> Student,
     (<span class="org-keyword">select</span> sID, cName <span class="org-keyword">from</span> Apply
      <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>) <span class="org-keyword">as</span> CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
More powerful RDBMS rewrites as the following.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
      <span class="org-keyword">and</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">and</span> GPA &lt; 3.8;
</pre>
</div>

<p>
Views that use other views<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSberk</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, sName, GPA
<span class="org-keyword">from</span> Student, CSaccept
<span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> sizeHS &gt; 500;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> * <span class="org-keyword">from</span> CSberk <span class="org-keyword">where</span> GPA &gt; 3.8;
</pre>
</div>

<p>
Naive rewrite<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> * <span class="org-keyword">from</span>
(<span class="org-keyword">select</span> Student.sID, sName, GPA
 <span class="org-keyword">from</span> Student, (<span class="org-keyword">select</span> sID, cName <span class="org-keyword">from</span> Apply
                <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>) <span class="org-keyword">as</span> CSaccept
 <span class="org-keyword">where</span> Student.sID = CSaccept.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> sizeHS &gt; 500) CSberk
<span class="org-keyword">where</span> GPA &gt; 3.8;
</pre>
</div>

<p>
Flattened rewrite<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
      <span class="org-keyword">and</span> Student.sID = Apply.sID <span class="org-keyword">and</span> Apply.cName = <span class="org-string">'Berkeley'</span>
      <span class="org-keyword">and</span> sizeHS &gt; 500 <span class="org-keyword">and</span> GPA &gt; 3.8;
</pre>
</div>

<p>
The following will result in an error under PostgreSQL since other objects depend on<br />
<code>CSaccept</code>.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept</span>;
</pre>
</div>

<p>
However, under both SQLite and MySQL, the error is not thrown until we<br />
try tot use <code>CSberk</code>.<br />
</p>

<p>
The following probably won't be what you want to do for large<br />
database.  Additionally, this is what Martin Fowler might refer to as<br />
natural aggregate.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Mega</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> College.cName, <span class="org-keyword">state</span>, enrollment,
       Student.sID, sName, GPA, sizeHS, major, decision
<span class="org-keyword">from</span> College, Student, Apply
<span class="org-keyword">where</span> College.cName = Apply.cName <span class="org-keyword">and</span> Student.sID = Apply.sID;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> sID, sName, GPA, cName
<span class="org-keyword">from</span> Mega
<span class="org-keyword">where</span> GPA &gt; 3.5 <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> enrollment &gt; 15000;
</pre>
</div>

<p>
Flattened rewrite<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> Student.sID, sName, GPA, College.cName
<span class="org-keyword">from</span> College, Student, Apply
<span class="org-keyword">where</span> College.cName = Apply.cName <span class="org-keyword">and</span> Student.sID = Apply.sID
      <span class="org-keyword">and</span> GPA &gt; 3.5 <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> enrollment &gt; 15000;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3487ee4" class="outline-4">
<h4 id="views-modifications-introduction"><a id="org3487ee4"></a><span class="section-number-4">8.1.2</span> <span class="done DONE">DONE</span> View Modifications - Introduction</h4>
<div class="outline-text-4" id="text-views-modifications-introduction">
<p>
Querying views<br />
</p>
<ul class="org-ul">
<li>Once \(V\) defined, can reference \(V\) like any table<br /></li>
<li>Queries involving \(V\) rewritten to use base tables<br /></li>
</ul>

<p>
Modifying views<br />
</p>
<ul class="org-ul">
<li>Once \(V\) defined, can we modify \(V\) like any table?<br /></li>
<li>Doesn't make sense: \(V\) is not stored<br /></li>
<li>Has to make sense: views are some users' entire "view" of the<br />
database<br /></li>
<li>Solution: Modifications to \(V\) rewritten to modify base tables<br /></li>
</ul>

<p>
Usually there are successful translations for view modifications.  The<br />
problem is there are too many and which one the user intends.<br />
</p>

<p>
Suppose we have the following schema.<br />
</p>
\begin{align*}
  & R(A, B) \\
  & V = \Pi_A(R)
\end{align*}

<p>
The table \(R\) has \((1, 2)\) and thus \(V = (1)\).  Say the user wants to<br />
insert \(3\) into \(V\).  Then the attribute \(B\) is undecided for the<br />
newly inserted tuple.<br />
</p>

<p>
A more radical example follows.<br />
</p>
\begin{align*}
  & R(N) = \{ (1), (3), (5) \} \\
  & V = \operatorname{avg}(N) = \{ (3) \}
\end{align*}

<p>
And the user wants to update the average to \(7\), then there are so<br />
many ways to update \(R\) to achieve this.<br />
</p>

<p>
Existent systems do things quite differently.  There are several<br />
approaches.<br />
</p>
<ol class="org-ol">
<li>Rewriting process specified explicitly by view creator<br />
<ul class="org-ul">
<li>+ Can handle all modifications<br /></li>
<li> No guarantee of correctness (or meaningfulness)<br /></li>
</ul></li>
<li>Restrict views + modifications so that translation to base table<br />
modifications is meaningful and unambiguous<br />
<ul class="org-ul">
<li>+ No user intervention<br /></li>
<li> Restrictions are significant<br /></li>
</ul></li>
</ol>

<p>
The first approach is enabled by <code>instead of</code> triggers or rules in<br />
Postgres' parlance.  The second approach is actually adopted by SQL<br />
standard.<br />
</p>
</div>
</div>

<div id="outline-container-org20e7240" class="outline-4">
<h4 id="views-modifications-using-triggers"><a id="org20e7240"></a><span class="section-number-4">8.1.3</span> <span class="done DONE">DONE</span> View Modifications Using Triggers</h4>
<div class="outline-text-4" id="text-views-modifications-using-triggers">
<p>
Unlike queries, view modifications cannot be automated in general.<br />
</p>

<p>
The following query will result in an error in SQLite, since it<br />
doesn't allow update to views.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> CSaccept <span class="org-keyword">where</span> sID = 123;
</pre>
</div>

<p>
We can create <code>instead of</code> triggers to achieve it.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSacceptDelete</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> CSaccept
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
  <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID
        <span class="org-keyword">and</span> cName = <span class="org-keyword">Old</span>.cName
        <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
Now it works.<br />
</p>

<p>
Of course, I also need an <code>instead of</code> trigger for the following query<br />
to work.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> CSaccept <span class="org-keyword">set</span> cName = <span class="org-string">'CMU'</span> <span class="org-keyword">where</span> sID = 345;
</pre>
</div>

<p>
An example of erroneous <code>instead of</code> trigger<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSacceptUpdate</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> CSaccept
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Apply
  <span class="org-keyword">set</span> cName = <span class="org-keyword">New</span>.cName
  <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID
        <span class="org-keyword">and</span> cName = <span class="org-keyword">Old</span>.cName
        <span class="org-comment">-- correct condition should be</span>
        <span class="org-comment">--     and major = 'CS' and decision = 'Y';</span>
        <span class="org-keyword">and</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSEE</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> major = <span class="org-string">'EE'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (111, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
</pre>
</div>

<p>
Another example of erroneous <code>instead of</code> trigger<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSEEinsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> CSEE
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-keyword">New</span>.cName, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
What if we do the following?<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (222, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>);
</pre>
</div>

<p>
Better trigger follows.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">trigger</span> <span class="org-function-name">CSEEinsert</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span>  <span class="org-function-name">CSEEinsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> CSEE
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> <span class="org-keyword">New</span>.major = <span class="org-string">'EE'</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-keyword">New</span>.cName, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
This time, the following query won't insert data into Apply table.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>);
</pre>
</div>

<p>
The following will successfully insert data into the underlying Apply<br />
table.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>);
</pre>
</div>

<p>
When a view involves aggregation, it is generally a good idea to<br />
disallow user to modify views.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">HSgpa</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sizeHS, <span class="org-builtin">avg</span>(gpa) <span class="org-keyword">as</span> avgGPA
<span class="org-keyword">from</span> Student
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sizeHS;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Majors</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> major <span class="org-keyword">from</span> Apply;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">NonUnique</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student S1
<span class="org-keyword">where</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student S2
              <span class="org-keyword">where</span> S1.sID &lt;&gt; S2.sID
                    <span class="org-keyword">and</span> S2.GPA = S1.GPA <span class="org-keyword">and</span> S2.sizeHS = S1.sizeHS);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Berk</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkInsert</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Berk
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student)
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'Berkeley'</span>, <span class="org-keyword">New</span>.major, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Berk
<span class="org-keyword">select</span> sID, <span class="org-string">'psychology'</span> <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>);
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkDelete</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> BerkDelete
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
  <span class="org-keyword">where</span> sID = <span class="org-keyword">old</span>.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> major = <span class="org-keyword">Old</span>.major;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Berk <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">BerkUpdate</span>
instead <span class="org-keyword">of</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> major <span class="org-keyword">on</span> Berk
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Apply
  <span class="org-keyword">set</span> major = <span class="org-keyword">New</span>.major
  <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sId <span class="org-keyword">and</span> cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span> major = <span class="org-keyword">Old</span>.major;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Berk <span class="org-keyword">set</span> major = <span class="org-string">'physics'</span> <span class="org-keyword">where</span> major = <span class="org-string">'psychology'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
);
</pre>
</div>

<p>
Now we cannot insert into the CSEE view.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">unique</span>(sID, cName, major)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Berk <span class="org-keyword">values</span> (123, <span class="org-string">'EE'</span>);          <span class="org-comment">-- failed.</span>
<span class="org-keyword">update</span> Berk <span class="org-keyword">set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org860a398" class="outline-4">
<h4 id="automatic-view-modifications"><a id="org860a398"></a><span class="section-number-4">8.1.4</span> <span class="done DONE">DONE</span> Automatic View Modifications</h4>
<div class="outline-text-4" id="text-automatic-view-modifications">
<p>
Restrictions in SQL Standard for "updatable views":<br />
</p>
<ol class="org-ol">
<li><code>select</code> (no <code>distinct</code>) on single table <code>T</code><br /></li>
<li>Attributes not in view can be <code>null</code> or have default value<br /></li>
<li>Subqueries must not refer to <code>T</code><br /></li>
<li>No <code>group by</code> or aggregation<br /></li>
</ol>

<p>
MySQL is the only database (among MySQL, SQLite, and PostgreSQL) that<br />
supports automatic view modifications.  However, it is a little bit<br />
more generous than the SQL standard.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (111, <span class="org-string">'Berkeley'</span>, <span class="org-string">'CS'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSEE <span class="org-keyword">values</span> (222, <span class="org-string">'Berkeley'</span>, <span class="org-string">'psychology'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> CSaccept <span class="org-keyword">values</span> (333, <span class="org-string">'Berkeley'</span>);
</pre>
</div>

<p>
All of the above queries will succeed.  The second query will insert a<br />
row with <code>'psychology'</code> major into <code>Apply</code> table, which won't reflect<br />
in the view <code>CSEE</code>.  And the last query will insert a row with <code>null</code><br />
major and decision into <code>Apply</code> table.  Both of the results are not<br />
what we want.<br />
</p>

<p>
We can fix it like this.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSaccept2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">CSEE2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">or</span> major = <span class="org-string">'EE'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
The <code>delete</code> and <code>insert</code> operations on <code>HSgpa</code> view will fail under<br />
both MySQL and SQL standard, since it contains aggregation.<br />
</p>

<p>
Views with subqueries that does not refer to outer table can be<br />
modified.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Bio</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major <span class="org-keyword">like</span> <span class="org-string">'bio%'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Bio <span class="org-keyword">where</span> sName = <span class="org-string">'Bob'</span>;
</pre>
</div>

<p>
For the above query, both MySQL and SQL standard will delete Bob from<br />
only the <code>Student</code> table, but not from the <code>Apply</code> table.  Of course,<br />
if the database is set up with proper referential integrity<br />
constraints, Bob will be deleted from <code>Apply</code> table due to it.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Bio <span class="org-keyword">values</span> (555, <span class="org-string">'Karen'</span>, 3.9, 1000);
</pre>
</div>

<p>
Karen will be inserted into <code>Student</code> table but won't appear in the<br />
<code>Bio</code> view.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Bio2</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major <span class="org-keyword">like</span> <span class="org-string">'bio%'</span>)
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
Now the following query will fail.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Bio2 <span class="org-keyword">values</span> (666, <span class="org-string">'Lori'</span>, 3.9, 1000);
</pre>
</div>

<p>
The <code>with check option</code> comes with an efficiency cost.<br />
</p>

<p>
MySQL does allow some modification on join view, whereas SQL standard<br />
doesn't.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Stan</span>(sID, aID, sName, major) <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, Apply.sID, sName, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Stan <span class="org-keyword">set</span> sName = <span class="org-string">'CS major'</span> <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>;
</pre>
</div>

<p>
The above query succeeds but the following will cause row being<br />
updated to disappear from the view <code>Stan</code>.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Stan <span class="org-keyword">set</span> aID = 666 <span class="org-keyword">where</span> aID = 123;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">Stan2</span>(sID, aID, sName, major) <span class="org-keyword">as</span>
<span class="org-keyword">select</span> Student.sID, Apply.sID, sName, major
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> cName = <span class="org-string">'Stanford'</span>
<span class="org-keyword">with</span> <span class="org-keyword">check</span> <span class="org-keyword">option</span>;
</pre>
</div>

<p>
Now the same query will fail for view <code>Stan2</code>.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan(sID, sName) <span class="org-keyword">values</span> (777, <span class="org-string">'Lance'</span>);
</pre>
</div>

<p>
The above query will insert Lance only into <code>Student</code> table with<br />
<code>null</code> GPA and high school size.  This is not what we want.  Also, the<br />
same query will fail on view <code>Stan2</code>.  However, by inserting a<br />
correspondent row into <code>Apply</code>, we can make it succeed, as shown<br />
below.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (888, <span class="org-string">'Stanford'</span>, <span class="org-string">'history'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan2(sID, sName) <span class="org-keyword">values</span> (888, <span class="org-string">'Mary'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (999, <span class="org-string">'MIT'</span>, <span class="org-string">'history'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Stan2(sID, sName) <span class="org-keyword">values</span> (999, <span class="org-string">'Nancy'</span>);
</pre>
</div>

<p>
The second <code>insert</code> query will fail since Nancy doesn't apply to<br />
Stanford.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Stan <span class="org-keyword">where</span> sID = 123;
</pre>
</div>

<p>
We cannot delete from join view under MySQL.<br />
</p>

<p>
Under SQL standard, a view is either updatable or not, meaning that if<br />
a view is updatable, then we can apply <code>insert</code>, <code>delete</code>, <code>update</code> on<br />
it.  However, a view can be partially updatable under MySQL since it<br />
is a little bit more generous.<br />
</p>
</div>
</div>

<div id="outline-container-org7f9551d" class="outline-4">
<h4 id="materialized-views"><a id="org7f9551d"></a><span class="section-number-4">8.1.5</span> <span class="done DONE">DONE</span> Materialized Views</h4>
<div class="outline-text-4" id="text-materialized-views">
<p>
The views discussed in the previous section are sometimes called<br />
virtual views.<br />
</p>

<p>
Materialized views have an additional advantage:<br />
</p>
<ul class="org-ul">
<li>improved query performance.<br /></li>
</ul>

<p>
Materialized views<br />
</p>
<ul class="org-ul">
<li>View \(V = \mathrm{ViewQuery}(R_1, R_2, \dotsc, R_n)\)<br /></li>
<li>Create table \(V\) with schema of query result<br /></li>
<li>Execute \(\mathrm{ViewQuery}\) and put results in \(V\)<br /></li>
<li>Queries refer to \(V\) as if it's a table<br /></li>
</ul>

<p>
But&#x2026;<br />
</p>
<ul class="org-ul">
<li>\(V\) could be very large<br /></li>
<li>Modifications to \(R_1, R_2, \dotsc, R_n \Rightarrow\)<br />
<ul class="org-ul">
<li>recompute or modify \(V\)<br /></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> materialized <span class="org-keyword">view</span> <span class="org-function-name">CA</span>-CS <span class="org-keyword">as</span>
<span class="org-keyword">select</span> C.cName, S.sName
<span class="org-keyword">from</span> College C, Student S, Apply A
<span class="org-keyword">where</span> C.cName = A.cName <span class="org-keyword">and</span> S.sID = A.sID
      <span class="org-keyword">and</span> C.<span class="org-keyword">state</span> = <span class="org-string">'CA'</span> <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>

<ul class="org-ul">
<li>+ Can use <code>CA-CS</code> as if it's a table (it is!)<br /></li>
<li> Modifications to base data invalidate view (cf. general<br />
assertions)<br /></li>
</ul>

<p>
Modifications on modifications views?<br />
</p>
<ul class="org-ul">
<li>Good news: just update the stored table<br /></li>
<li>Bad news: base tables must stay in sync<br />
<ul class="org-ul">
<li>Same issues as with virtual views<br /></li>
</ul></li>
</ul>

<p>
Picking which materialized views to create<br />
</p>
<ul class="org-ul">
<li>(Efficiency) benefits of a materialized view depend on:<br />
<ul class="org-ul">
<li>Size of data<br /></li>
<li>Complexity of view<br /></li>
<li>Number of queries using view<br /></li>
<li>Number of modifications affecting view<br />
<ul class="org-ul">
<li>Also "incremental maintenance" versus full recomputation<br /></li>
</ul></li>
</ul></li>
</ul>

<p>
Query-Update trade off (cf. indexes)<br />
</p>

<p>
Automatic query rewriting to use materialized views<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> materialized <span class="org-keyword">view</span> <span class="org-function-name">CA</span>-Apply <span class="org-keyword">as</span>
<span class="org-keyword">select</span> sID, cName, major
<span class="org-keyword">from</span> Apply A
<span class="org-keyword">where</span> cName <span class="org-keyword">in</span> (<span class="org-keyword">select</span> cName <span class="org-keyword">from</span> College <span class="org-keyword">where</span> <span class="org-keyword">state</span> = <span class="org-string">'CA'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> S.sID, S.GPA
<span class="org-keyword">from</span> College C, Student S, Apply A
<span class="org-keyword">where</span> C.cName = A.cName <span class="org-keyword">and</span> S.sID =A.sID
      <span class="org-keyword">and</span> S.GPA &gt; 3.5 <span class="org-keyword">and</span> C.<span class="org-keyword">state</span> = <span class="org-string">'CA'</span> <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>

<p>
The above query will be rewritten as something like the following.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> S.sID, S.GPA
<span class="org-keyword">from</span> Student S, CA-Apply A
<span class="org-keyword">where</span> S.sID = A.sID <span class="org-keyword">and</span> S.GPA &gt; 3.5 <span class="org-keyword">and</span> A.major = <span class="org-string">'CS'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9cb9383" class="outline-4">
<h4 id="authorization"><a id="org9cb9383"></a><span class="section-number-4">8.1.6</span> <span class="done DONE">DONE</span> Authorization</h4>
<div class="outline-text-4" id="text-authorization">
<p>
Database Authorization<br />
</p>
<ul class="org-ul">
<li>Make sure users see only the data they're supposed to see<br /></li>
<li>Guard the database against modifications by malicious users<br /></li>
</ul>

<p>
Users have <i>privileges</i> and can only operate on data for which they are<br />
<i>authorized</i>.<br />
</p>
<ul class="org-ul">
<li><code>Select on R</code> or <code>Select(A1, ..., An) on R</code><br /></li>
<li><code>Insert on R</code> or <code>Insert(A1, ..., An) on R</code><br /></li>
<li><code>Update on R</code> or <code>Update(A1, ..., An) on R</code><br /></li>
<li><code>Delete on R</code><br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> <span class="org-type">dec</span> = <span class="org-string">'Y'</span>
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> GPA &gt; 3.9)
</pre>
</div>

<p>
For the above query, we need the following privileges.<br />
</p>
<ul class="org-ul">
<li>Apply: <code>update(dec)</code>, <code>select(sID)</code><br /></li>
<li>Student: <code>select(sID, GPA)</code><br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply)
</pre>
</div>

<ul class="org-ul">
<li>Student: <code>delete</code><br /></li>
<li>Apply: <code>select(sID)</code><br /></li>
</ul>

<p>
<i>Select student info for Stanford applicants only</i><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">SS</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>)
</pre>
</div>

<ul class="org-ul">
<li>SS: <code>select</code><br /></li>
</ul>

<p>
<i>Delete Berkeley applications only</i><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">BA</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>
</pre>
</div>

<ul class="org-ul">
<li>BA: <code>delete</code><br /></li>
</ul>

<p>
Note: Updatable views is required to provide modification privileges<br />
through views<br />
</p>

<p>
In fact, authorization is one of the most important uses of views in database<br />
systems.<br />
</p>

<p>
Obtaining Privileges<br />
</p>
<ul class="org-ul">
<li>Relation creator is <i>owner</i><br /></li>
<li>Owner has all privileges and may <i>grant</i> privileges<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">grant</span> privs <span class="org-keyword">on</span> R <span class="org-keyword">to</span> users
  [<span class="org-keyword">with</span> <span class="org-keyword">grant</span> <span class="org-keyword">option</span>]
</pre>
</div>

<p>
Revoking Privileges<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">revoke</span> privs <span class="org-keyword">on</span> R <span class="org-keyword">from</span> users
  [<span class="org-keyword">cascade</span> | <span class="org-keyword">restrict</span>]
</pre>
</div>

<p>
Cascade: Also revoke privileges granted from privileges being revoked<br />
(transitively), unless also granted from antoher source.<br />
</p>

<p>
Restrict: Disallow if <i>Cascade</i> would revoke any other<br />
privileges. (This is the default.)<br />
</p>
</div>
</div>
</div>

<div id="outline-container-org44d9153" class="outline-3">
<h3 id="views-and-authorization-mini-course-exercises"><a id="org44d9153"></a><span class="section-number-3">8.2</span> <span class="todo TODO">TODO</span> Exercises</h3>
<div class="outline-text-3" id="text-views-and-authorization-mini-course-exercises">
</div>
<div id="outline-container-orge812366" class="outline-4">
<h4 id="views-quiz"><a id="orge812366"></a><span class="section-number-4">8.2.1</span> <span class="todo TODO">TODO</span> Views Quiz</h4>
<div class="outline-text-4" id="text-views-quiz">
</div>
</div>
<div id="outline-container-orgff2cc44" class="outline-4">
<h4 id="authorization-quiz"><a id="orgff2cc44"></a><span class="section-number-4">8.2.2</span> <span class="todo TODO">TODO</span> Authorization Quiz</h4>
<div class="outline-text-4" id="text-authorization-quiz">
</div>
</div>
<div id="outline-container-orga0d327d" class="outline-4">
<h4 id="sql-movie-rating-view-modification"><a id="orga0d327d"></a><span class="section-number-4">8.2.3</span> <span class="todo TODO">TODO</span> SQL Movie-Rating View Modification</h4>
<div class="outline-text-4" id="text-sql-movie-rating-view-modification">
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Lei Zhao</p>
<p class="date">Created: 2017-12-29 Fri 23:24</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
